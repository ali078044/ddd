<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام الموارد البشرية V42 - الإصدار النهائي</title>
    
    <!-- مكتبات CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <!-- خطوط وستايلات -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;500;600;700;800&display=swap');
        
        :root {
            --primary: #1e293b;
            --secondary: #2563eb;
            --bg: #f8fafc;
            --approval: #f59e0b;
            --approved: #10b981;
            --rejected: #ef4444;
            --fine: #dc2626;
            --bonus: #16a34a;
            --ratio: #7c3aed;
            --smile: #d97706;
        }
        
        * {
            font-family: 'Cairo', sans-serif;
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            background-color: var(--bg);
            color: var(--primary);
            font-size: 14px;
            min-height: 100vh;
        }
        
        /* كلاسات المساعدة */
        .hidden {
            display: none !important;
        }
        
        .main-container {
            max-width: 100%;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.05);
            min-height: 98vh;
            display: flex;
            flex-direction: column;
            border: 1px solid #e2e8f0;
            overflow: hidden;
        }
        
        /* الجداول */
        .table-wrapper {
            width: 100%;
            overflow-x: auto;
            background: white;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
            min-height: 400px;
            position: relative;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1200px;
        }
        
        .data-table th {
            background: #1e293b;
            color: white;
            padding: 14px 10px;
            font-size: 0.9rem;
            position: sticky;
            top: 0;
            z-index: 10;
            white-space: nowrap;
            text-align: center;
            border-bottom: 2px solid #334155;
        }
        
        .data-table td {
            padding: 10px;
            border-bottom: 1px solid #f1f5f9;
            text-align: center;
            font-size: 0.9rem;
            vertical-align: middle;
        }
        
        .data-table tr:hover td {
            background-color: #f8fafc;
        }
        
        /* ألوان الصفوف */
        .row-fine { background-color: #fef2f2 !important; }
        .row-bonus { background-color: #f0fdf4 !important; }
        .row-ratio { background-color: #faf5ff !important; }
        .row-reduction { background-color: #eff6ff !important; }
        .row-smile { background-color: #fef3c7 !important; }
        .row-approval { background-color: #fffbeb !important; }
        .row-pending { background-color: #fef3c7 !important; }
        .row-approved { background-color: #f0fdf4 !important; }
        .row-rejected { background-color: #fef2f2 !important; }
        
        /* حقول الإدخال */
        .form-input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            outline: none;
            transition: all 0.3s ease;
            font-size: 14px;
            background: white;
        }
        
        .form-input:focus {
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }
        
        .form-input.error {
            border-color: #ef4444;
            background-color: #fef2f2;
        }
        
        .form-input:disabled {
            background-color: #f1f5f9;
            cursor: not-allowed;
            opacity: 0.7;
        }
        
        /* الأزرار */
        .btn {
            padding: 10px 24px;
            border-radius: 8px;
            font-weight: 700;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s ease;
            white-space: nowrap;
            border: none;
            outline: none;
            font-size: 14px;
            justify-content: center;
        }
        
        .btn-primary {
            background: #2563eb;
            color: white;
        }
        
        .btn-primary:hover {
            background: #1d4ed8;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.2);
        }
        
        .btn-secondary {
            background: #f1f5f9;
            color: #475569;
            border: 1px solid #cbd5e1;
        }
        
        .btn-secondary:hover {
            background: #e2e8f0;
        }
        
        .btn-success {
            background: #10b981;
            color: white;
        }
        
        .btn-success:hover {
            background: #059669;
        }
        
        .btn-warning {
            background: #f59e0b;
            color: white;
        }
        
        .btn-warning:hover {
            background: #d97706;
        }
        
        .btn-danger {
            background: #ef4444;
            color: white;
        }
        
        .btn-danger:hover {
            background: #dc2626;
        }
        
        .btn-approval {
            background: var(--approval);
            color: white;
        }
        
        .btn-approval:hover {
            background: #d97706;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
        }
        
        .btn-small {
            padding: 6px 12px;
            font-size: 0.85rem;
        }
        
        /* علامات التبويب */
        .tab-btn {
            padding: 10px 20px;
            font-weight: 600;
            color: #64748b;
            border-radius: 8px;
            transition: all 0.3s ease;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 14px;
        }
        
        .tab-btn:hover {
            background: #f1f5f9;
            color: #475569;
        }
        
        .tab-btn.active {
            color: #2563eb;
            background: #eff6ff;
            font-weight: 700;
        }
        
        /* البادجات */
        .status-badge {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
            display: inline-block;
            text-align: center;
            min-width: 80px;
        }
        
        .st-pending {
            background: #fef3c7;
            color: #92400e;
            border: 1px solid #fcd34d;
        }
        
        .st-accepted {
            background: #dcfce7;
            color: #166534;
            border: 1px solid #86efac;
        }
        
        .st-rejected {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fca5a5;
        }
        
        .st-followup {
            background: #dbeafe;
            color: #1e40af;
            border: 1px solid #93c5fd;
        }
        
        .st-approved {
            background: #dcfce7;
            color: #166534;
            border: 1px solid #86efac;
        }
        
        /* بادجات الأنواع */
        .type-badge {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
            display: inline-block;
            border: 1px solid;
        }
        
        .ty-fine {
            background: #fee2e2;
            color: #dc2626;
            border-color: #fca5a5;
        }
        
        .ty-bonus {
            background: #dcfce7;
            color: #16a34a;
            border-color: #86efac;
        }
        
        .ty-smile {
            background: #fef3c7;
            color: #92400e;
            border-color: #fcd34d;
        }
        
        .ty-ratio {
            background: #e9d5ff;
            color: #7c3aed;
            border-color: #c4b5fd;
        }
        
        .ty-reduction {
            background: #dbeafe;
            color: #1d4ed8;
            border-color: #93c5fd;
        }
        
        /* المبالغ المقترحة والمعدلة */
        .amount-suggestion {
            background-color: #e8f5e9 !important;
            border: 2px solid #4caf50 !important;
            font-weight: bold;
            color: #2e7d32;
        }

        .amount-modified {
            background-color: #fff3e0 !important;
            border: 2px solid #ff9800 !important;
        }
		
		
		        /* تنسيق الخلايا القابلة للتعديل */
        .editable-cell {
            transition: all 0.2s ease;
            min-height: 40px;
            display: flex;
            align-items: center;
        }
        
        .editable-cell:hover {
            background-color: #f0f9ff;
            border-color: #93c5fd !important;
        }
        
        .cell-container {
            position: relative;
        }
        
        /* تأثيرات التحديث */
        .cell-updated {
            animation: pulse-green 1s ease-in-out;
        }
        
        @keyframes pulse-green {
            0%, 100% { background-color: transparent; }
            50% { background-color: #d1fae5; }
        }
        
        /* صف جديد */
        .new-row {
            animation: slide-down 0.3s ease-out;
        }
        
        @keyframes slide-down {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* اللودر */
        .loader {
            width: 24px;
            height: 24px;
            border: 3px solid #e2e8f0;
            border-top-color: #2563eb;
            border-radius: 50%;
            animation: spin 1s infinite linear;
            display: inline-block;
        }
        
        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
        
        /* زر التعويم */
        .float-btn {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: #10b981;
            color: white;
            padding: 12px 30px;
            border-radius: 50px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 10px 20px rgba(16, 185, 129, 0.3);
            z-index: 1000;
            display: flex;
            gap: 10px;
            align-items: center;
            transition: all 0.3s ease;
        }
        
        .float-btn:hover {
            background: #059669;
            transform: translateX(-50%) translateY(-2px);
            box-shadow: 0 12px 24px rgba(16, 185, 129, 0.4);
        }
        
        /* التنبيهات */
        .toast {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: #1e293b;
            color: white;
            padding: 15px 30px;
            border-radius: 50px;
            z-index: 9999;
            display: flex;
            gap: 10px;
            align-items: center;
            animation: slideUp 0.3s ease-out;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            border: 2px solid;
        }
        
        @keyframes slideUp {
            from {
                transform: translate(-50%, 100%);
                opacity: 0;
            }
            to {
                transform: translate(-50%, 0);
                opacity: 1;
            }
        }
        
        /* شريط الإحصائيات */
        .stats-bar {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 10px;
        }
        
        .stat-item {
            background: #fff;
            border: 1px solid #e2e8f0;
            padding: 8px 15px;
            border-radius: 8px;
            font-weight: bold;
            font-size: 0.85rem;
            flex: 1;
            text-align: center;
            min-width: 120px;
        }
        
        /* عناصر التحكم بالصفحات */
        .page-ctrl {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin-top: 15px;
            background: white;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            flex-wrap: wrap;
        }
        
        /* قسم تقييمات البشاشة */
        .smile-eval-section {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            background: #f8fafc;
        }
        
        .smile-category {
            margin-bottom: 15px;
            padding: 10px;
            background: white;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }
        
        .smile-category h4 {
            font-weight: bold;
            color: #1e293b;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 2px solid #f1f5f9;
        }
        
        /* بطاقات الموافقات */
        .approval-card {
            border-right: 4px solid var(--approval);
            background: #fffbeb;
        }
        
        /* المودال */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            z-index: 9990;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            backdrop-filter: blur(4px);
        }
        
        .modal-content {
            background: white;
            border-radius: 16px;
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
            border: 1px solid #e2e8f0;
        }
        
        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #e2e8f0;
            background: #f8fafc;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h3 {
            font-size: 1.25rem;
            font-weight: 700;
            color: #1e293b;
        }
        
        .modal-body {
            padding: 20px;
            overflow-y: auto;
            flex: 1;
        }
        
        .modal-footer {
            padding: 20px;
            border-top: 1px solid #e2e8f0;
            background: #f8fafc;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        /* شريط التمرير المخصص */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 4px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
        
        /* الخلايا النشطة */
        .active-cell {
            background-color: #e0f2fe !important;
            border: 2px solid #0ea5e9 !important;
        }
        
        /* الأقسام */
        .section-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .section-card {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }
        
        /* تنسيق الشبكة */
        .grid {
            display: grid;
            gap: 20px;
        }
        
        .grid-cols-1 {
            grid-template-columns: repeat(1, 1fr);
        }
        
        .grid-cols-2 {
            grid-template-columns: repeat(2, 1fr);
        }
        
        .grid-cols-3 {
            grid-template-columns: repeat(3, 1fr);
        }
        
        .grid-cols-4 {
            grid-template-columns: repeat(4, 1fr);
        }
        
        @media (max-width: 768px) {
            .grid-cols-2,
            .grid-cols-3,
            .grid-cols-4 {
                grid-template-columns: repeat(1, 1fr);
            }
            
            .modal-content {
                max-width: 95%;
            }
        }
        
        /* رسائل الخطأ */
        .error-message {
            color: #dc2626;
            font-size: 0.85rem;
            margin-top: 5px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        /* البطاقات */
        .card {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
            border-color: #cbd5e1;
        }
        
        .card-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 8px;
        }
        
        .card-description {
            font-size: 0.9rem;
            color: #64748b;
            line-height: 1.5;
        }
        
        /* العناوين */
        .page-title {
            font-size: 1.5rem;
            font-weight: 800;
            color: #1e293b;
            margin-bottom: 5px;
        }
        
        .page-subtitle {
            font-size: 1rem;
            color: #64748b;
            margin-bottom: 20px;
        }
        
        /* التنبيهات */
        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }
        
        .alert-info {
            background: #dbeafe;
            color: #1e40af;
            border: 1px solid #93c5fd;
        }
        
        .alert-success {
            background: #dcfce7;
            color: #166534;
            border: 1px solid #86efac;
        }
        
        .alert-warning {
            background: #fef3c7;
            color: #92400e;
            border: 1px solid #fcd34d;
        }
        
        .alert-danger {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fca5a5;
        }
        
        /* إدارة الألوان */
        .color-preview {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            display: inline-block;
            margin: 0 2px;
            border: 1px solid #ccc;
            vertical-align: middle;
        }
        
        /* الشيك بوكس */
        .checkbox-all {
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: #2563eb;
        }
        
        /* أيقونات */
        .icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        
        .icon-small {
            width: 20px;
            height: 20px;
        }
        
        .icon-medium {
            width: 24px;
            height: 24px;
        }
        
        .icon-large {
            width: 32px;
            height: 32px;
        }
        
        /* المسافات */
        .mb-2 { margin-bottom: 8px; }
        .mb-3 { margin-bottom: 12px; }
        .mb-4 { margin-bottom: 16px; }
        .mb-5 { margin-bottom: 20px; }
        .mb-6 { margin-bottom: 24px; }
        
        .mt-2 { margin-top: 8px; }
        .mt-3 { margin-top: 12px; }
        .mt-4 { margin-top: 16px; }
        .mt-5 { margin-top: 20px; }
        .mt-6 { margin-top: 24px; }
        
        .p-2 { padding: 8px; }
        .p-3 { padding: 12px; }
        .p-4 { padding: 16px; }
        .p-5 { padding: 20px; }
        .p-6 { padding: 24px; }
        
        /* المحاذاة */
        .text-center { text-align: center; }
        .text-right { text-align: right; }
        .text-left { text-align: left; }
        
        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .items-center { align-items: center; }
        .justify-center { justify-content: center; }
        .justify-between { justify-content: space-between; }
        .gap-2 { gap: 8px; }
        .gap-3 { gap: 12px; }
        .gap-4 { gap: 16px; }
        .gap-5 { gap: 20px; }
        
        /* العرض */
        .w-full { width: 100%; }
        .w-auto { width: auto; }
        
        /* الأنيميشن */
        .animate-pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: .5;
            }
        }
        
        /* تنسيق النصوص */
        .text-xs { font-size: 0.75rem; }
        .text-sm { font-size: 0.875rem; }
        .text-base { font-size: 1rem; }
        .text-lg { font-size: 1.125rem; }
        .text-xl { font-size: 1.25rem; }
        .text-2xl { font-size: 1.5rem; }
        
        .font-normal { font-weight: 400; }
        .font-medium { font-weight: 500; }
        .font-semibold { font-weight: 600; }
        .font-bold { font-weight: 700; }
        .font-extrabold { font-weight: 800; }
        
        /* الألوان */
        .text-primary { color: #1e293b; }
        .text-secondary { color: #64748b; }
        .text-success { color: #16a34a; }
        .text-warning { color: #d97706; }
        .text-danger { color: #dc2626; }
        .text-info { color: #2563eb; }
        
        .bg-primary { background-color: #1e293b; }
        .bg-secondary { background-color: #64748b; }
        .bg-success { background-color: #16a34a; }
        .bg-warning { background-color: #d97706; }
        .bg-danger { background-color: #dc2626; }
        .bg-info { background-color: #2563eb; }
        
        /* الحدود */
        .rounded { border-radius: 6px; }
        .rounded-lg { border-radius: 12px; }
        .rounded-xl { border-radius: 16px; }
        .rounded-full { border-radius: 9999px; }
        
        .border { border: 1px solid #e2e8f0; }
        .border-b { border-bottom: 1px solid #e2e8f0; }
        .border-t { border-top: 1px solid #e2e8f0; }
        .border-l { border-left: 1px solid #e2e8f0; }
        .border-r { border-right: 1px solid #e2e8f0; }
        
        /* الظلال */
        .shadow-sm { box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); }
        .shadow { box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px -1px rgba(0, 0, 0, 0.1); }
        .shadow-md { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1); }
        .shadow-lg { box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1); }
        .shadow-xl { box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1); }
        
        /* أنيميشن التحميل */
        .loading-overlay {
            position: absolute;
            inset: 0;
            background: rgba(255, 255, 255, 0.9);
            z-index: 20;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
        }
        
        .loading-text {
            margin-top: 15px;
            font-weight: 600;
            color: #475569;
            animation: pulse 2s infinite;
        }
        
        /* رسالة فارغة */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #64748b;
        }
        
        .empty-state-icon {
            font-size: 48px;
            color: #cbd5e1;
            margin-bottom: 15px;
        }
        
        .empty-state-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #475569;
            margin-bottom: 8px;
        }
        
        .empty-state-description {
            font-size: 0.95rem;
            color: #94a3b8;
            max-width: 400px;
            margin: 0 auto;
        }
        
        /* التبويبات */
        .tabs {
            display: flex;
            gap: 5px;
            background: #f1f5f9;
            padding: 5px;
            border-radius: 10px;
            margin-bottom: 20px;
            overflow-x: auto;
        }
        
        .tab {
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            color: #64748b;
            white-space: nowrap;
            transition: all 0.3s ease;
            border: none;
            background: none;
        }
        
        .tab:hover {
            color: #475569;
            background: #e2e8f0;
        }
        
        .tab.active {
            background: white;
            color: #2563eb;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
		
		.sortable-header {
            cursor: pointer;
            position: relative;
            padding-bottom: 30px !important;
            user-select: none; /* يمنع تظليل النص عند النقر المتكرر */
            -webkit-user-select: none; /* للمتصفحات الأخرى */
        }

        .sort-icon {
            margin-right: 5px;
            opacity: 0.5;
            font-size: 0.8em;
        }

        .sortable-header:hover .sort-icon {
            opacity: 1;
        }

        .column-filter {
            position: absolute;
            bottom: 5px;
            left: 5px;
            right: 5px;
            width: calc(100% - 10px);
            padding: 2px 5px;
            border-radius: 4px;
            border: 1px solid #cbd5e1;
            font-size: 0.7rem;
            color: #334155;
        }

        .column-filter:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
        }
		
    </style>
</head>
<body class="p-2 md:p-4 bg-slate-100">
    <div class="main-container">
        <!-- الرأس -->
        <header class="bg-slate-900 text-white p-4 md:p-5 flex justify-between items-center shadow-md z-20">
            <div class="flex items-center gap-4">
                <div class="w-10 h-10 md:w-12 md:h-12 bg-blue-600 rounded-xl flex items-center justify-center text-xl md:text-2xl shadow-inner">
                    <i class="fas fa-layer-group"></i>
                </div>
                <div>
                    <h1 class="text-xl md:text-2xl font-bold">نظام الموارد البشرية <span class="text-xs bg-blue-500 px-2 py-1 rounded-full ml-1 align-middle">V42+</span></h1>
                    <p id="userStatus" class="text-xs text-slate-400 mt-1">يرجى تسجيل الدخول...</p>
                </div>
            </div>
            <button onclick="logout()" id="btnLogout" class="hidden bg-slate-800 hover:bg-red-600 border border-slate-700 px-4 md:px-6 py-2 rounded-lg font-bold transition flex items-center gap-2">
                <i class="fas fa-sign-out-alt"></i>
                <span class="hidden md:inline">خروج</span>
            </button>
        </header>

        <!-- المحتوى الرئيسي -->
        <main class="flex-1 bg-slate-50 relative overflow-hidden flex flex-col">
            <!-- شاشة الدخول -->
            <section id="loginView" class="absolute inset-0 z-50 bg-slate-50/95 backdrop-blur flex items-center justify-center p-4">
                <div class="bg-white p-8 md:p-10 rounded-2xl shadow-xl w-full max-w-sm text-center border border-slate-200">
                    <h2 class="text-2xl font-bold mb-6 text-slate-800">تسجيل الدخول</h2>
                    <input type="text" id="authCode" class="form-input text-center mb-4 font-bold text-lg" placeholder="الرمز الوظيفي" autocomplete="off">
                    <input type="number" id="authFP" class="form-input text-center mb-6 font-bold text-lg" placeholder="رقم البصمة" autocomplete="off">
                    <button onclick="attemptLogin()" id="btnLogin" class="w-full btn btn-primary justify-center py-3 text-lg shadow-lg hover:shadow-xl">
                        دخول النظام
                    </button>
                    <p id="loginErr" class="text-red-500 text-sm mt-4 font-bold min-h-[20px]"></p>
                </div>
            </section>

            <!-- لوحة التحكم -->
            <section id="dashView" class="hidden p-6 md:p-8 overflow-y-auto h-full">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <!-- بطاقات الأقسام -->
                    <div onclick="navToBulk('fine')" id="btnFine" class="hidden card">
                        <div class="card-title flex items-center gap-2">
                            <i class="fas fa-money-bill-wave text-red-500"></i>
                            <span>الغرامات والتنبيهات</span>
                        </div>
                        <p class="card-description">إضافة غرامات وتنبيهات للموظفين</p>
                    </div>

                    <div onclick="navToBulk('bonus')" id="btnBonus" class="hidden card">
                        <div class="card-title flex items-center gap-2">
                            <i class="fas fa-gift text-green-500"></i>
                            <span>المكافآت والحوافز</span>
                        </div>
                        <p class="card-description">إضافة مكافآت تحتاج موافقة</p>
                    </div>

                    <div onclick="navToBulk('ratio')" id="btnRatio" class="hidden card">
                        <div class="card-title flex items-center gap-2">
                            <i class="fas fa-chart-line text-purple-500"></i>
                            <span>النسب والعمولات</span>
                        </div>
                        <p class="card-description">إضافة نسب تحتاج موافقة</p>
                    </div>

                    <div onclick="navToBulk('reduction')" id="btnRed" class="hidden card">
                        <div class="card-title flex items-center gap-2">
                            <i class="fas fa-hand-holding-usd text-blue-500"></i>
                            <span>تخفيض العقوبات</span>
                        </div>
                        <p class="card-description">تخفيضات تحتاج موافقة</p>
                    </div>

                    <div onclick="navToBulk('smile')" id="btnSmile" class="hidden card">
                        <div class="card-title flex items-center gap-2">
                            <i class="fas fa-smile text-yellow-500"></i>
                            <span>غرامات البشاشة</span>
                        </div>
                        <p class="card-description">تقييم السلوك والابتسامة</p>
                    </div>

                    <div onclick="navToApprovals()" id="btnApprovals" class="hidden card approval-card">
                        <div class="card-title flex items-center gap-2">
                            <i class="fas fa-clipboard-check text-orange-500"></i>
                            <span>الموافقات المنتظرة</span>
                        </div>
                        <p class="card-description">مراجعة واعتماد الطلبات</p>
                        <div id="approvalBadge" class="mt-2 text-xs bg-orange-100 text-orange-800 px-2 py-1 rounded-full inline-block hidden">
                            <span id="approvalCount">0</span> طلب
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <!-- الملف الشخصي -->
                    <div onclick="navToProfile()" class="card bg-blue-50 border-blue-100 hover:bg-blue-100">
                        <div class="card-title flex items-center gap-2">
                            <i class="fas fa-user text-blue-600"></i>
                            <span>ملفي الشخصي</span>
                        </div>
                        <p class="card-description text-blue-700">عرض سجلي واعتراضاتي</p>
                    </div>

                    <!-- سجل الإضافات -->
                    <div onclick="navToAdded()" class="card bg-orange-50 border-orange-100 hover:bg-orange-100">
                        <div class="card-title flex items-center gap-2">
                            <i class="fas fa-history text-orange-600"></i>
                            <span>سجل إضافاتي</span>
                        </div>
                        <p class="card-description text-orange-700">عرض ما أضفته للنظام</p>
                    </div>

                    <!-- بوابة HR -->
                    <div onclick="navToHR()" id="btnHR" class="hidden card bg-slate-800 text-white hover:bg-slate-700">
                        <div class="card-title flex items-center gap-2">
                            <i class="fas fa-users-cog text-white"></i>
                            <span>بوابة الموارد البشرية</span>
                        </div>
                        <p class="card-description text-slate-300">إدارة الاعتراضات والمتابعة</p>
                    </div>

                    <!-- الإعدادات -->
                    <div onclick="navToSettings()" id="btnAdmin" class="hidden card bg-slate-700 text-white hover:bg-slate-600">
                        <div class="card-title flex items-center gap-2">
                            <i class="fas fa-cogs text-white"></i>
                            <span>الإعدادات</span>
                        </div>
                        <p class="card-description text-slate-300">إدارة الموظفين والتفاصيل</p>
                    </div>

                    <!-- أوقات الدوام -->
                    <div onclick="navToAttendance()" class="card bg-emerald-50 border-emerald-100 hover:bg-emerald-100">
                        <div class="card-title flex items-center gap-2">
                            <i class="fas fa-clock text-emerald-600"></i>
                            <span>أوقات الدوام</span>
                        </div>
                        <p class="card-description text-emerald-700">عرض سجل دوام الموظفين</p>
                    </div>
                </div>
            </section>

            <!-- شاشة العمليات الجماعية -->
            <section id="bulkView" class="hidden flex flex-col h-full p-4 md:p-6">
                <!-- العنوان وشريط التحكم -->
                <div class="flex justify-between items-center mb-4 bg-white p-4 rounded-xl shadow-sm border border-slate-200">
                    <div class="flex items-center gap-4">
                        <button onclick="showDash()" class="btn btn-secondary w-10 h-10 p-0 rounded-full flex items-center justify-center">
                            <i class="fas fa-arrow-right"></i>
                        </button>
                        <div>
                            <h2 class="font-bold text-2xl text-slate-800" id="bulkTitle">...</h2>
                            <div id="approvalNote" class="text-sm text-orange-600 font-bold hidden mt-1">
                                <i class="fas fa-clock"></i> تحتاج موافقة
                            </div>
                        </div>
                    </div>
                    <button onclick="addRow()" class="btn btn-primary">
                        <i class="fas fa-plus"></i> إضافة صف
                    </button>
                </div>

                <!-- الحقول الإضافية للنسب -->
                <div id="ratioExtraFields" class="hidden mb-4 bg-white p-4 rounded-xl border border-slate-200">
                    <h3 class="font-bold text-lg mb-3 text-purple-700">إعدادات النسب</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium mb-1 text-slate-700">النوع الإضافي</label>
                            <select id="ratioType" class="form-input">
                                <option value="">اختر النوع</option>
                                <option value="نسبة مبيعات">نسبة مبيعات</option>
                                <option value="نسبة عمولات">نسبة عمولات</option>
                                <option value="نسبة أداء">نسبة أداء</option>
                                <option value="نسبة إنتاجية">نسبة إنتاجية</option>
                                <option value="نسبة خاصة">نسبة خاصة</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- جدول البيانات -->
                <div class="flex-1 table-wrapper">
                    <table class="data-table" id="bulkTable">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>البصمة</th>
                                <th>الاسم الكامل</th>
                                <th>النوع</th>
                                <th>المبلغ</th>
                                <th>السبب</th>
                                <th class="col-cls">عام</th>
                                <th class="col-cls">خاص</th>
                                <th>الجروب</th>
                                <th>الاستحقاق</th>
                                <th>إجراء</th>
                            </tr>
                        </thead>
                        <tbody id="bulkBody"></tbody>
                    </table>
                </div>

                <!-- زر الإرسال -->
                <div class="mt-4 bg-white p-4 rounded-xl border flex justify-between items-center gap-4 shadow-lg">
                    <input type="datetime-local" id="bulkTime" class="bg-transparent outline-none font-bold text-slate-700 text-sm p-2 border rounded">
                    <button onclick="submitBulk()" id="btnBulkSub" class="btn btn-primary px-8 py-3 text-lg shadow-lg hover:shadow-xl">
                        <i class="fas fa-paper-plane"></i> حفظ وإرسال البيانات
                    </button>
                </div>
            </section>

            <!-- شاشة الموافقات -->
            <section id="approvalsView" class="hidden flex flex-col h-full p-4">
                <!-- العنوان والإحصائيات -->
                <div class="flex flex-col gap-3 mb-3">
                    <div class="flex justify-between items-center bg-white p-4 rounded-xl border border-slate-200 shadow-sm">
                        <div class="flex items-center gap-4">
                            <button onclick="showDash()" class="btn btn-secondary">
                                <i class="fas fa-arrow-right"></i> رجوع
                            </button>
                            <div>
                                <h2 class="font-bold text-xl text-slate-800">الموافقات المنتظرة</h2>
                                <p class="text-sm text-slate-600">مرحباً <span id="approverName" class="font-bold text-blue-600">...</span></p>
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="selectAllApprovals()" id="btnSelectAll" class="btn btn-secondary">
                                <i class="fas fa-check-square"></i> تحديد الكل
                            </button>
                            <button onclick="bulkApprove()" id="btnBulkApprove" class="btn btn-success">
                                <i class="fas fa-check-double"></i> موافقة جماعية
                            </button>
                        </div>
                    </div>

                    <!-- شريط الإحصائيات -->
                    <div class="stats-bar">
                        <div class="stat-item border-orange-300 text-orange-700">
                            <i class="fas fa-clock"></i> المنتظرة: <span id="pendingCount">0</span>
                        </div>
                        <div class="stat-item border-green-300 text-green-700">
                            <i class="fas fa-check"></i> قابلة للموافقة: <span id="approvableCount">0</span>
                        </div>
                        <div class="stat-item border-blue-300 text-blue-700">
                            <i class="fas fa-users"></i> عدد الطلبات: <span id="totalRequests">0</span>
                        </div>
                    </div>
                </div>

                <!-- جدول الموافقات -->
                <div class="flex-1 table-wrapper bg-slate-50 relative flex flex-col">
                    <!-- لودر التحميل -->
                    <div id="loadingOverlayApprovals" class="hidden loading-overlay">
                        <span class="loader w-10 h-10 border-4 border-slate-200 border-t-blue-600"></span>
                        <p class="loading-text">جاري تحميل طلبات الموافقة...</p>
                    </div>

                    <!-- الجدول -->
                    <div class="flex-1 overflow-auto">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th width="50"><input type="checkbox" id="selectAllCheckbox" onclick="toggleSelectAll(this)"></th>
                                    <th>الموظف</th>
                                    <th>النوع</th>
                                    <th>المبلغ</th>
                                    <th>السبب</th>
                                    <th>النوع الإضافي</th>
                                    <th>المضيف</th>
                                    <th>التاريخ</th>
                                    <th>الإجراءات</th>
                                </tr>
                            </thead>
                            <tbody id="approvalsBody"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- شاشة الموارد البشرية -->
            <section id="hrView" class="hidden flex flex-col h-full p-4">
                <!-- التبويبات -->
                <div class="tabs mb-4">
                    <button onclick="showDash()" class="tab">
                        <i class="fas fa-home"></i>
                    </button>
					<button onclick="swTab('trk')" id="tTrk" class="tab">بحث شامل</button>
                    <button onclick="swTab('obj')" id="tObj" class="tab active">الاعتراضات</button>
                    <button onclick="swTab('mon')" id="tMon" class="tab">المتابعة</button>
                    <button onclick="swTab('sum')" id="tSum" class="tab">الخلاصة</button>
                    <button onclick="swTab('trk')" id="tTrk" class="tab">بحث شامل</button>
                </div>

                <!-- الفلاتر والإحصائيات -->
                <div class="flex flex-col gap-3 mb-3">
                    <!-- إحصائيات الاعتراضات -->
                    <div id="statsBox" class="hidden stats-bar"></div>

                    <!-- فلاتر الاعتراضات -->
                    <div id="objFilters" class="hidden bg-white p-4 rounded-xl border shadow-sm flex flex-wrap gap-4 items-center">
                        <input type="text" id="objSearchName" onkeyup="renderHRTable()" placeholder="بحث بالاسم..." class="form-input w-64">
                        <input type="text" id="objSearchFP" onkeyup="renderHRTable()" placeholder="بحث بالبصمة..." class="form-input w-48">
                        <select id="objFilterStatus" onchange="renderHRTable()" class="form-input w-48 font-bold text-sm bg-blue-50 border-blue-200 text-blue-900">
                            <option value="">-- كافة الحالات --</option>
                            <option value="قيد المراجعة">قيد المراجعة</option>
                            <option value="مقبول">مقبول</option>
                            <option value="مرفوض">مرفوض</option>
                            <option value="متابعة">متابعة</option>
                        </select>
                        <select id="objFilterType" onchange="renderHRTable()" class="form-input w-48">
                            <option value="">-- جميع الأنواع --</option>
                            <option value="غرامة">غرامة</option>
                            <option value="مكافأة">مكافأة</option>
                            <option value="نسبة">نسبة</option>
                            <option value="تخفيض">تخفيض</option>
                            <option value="غرامة بشاشة">غرامة بشاشة</option>
                        </select>
                    </div>

                    <!-- فلاتر المتابعة -->
					
                    <div id="monFilters" class="hidden bg-white p-4 rounded-xl border shadow-sm flex flex-wrap gap-4 items-center">
                        <div class="flex items-center gap-2">
                            <label class="text-sm font-medium text-slate-700">من:</label>
                            <input type="date" id="fD1" class="form-input py-2 text-sm" onchange="loadHR(false)">
                        </div>
                        <div class="flex items-center gap-2">
                            <label class="text-sm font-medium text-slate-700">إلى:</label>
                            <input type="date" id="fD2" class="form-input py-2 text-sm" onchange="loadHR(false)">
                        </div>
                        
                        <div class="relative">
                            <input type="text" class="w-48 text-xs border-b mb-1 px-1 focus:outline-none" 
                                   placeholder="بحث في التصنيف..." onkeyup="filterSelectOptions(this)">
                            <select id="fCls" class="form-input py-2 text-sm font-bold w-48" onchange="loadHR(false)">
                                <option value="">كافة التصنيفات</option>
                            </select>
                        </div>

                        <input type="text" id="monSearchName" onkeyup="renderHRTable()" placeholder="بحث بالاسم..." class="form-input w-48">
                        <input type="text" id="monSearchFP" onkeyup="renderHRTable()" placeholder="بحث بالبصمة..." class="form-input w-32">
                    </div>
                   

                    <!-- البحث الشامل -->
                    <div id="trackBox" class="hidden bg-white p-6 rounded-xl border shadow-sm flex justify-center gap-3">
                        <input type="number" id="trkFP" class="form-input w-64 text-center font-bold text-lg" placeholder="أدخل رقم البصمة">
                        <button onclick="doTrack()" class="btn btn-primary px-8 text-lg">بحث</button>
                    </div>
                </div>

                <!-- الجدول الرئيسي -->
                <div class="flex-1 table-wrapper bg-slate-50 relative flex flex-col">
                    <!-- لودر التحميل -->
                    <div id="loadingOverlay" class="hidden loading-overlay">
                        <span class="loader w-10 h-10 border-4 border-slate-200 border-t-blue-600"></span>
                        <p class="loading-text">جاري جلب البيانات...</p>
                    </div>

                    <!-- الجدول -->
                    <div class="flex-1 overflow-auto">
                        <table class="data-table" id="hrTable">
                            <thead id="hrHead"></thead>
                            <tbody id="hrBody"></tbody>
                        </table>
                    </div>

                    <!-- عناصر التحكم بالصفحات -->
                    <div id="paginationControls" class="hidden page-ctrl">
                        <button onclick="changePage(-1)" class="btn btn-secondary">
                            <i class="fas fa-chevron-right"></i> السابق
                        </button>
                        <span id="pageInfo" class="font-bold text-slate-700">صفحة 1</span>
                        <button onclick="changePage(1)" class="btn btn-secondary">
                            التالي <i class="fas fa-chevron-left"></i>
                        </button>
                        <span id="totalRecs" class="text-sm text-slate-500"></span>
                    </div>
                </div>
            </section>

            <!-- شاشة أوقات الدوام -->
            <section id="attendanceView" class="hidden flex flex-col h-full p-4">
                <!-- العنوان -->
                <div class="flex justify-between items-center mb-4 bg-white p-4 rounded-xl border border-slate-200 shadow-sm">
                    <div class="flex items-center gap-4">
                        <button onclick="showDash()" class="btn btn-secondary">
                            <i class="fas fa-arrow-right"></i> رجوع
                        </button>
                        <h2 class="font-bold text-2xl text-slate-800">أوقات الدوام</h2>
                    </div>
                    <button onclick="loadAttendance()" class="btn btn-primary">
                        <i class="fas fa-sync-alt"></i> تحديث
                    </button>
                </div>

                <!-- الفلاتر -->
                <div class="mb-4 bg-white p-4 rounded-xl border shadow-sm flex flex-wrap gap-4 items-center">
                    <div class="flex items-center gap-2">
                        <label class="text-sm font-medium text-slate-700">من:</label>
                        <input type="date" id="attDateFrom" class="form-input py-2 text-sm">
                    </div>
                    <div class="flex items-center gap-2">
                        <label class="text-sm font-medium text-slate-700">إلى:</label>
                        <input type="date" id="attDateTo" class="form-input py-2 text-sm">
                    </div>
                    <input type="text" id="attSearchName" onkeyup="filterAttendance()" placeholder="بحث بالاسم..." class="form-input w-48">
                    <input type="text" id="attSearchFP" onkeyup="filterAttendance()" placeholder="بحث بالبصمة..." class="form-input w-48">
                    <button onclick="loadAttendance()" class="btn btn-primary py-2 px-6">بحث</button>
                </div>

                <!-- جدول أوقات الدوام -->
                <div class="flex-1 table-wrapper bg-white">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>رقم البصمة</th>
                                <th>اسم الموظف</th>
                                <th>القسم</th>
                                <th>التاريخ</th>
                                <th>وقت الدخول</th>
                                <th>وقت الخروج</th>
                                <th>المدة</th>
                                <th>الحالة</th>
                            </tr>
                        </thead>
                        <tbody id="attendanceBody"></tbody>
                    </table>
                </div>
            </section>

            <!-- الملف الشخصي -->
            <section id="profView" class="hidden flex flex-col h-full p-6">
                <!-- العنوان -->
                <div class="flex justify-between items-center mb-4 bg-white p-4 rounded-xl border shadow-sm">
                    <button onclick="showDash()" class="btn btn-secondary">
                        <i class="fas fa-arrow-right"></i> رجوع
                    </button>
                    <h2 class="font-bold text-xl text-slate-800" id="profTitle">...</h2>
                </div>

                <!-- المحتوى -->
                <div class="flex-1 overflow-y-auto">
                    <!-- سجل الدوام -->
                    <div id="attSec" class="hidden mb-6 bg-blue-50 p-5 rounded-xl border border-blue-100 shadow-sm">
                        <h3 class="font-bold text-blue-900 mb-3 flex items-center gap-2">
                            <i class="fas fa-clock"></i> سجل الدوام
                        </h3>
                        <div class="table-wrapper">
                            <table class="w-full text-center text-sm bg-white border border-blue-200 rounded-lg overflow-hidden">
                                <thead class="bg-blue-100 text-blue-900">
                                    <tr>
                                        <th class="p-3">التاريخ</th>
                                        <th>دخول</th>
                                        <th>خروج</th>
                                        <th>المدة</th>
                                    </tr>
                                </thead>
                                <tbody id="attBody" class="text-slate-700"></tbody>
                            </table>
                        </div>
                    </div>

                    <!-- جدول البيانات -->
                    <div class="table-wrapper border shadow-sm">
                        <table class="data-table">
                            <thead id="profHead"></thead>
                            <tbody id="profBody"></tbody>
                        </table>
                    </div>
                           </div>
        </section>

        <!-- شاشة الإعدادات -->
        <section id="setView" class="hidden flex flex-col h-full p-6">
            <div class="flex justify-between items-center mb-4 bg-white p-4 rounded-xl border shadow-sm">
                <div class="flex items-center gap-4">
                    <button onclick="showDash()" class="btn btn-secondary">
                        <i class="fas fa-arrow-right"></i> رجوع
                    </button>
                    <h2 class="font-bold text-xl text-slate-800">الإعدادات العامة</h2>
                </div>
                
                <div class="flex bg-slate-100 p-1 rounded-lg">
                    <button onclick="loadSettingsTab('employees')" id="tabSetEmp" class="px-6 py-2 rounded-md text-sm font-bold transition-all text-slate-600 hover:bg-white hover:shadow-sm">
                        <i class="fas fa-users ml-2"></i> الموظفون
                    </button>
                    <button onclick="loadSettingsTab('details')" id="tabSetDet" class="px-6 py-2 rounded-md text-sm font-bold transition-all text-slate-600 hover:bg-white hover:shadow-sm">
                        <i class="fas fa-cogs ml-2"></i> التفاصيل
                    </button>
                </div>
            </div>

            <div class="mb-4 bg-white p-3 rounded-xl border shadow-sm flex items-center gap-3">
                <i class="fas fa-search text-slate-400"></i>
                <input type="text" id="settingsSearch" onkeyup="filterSettingsTable()" 
                       placeholder="بحث سريع في البيانات المعروضة..." 
                       class="w-full outline-none text-sm font-medium">
            </div>

            <div class="flex-1 table-wrapper bg-white border shadow-sm relative">
                <div id="settingsLoading" class="hidden absolute inset-0 bg-white/80 z-10 flex items-center justify-center">
                    <span class="loader"></span>
                </div>
                <table class="data-table w-full">
                    <thead id="settingsHead"></thead>
                    <tbody id="settingsBody"></tbody>
                </table>
            </div>
        </section>

        <!-- زر التعويم -->
        <button id="floatBtn" class="hidden float-btn" onclick="saveBatch()">
                <i class="fas fa-save text-xl"></i>
                <span>حفظ التغييرات (<span id="batchCnt">0</span>)</span>
            </button>
        </main>
    </div>

    <!-- المودال -->
    <div id="modal" class="hidden modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="mTitle">...</h3>
                <button onclick="closeModal()" class="text-slate-500 hover:text-slate-700 bg-transparent border-none cursor-pointer">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div id="mBody" class="modal-body custom-scrollbar"></div>
            <div class="modal-footer">
                <button onclick="closeModal()" class="btn btn-secondary">إلغاء</button>
                <button id="mAct" class="btn btn-primary">تنفيذ</button>
            </div>
        </div>
    </div>

    <!-- التنبيهات -->
    <div id="toast" class="hidden toast">
        <i class="fas fa-info-circle text-yellow-400 text-xl"></i>
        <span id="tMsg" class="font-bold"></span>
    </div>

    <!-- السكريبت الرئيسي -->
    <script>
        // ==================== الإعدادات العامة ====================
        const API = "https://script.google.com/macros/s/AKfycby2PaX268qTg_SeNkGRGX8GgrSm6A0q9Q7J0VKbpfYR-1z05cl_ZvMgwh5Xc6u9gLhHOA/exec";
        
        // حالة التطبيق
        let state = {
            user: null,
            mode: 'fine',
            meta: {
                mapping: {},
                groups: [],
                followGroups: [],
                specialTypes: [],
                fixedAmounts: {}
            },
            batch: [],
            specialClasses: new Set(),
            smileEvaluations: [],
            pendingApprovals: [],
            selectedApprovals: new Set(),
            allData: [],
            filteredData: [],
            pg: 1,
            lim: 50,
            currentTab: 'obj'
        };

        // ==================== تهيئة التطبيق ====================
        document.addEventListener('DOMContentLoaded', function() {
            const savedUser = localStorage.getItem('hrms_user');
            if (savedUser) {
                try {
                    state.user = JSON.parse(savedUser);
                    initApp();
                } catch (e) {
                    localStorage.removeItem('hrms_user');
                }
            }
            
            const now = new Date();
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            const timeInput = document.getElementById('bulkTime');
            if (timeInput) {
                timeInput.value = now.toISOString().slice(0, 16);
            }
        });

        // ==================== نظام الدخول ====================
        async function attemptLogin() {
            const code = document.getElementById('authCode').value.trim();
            const fp = document.getElementById('authFP').value.trim();
            const loginErr = document.getElementById('loginErr');
            const btnLogin = document.getElementById('btnLogin');
            
            if (!code || !fp) {
                loginErr.textContent = 'الرجاء إدخال الرمز الوظيفي ورقم البصمة';
                return;
            }
            
            btnLogin.innerHTML = '<span class="loader"></span>';
            btnLogin.disabled = true;
            loginErr.textContent = '';
            
            try {
                const response = await fetch(API, {
                    method: 'POST',
                    body: JSON.stringify({
                        action: 'login',
                        code: code,
                        fp: fp
                    })
                });
                
                const data = await response.json();
                
                if (data.result === 'success') {
                    state.user = data.data;
                    state.user.code = code;
                    state.user.fp = fp;
                    
                    localStorage.setItem('hrms_user', JSON.stringify(state.user));
                    
                    toast('تم تسجيل الدخول بنجاح');
                    initApp();
                } else {
                    loginErr.textContent = data.message || 'الرمز أو رقم البصمة غير صحيح';
                }
            } catch (error) {
                loginErr.textContent = 'خطأ في الاتصال بالخادم';
                console.error('Login error:', error);
            } finally {
                btnLogin.innerHTML = 'دخول النظام';
                btnLogin.disabled = false;
            }
        }

        function logout() {
            localStorage.removeItem('hrms_user');
            location.reload();
        }

        // ==================== تهيئة التطبيق بعد الدخول ====================
        async function initApp() {
            document.getElementById('loginView').classList.add('hidden');
            document.getElementById('dashView').classList.remove('hidden');
            document.getElementById('btnLogout').classList.remove('hidden');
            
            document.getElementById('userStatus').textContent = 
                `${state.user.name} | ${state.user.section}`;
            
            await loadMetaData();
            await loadSmileEvaluations();
            
            updatePermissions();
            
            if (state.user.perms.approval) {
                await loadApprovalCount();
            }
        }

        async function loadMetaData() {
            try {
                const response = await fetch(API, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'get_details' })
                });
                
                const data = await response.json();
                
                if (data.result === 'success') {
                    state.meta = data.data;
                    
                    if (state.meta.mapping) {
                        Object.values(state.meta.mapping).forEach(categories => {
                            categories.forEach(cat => state.specialClasses.add(cat));
                        });
                    }
                    
                    if (state.meta.specialTypes) {
                        const ratioTypeSelect = document.getElementById('ratioType');
                        if (ratioTypeSelect) {
                            state.meta.specialTypes.forEach(type => {
                                const option = document.createElement('option');
                                option.value = type;
                                option.textContent = type;
                                ratioTypeSelect.appendChild(option);
                            });
                        }
                    }
                }
            } catch (error) {
                console.error('Error loading meta data:', error);
            }
        }

        async function loadSmileEvaluations() {
            try {
                const response = await fetch(API, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'get_smile_evaluations' })
                });
                
                const data = await response.json();
                
                if (data.result === 'success') {
                    state.smileEvaluations = data.data;
                }
            } catch (error) {
                console.error('Error loading smile evaluations:', error);
            }
        }
		
		function updatePermissions() {
            const perms = state.user.perms;
            
            // تعديل: زر الغرامات يظهر فقط لصلاحية الغرامات
            if (perms.fine) {
                document.getElementById('btnFine').classList.remove('hidden');
            }
            
            // تعديل جديد: زر التخفيضات يظهر فقط لمن لديه صلاحية التخفيضات (العمود M)
            if (perms.reduction) {
                document.getElementById('btnRed').classList.remove('hidden');
            }

            if (perms.bonus) document.getElementById('btnBonus').classList.remove('hidden');
            if (perms.ratio) document.getElementById('btnRatio').classList.remove('hidden');
            if (perms.hr) document.getElementById('btnHR').classList.remove('hidden');
            if (perms.admin) document.getElementById('btnAdmin').classList.remove('hidden');
            if (perms.smile) document.getElementById('btnSmile').classList.remove('hidden');
            if (perms.approval) {
                document.getElementById('btnApprovals').classList.remove('hidden');
            }
        }
        // ==================== التنقل بين الصفحات ====================
                function hideAllViews() {
            const views = [
                'dashView', 'bulkView', 'hrView', 'profView', 
                'setView', 'approvalsView', 'attendanceView'
            ];
            
            views.forEach(view => {
                document.getElementById(view)?.classList.add('hidden');
            });
        }

        function showDash() {
            hideAllViews();
            document.getElementById('dashView').classList.remove('hidden');
            
            if (state.user?.perms.approval) {
                loadApprovalCount();
            }
        }

        function navToAttendance() {
            hideAllViews();
            document.getElementById('attendanceView').classList.remove('hidden');
            
            // تعديل العنوان ليكون شخصياً
            const titleEl = document.querySelector('#attendanceView h2');
            if(titleEl) titleEl.textContent = 'سجل دوامي';

            // إخفاء حقول البحث عن الاسم والبصمة لأننا سنعرض بيانات الموظف فقط
            // نقوم بإخفاء العناصر input الخاصة بالبحث
            const nameInput = document.getElementById('attSearchName');
            const fpInput = document.getElementById('attSearchFP');
            
            // إخفاء الحقول إذا وجدت
            if(nameInput) nameInput.style.display = 'none';
            if(fpInput) fpInput.style.display = 'none';

            // تحميل البيانات فوراً عند الدخول للصفحة
            loadAttendance();
        }

        // ==================== نظام العمليات الجماعية ====================
        function navToBulk(mode) {
            state.mode = mode;
            hideAllViews();
            
            const bulkView = document.getElementById('bulkView');
            bulkView.classList.remove('hidden');
            
            const titles = {
                'fine': 'الغرامات والتنبيهات',
                'bonus': 'المكافآت والحوافز',
                'ratio': 'النسب والعمولات',
                'reduction': 'تخفيض العقوبات',
                'smile': 'غرامات البشاشة'
            };
            
            document.getElementById('bulkTitle').textContent = titles[mode] || mode;
            
            const classColumns = document.querySelectorAll('.col-cls');
            classColumns.forEach(col => {
                col.style.display = (mode === 'fine') ? 'table-cell' : 'none';
            });
            
            const needsApproval = ['bonus', 'ratio', 'reduction'].includes(mode);
            document.getElementById('approvalNote').classList.toggle('hidden', !needsApproval);
            
            document.getElementById('ratioExtraFields').classList.toggle('hidden', mode !== 'ratio');
            
            document.getElementById('bulkBody').innerHTML = '';
            
            if (mode === 'smile') {
                addSmileRow();
            } else {
                addRow();
                loadDropdownsForFirstRow();
            }
        }
		
		/**
         * ============================================================================
         * دالة إضافة صف جديد مع مربعات البحث الذكي
         * ============================================================================
         * تعديل:
         * 1. إضافة حقل بحث ذكي فوق القوائم المنسدلة (عام وخاص)
         * 2. السماح بكتابة النوع للمكافآت والنسب
         * 3. تفعيل حقل المبلغ تلقائياً لغير الغرامات
         * ============================================================================
         */
		
                function addRow(sourceRow = null) {
            const tbody = document.getElementById('bulkBody');
            const newRow = document.createElement('tr');
            const rowIndex = tbody.children.length + 1;
            
            // إعداد حقل النوع
            let typeField = '';
            if (state.mode === 'fine') {
                typeField = `
                    <select class="form-input type-select font-bold text-red-600 bg-red-50" onchange="checkType(this)">
                        <option value="غرامة">غرامة</option>
                        <option value="تنبيه">تنبيه</option>
                    </select>
                `;
            } else {
                let typeVal = state.mode === 'bonus' ? 'مكافأة' : state.mode === 'ratio' ? 'نسبة' : 'تخفيض';
                let typeColor = state.mode === 'bonus' ? 'green' : state.mode === 'ratio' ? 'purple' : 'blue';
                typeField = `
                    <input class="form-input type-input font-bold text-${typeColor}-600 bg-${typeColor}-50" 
                           value="${typeVal}" placeholder="اكتب النوع">
                `;
            }
            
            // خيارات المجموعات
            let groupsOptions = '<option value="">اختر المجموعة</option>';
            const typeMap = { 'fine': 'غرامة', 'bonus': 'مكافأة', 'ratio': 'نسب', 'reduction': 'تخفيض', 'smile': 'smile_fine' };
            const currentType = typeMap[state.mode];
            state.meta.groups.forEach(group => {
                if (group.type.includes(currentType)) {
                    groupsOptions += `<option value="${group.id}">${group.name}</option>`;
                }
            });
            
            // ====== التعديل: إلغاء حقل السبب القابل للتعديل ======
            let reasonField = '';
            if (state.mode === 'fine') {
                reasonField = `
                    <div class="reason-display">
                        <input type="hidden" class="reason-input" value="">
                        <div class="auto-reason text-sm p-2 rounded border bg-slate-100 border-slate-300">
                            <i class="fas fa-info-circle text-blue-500 ml-1"></i>
                            <span class="reason-text">سيتم تعبئة السبب تلقائياً من التصنيف الخاص</span>
                        </div>
                    </div>
                `;
            } else {
                reasonField = `
                    <input class="form-input reason-input" placeholder="السبب">
                `;
            }
            
            const isAmountDisabled = state.mode === 'fine';
            const amountPlaceholder = isAmountDisabled ? "حسب التصنيف" : "أدخل المبلغ";

            newRow.innerHTML = `
                <td class="text-slate-400 font-bold">${rowIndex}</td>
                <td>
                    <input type="number" class="form-input fp-input text-center font-bold" 
                           onchange="getEmployeeName(this)" placeholder="رقم البصمة">
                </td>
                <td>
                    <input class="form-input name-input bg-slate-50 font-bold text-blue-800" 
                           readonly placeholder="الاسم">
                </td>
                <td>${typeField}</td>
                <td>
                    <input type="number" class="form-input amount-input text-center font-bold" 
                           placeholder="${amountPlaceholder}" 
                           min="0" ${isAmountDisabled ? 'disabled' : ''} 
                           onchange="${state.mode === 'fine' ? 'markAmountAsModified(this)' : ''}">
                    ${state.mode === 'fine' ? '<input type="hidden" class="suggested-amount" value="0">' : ''}
                </td>
                <td>${reasonField}</td>
                
                <td style="${state.mode === 'fine' ? '' : 'display:none'}">
                    <div class="relative">
                        <input type="text" class="w-full text-xs border-b mb-1 px-1 focus:outline-none focus:border-blue-500" 
                               placeholder="بحث عام..." onkeyup="filterSelectOptions(this)">
                        <select class="form-input general-class" onchange="loadSpecialClasses(this); updateSuggestedAmount(this)">
                            <option value="">اختر عام</option>
                        </select>
                    </div>
                </td>
                
                <td style="${state.mode === 'fine' ? '' : 'display:none'}">
                    <div class="relative">
                        <input type="text" class="w-full text-xs border-b mb-1 px-1 focus:outline-none focus:border-blue-500" 
                               placeholder="بحث خاص..." onkeyup="filterSelectOptions(this)">
                        <select class="form-input special-class" onchange="updateSpecialClassAmountAndReason(this)">
                            <option value="">اختر خاص</option>
                        </select>
                    </div>
                </td>
                
                <td><select class="form-input group-select">${groupsOptions}</select></td>
                <td><input type="date" class="form-input date-input text-xs"></td>
                <td class="flex gap-2 justify-center">
                    <button onclick="duplicateRow(this)" class="btn btn-secondary btn-small"><i class="fas fa-copy"></i></button>
                    <button onclick="deleteRow(this)" class="btn btn-danger btn-small"><i class="fas fa-trash"></i></button>
                </td>
            `;
            
            if (sourceRow) sourceRow.after(newRow);
            else tbody.appendChild(newRow);
            
            // ضبط التاريخ
            const dateInput = newRow.querySelector('.date-input');
            const bulkTime = document.getElementById('bulkTime').value;
            dateInput.value = bulkTime ? bulkTime.split('T')[0] : new Date().toISOString().split('T')[0];
            
            // تعبئة التصنيف العام للغرامات
            if (state.mode === 'fine') {
                const generalSelect = newRow.querySelector('.general-class');
                Object.keys(state.meta.mapping).forEach(category => {
                    const option = document.createElement('option');
                    option.value = category;
                    option.textContent = category;
                    generalSelect.appendChild(option);
                });
            }
            
            return newRow;
        }
		
		
		function updateSpecialClassAmountAndReason(select) {
            const row = select.closest('tr');
            const amountInput = row.querySelector('.amount-input');
            const hiddenAmount = row.querySelector('.suggested-amount');
            const generalSelect = row.querySelector('.general-class');
            const typeSelect = row.querySelector('.type-select');
            const reasonDisplay = row.querySelector('.reason-text');
            const reasonInput = row.querySelector('.reason-input');

            const specialClass = select.value;
            const generalClass = generalSelect.value;
            const isWarning = typeSelect ? typeSelect.value === 'تنبيه' : false;

            if (generalClass && specialClass) {
                // === التعديل هنا: جعل السبب هو التصنيف الخاص فقط ===
                const autoReason = specialClass; 
                // =================================================
                
                if (reasonDisplay) {
                    reasonDisplay.textContent = autoReason;
                    reasonDisplay.parentElement.classList.remove('bg-slate-100', 'border-slate-300');
                    reasonDisplay.parentElement.classList.add('bg-blue-50', 'border-blue-200', 'text-blue-700');
                }
                
                if (reasonInput) {
                    reasonInput.value = autoReason;
                }
                
                // جلب المبلغ المقترح من السيرفر
                fetch(API, {
                    method: 'POST',
                    body: JSON.stringify({
                        action: 'get_suggested_amount',
                        generalClass: generalClass,
                        specialClass: specialClass
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.result === 'success') {
                        const suggestedAmount = data.data.amount || 0;
                        const isEditable = data.data.editable;
                        
                        if (isWarning) {
                            amountInput.value = 0;
                            amountInput.disabled = true;
                            amountInput.classList.remove('amount-suggestion', 'amount-modified');
                            amountInput.placeholder = "التنبيه لا يحتوي على مبلغ";
                        } else {
                            amountInput.value = suggestedAmount;
                            hiddenAmount.value = suggestedAmount;
                            
                            if (isEditable) {
                                amountInput.disabled = false;
                                amountInput.placeholder = "يمكنك تعديل المبلغ";
                                amountInput.classList.add('amount-suggestion');
                                amountInput.classList.remove('amount-modified');
                            } else {
                                amountInput.disabled = true;
                                amountInput.placeholder = "المبلغ ثابت لا يمكن تعديله";
                                amountInput.classList.add('amount-suggestion');
                                amountInput.classList.remove('amount-modified');
                            }
                            
                            amountInput.oninput = function() {
                                const currentValue = parseInt(this.value) || 0;
                                const suggestedValue = parseInt(hiddenAmount.value) || 0;
                                
                                if (currentValue !== suggestedValue) {
                                    this.classList.add('amount-modified');
                                    this.classList.remove('amount-suggestion');
                                } else {
                                    this.classList.remove('amount-modified');
                                    this.classList.add('amount-suggestion');
                                }
                            };
                        }
                    } else {
                        amountInput.value = '';
                        amountInput.disabled = true;
                        amountInput.placeholder = "خطأ في جلب المبلغ";
                    }
                })
                .catch(error => {
                    amountInput.value = '';
                    amountInput.disabled = true;
                    amountInput.placeholder = "خطأ في الاتصال";
                });
            } else {
                amountInput.value = '';
                amountInput.disabled = true;
                amountInput.placeholder = "اختر التصنيف أولا";
                amountInput.classList.remove('amount-suggestion', 'amount-modified');
                
                // إعادة السبب للقيمة الافتراضية
                if (reasonDisplay) {
                    reasonDisplay.textContent = "سيتم تعبئة السبب تلقائياً من التصنيف الخاص";
                    reasonDisplay.parentElement.classList.remove('bg-blue-50', 'border-blue-200', 'text-blue-700');
                    reasonDisplay.parentElement.classList.add('bg-slate-100', 'border-slate-300');
                }
                if (reasonInput) {
                    reasonInput.value = "";
                }
            }
        }
		

		
		/**
         * ============================================================================
         * دالة فلترة القوائم المنسدلة (بحث ذكي)
         * ============================================================================
         * تقوم بفلترة الخيارات بناءً على الكلمات المكتوبة (بحث متعدد الكلمات)
         * ============================================================================
         */
        function filterSelectOptions(searchInput) {
            const container = searchInput.parentNode;
            const select = container.querySelector('select');
            const filter = searchInput.value.toLowerCase().trim();
            const options = select.getElementsByTagName('option');
            const searchTerms = filter.split(' '); // تقسيم البحث إلى كلمات

            for (let i = 0; i < options.length; i++) {
                const txtValue = options[i].textContent || options[i].innerText;
                
                // الخيار الأول (اختر...) يظهر دائماً
                if (options[i].value === "") {
                    options[i].style.display = "";
                    continue;
                }

                // التحقق من وجود جميع كلمات البحث داخل النص
                const match = searchTerms.every(term => txtValue.toLowerCase().includes(term));

                if (match) {
                    options[i].style.display = "";
                } else {
                    options[i].style.display = "none";
                }
            }
        }


        function loadDropdownsForFirstRow() {
            const firstRow = document.querySelector('#bulkBody tr');
            if (!firstRow) return;
            
            if (state.mode === 'fine') {
                const generalSelect = firstRow.querySelector('.general-class');
                if (generalSelect && generalSelect.options.length <= 1) {
                    Object.keys(state.meta.mapping).forEach(category => {
                        const option = document.createElement('option');
                        option.value = category;
                        option.textContent = category;
                        generalSelect.appendChild(option);
                    });
                }
            }
            
            const groupSelect = firstRow.querySelector('.group-select');
            if (groupSelect && groupSelect.options.length <= 1) {
                const typeMap = {
                    'fine': 'غرامة',
                    'bonus': 'مكافأة',
                    'ratio': 'نسب',
                    'reduction': 'تخفيض'
                };
                
                const currentType = typeMap[state.mode];
                state.meta.groups.forEach(group => {
                    if (group.type.includes(currentType)) {
                        const option = document.createElement('option');
                        option.value = group.id;
                        option.textContent = group.name;
                        groupSelect.appendChild(option);
                    }
                });
            }
        }
		
		function addSmileRow(sourceRow = null) {
            const tbody = document.getElementById('bulkBody');
            const newRow = document.createElement('tr');
            // لم نعد بحاجة لرقم الصف في المعرفات
            const rowIndex = tbody.children.length + 1;
            
            let evaluationsHTML = '<div class="smile-eval-section">';
            
            if (state.smileEvaluations.length === 0) {
                evaluationsHTML += `
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i>
                        <span>لا توجد تصنيفات معرفة في ورقة التفاصيل (العمود J و K).</span>
                    </div>
                `;
            } else {
                // عرض التقييمات كقائمة
                evaluationsHTML += `<div class="grid grid-cols-1 md:grid-cols-2 gap-4">`;
                
                state.smileEvaluations.forEach(item => {
                    evaluationsHTML += `
                        <div class="flex justify-between items-center p-2 bg-white rounded border shadow-sm">
                            <div>
                                <span class="font-bold text-sm text-slate-700">${item.subCategory}</span>
                                <span class="text-xs text-slate-400 block">النقاط: ${item.maxPoints}</span>
                            </div>
                            <div>
                                <select class="form-input text-sm p-1 w-24 eval-select-input font-bold"
                                        data-category="${item.category}"
                                        data-sub="${item.subCategory}"
                                        data-max="${item.maxPoints}"
                                        onchange="calculateSmilePoints(this)">
                                    <option value="0">سيء (0)</option>
                                    <option value="${item.maxPoints}" selected>جيد (${item.maxPoints})</option>
                                </select>
                            </div>
                        </div>
                    `;
                });
                
                evaluationsHTML += `</div>`;
                
                // التغيير الجوهري هنا: استخدام class بدلاً من id للعناصر التي تعرض النتائج
                evaluationsHTML += `
                    <div class="mt-4 p-3 bg-blue-50 rounded border border-blue-200">
                        <div class="flex justify-between items-center mb-2">
                            <span class="font-bold">مجموع النقاط:</span>
                            <span class="font-bold text-xl text-blue-700 total-points-display">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="font-bold">مبلغ الغرامة:</span>
                            <span class="font-bold text-red-600 text-lg amount-display">0 دينار</span>
                        </div>
                    </div>
                `;
            }
            
            evaluationsHTML += '</div>';
            
            let groupsOptions = '<option value="">اختر المجموعة</option>';
            state.meta.groups.forEach(group => {
                if (group.type.includes('smile_fine') || group.name.includes('بشاشة')) {
                    groupsOptions += `<option value="${group.id}">${group.name}</option>`;
                }
            });
            
            newRow.innerHTML = `
                <td class="text-slate-400 font-bold row-number">${rowIndex}</td>
                <td>
                    <input type="number" class="form-input fp-input text-center font-bold" 
                           onchange="getEmployeeName(this)" placeholder="رقم البصمة">
                </td>
                <td>
                    <input class="form-input name-input bg-slate-50 font-bold text-blue-800" 
                           readonly placeholder="سيظهر الاسم تلقائياً">
                </td>
                <td colspan="2">
                    ${evaluationsHTML}
                </td>
                <td>
                    <input class="form-input reason-input" placeholder="سبب إضافي (اختياري)">
                </td>
                <td>
                    <select class="form-input group-select">${groupsOptions}</select>
                </td>
                <td>
                    <input type="datetime-local" class="form-input date-input text-xs">
                </td>
                <td class="flex gap-2 justify-center">
                    <button onclick="duplicateRow(this)" class="btn btn-secondary btn-small" title="تكرار">
                        <i class="fas fa-copy"></i>
                    </button>
                    <button onclick="deleteRow(this)" class="btn btn-danger btn-small" title="حذف">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            `;
            
            if (sourceRow) {
                sourceRow.after(newRow);
            } else {
                tbody.appendChild(newRow);
            }
            
            const dateInput = newRow.querySelector('.date-input');
            const bulkTime = document.getElementById('bulkTime').value;
            dateInput.value = bulkTime || new Date().toISOString().slice(0, 16);
            
            // حساب النقاط الأولية
            if (state.smileEvaluations.length > 0) {
                const firstSelect = newRow.querySelector('.eval-select-input');
                if (firstSelect) calculateSmilePoints(firstSelect);
            }
            
            return newRow;
        }

        async function getEmployeeName(input) {
            const row = input.closest('tr');
            const fp = input.value.trim();
            const nameInput = row.querySelector('.name-input');
            
            if (!fp) {
                nameInput.value = '';
                nameInput.classList.remove('error');
                return;
            }
            
            nameInput.value = '...';
            nameInput.classList.remove('error', 'text-green-600');
            
            try {
                const response = await fetch(API, {
                    method: 'POST',
                    body: JSON.stringify({
                        action: 'get_emp_info',
                        fp: fp
                    })
                });
                
                const data = await response.json();
                
                if (data.result === 'success') {
                    nameInput.value = data.data.name;
                    nameInput.dataset.section = data.data.section || '';
                    nameInput.classList.add('text-green-600');
                } else {
                    nameInput.value = 'غير موجود';
                    nameInput.classList.add('error');
                }
            } catch (error) {
                nameInput.value = 'خطأ في الاتصال';
                nameInput.classList.add('error');
            }
        }

        function loadSpecialClasses(select) {
            const row = select.closest('tr');
            const specialSelect = row.querySelector('.special-class');
            const selectedCategory = select.value;
            
            specialSelect.innerHTML = '<option value="">خاص</option>';
            
            if (selectedCategory && state.meta.mapping[selectedCategory]) {
                state.meta.mapping[selectedCategory].forEach(specialClass => {
                    const option = document.createElement('option');
                    option.value = specialClass;
                    option.textContent = specialClass;
                    specialSelect.appendChild(option);
                });
            }
        }
		
		function checkType(select) {
            const row = select.closest('tr');
            const amountInput = row.querySelector('.amount-input');
            
            // إذا كان الوضع "مكافأة" أو "نسبة" أو "تخفيض" اسمح بالكتابة دائماً
            if (['bonus', 'ratio', 'reduction'].includes(state.mode)) {
                amountInput.disabled = false;
                amountInput.placeholder = "أدخل المبلغ";
                return;
            }

            // منطق الغرامات فقط
            const generalSelect = row.querySelector('.general-class');
            const specialSelect = row.querySelector('.special-class');
            
            if (select && select.value === 'تنبيه') {
                amountInput.value = 0;
                amountInput.disabled = true;
                amountInput.classList.remove('amount-suggestion', 'amount-modified');
            } else {
                // للغرامة العادية، ننتظر اختيار التصنيف
                if (generalSelect && generalSelect.value && specialSelect && specialSelect.value) {
                    // سيتم تفعيله أو تعطيله بناء على إعدادات المبلغ الثابت في الدالة updateSpecialClassAmount
                } else {
                    amountInput.disabled = true; 
                }
            }
        }
		
		function calculateSmilePoints(input) {
            const row = input.closest('tr');
            const pointsInputs = row.querySelectorAll('.eval-select-input');
            let totalPoints = 0;
            
            // تجميع النقاط
            pointsInputs.forEach(selectInput => {
                totalPoints += parseInt(selectInput.value) || 0;
            });
            
            // معادلة الحساب
            let amount = 0;
            if (totalPoints < 5) {
                amount = 25000;
            } else if (totalPoints < 11) {
                amount = 10000;
            } else if (totalPoints < 16) {
                amount = 5000;
            } else {
                amount = 0; // 16 فما فوق
            }
            
            // التعديل الجوهري: البحث عن العناصر داخل الصف نفسه بواسطة الكلاس
            const pointsDisplay = row.querySelector('.total-points-display');
            const amountDisplay = row.querySelector('.amount-display');
            
            if (pointsDisplay) pointsDisplay.textContent = totalPoints;
            if (amountDisplay) amountDisplay.textContent = `${amount.toLocaleString()} دينار`;
            
            // تحديث الحقل المخفي للمبلغ
            let amountInput = row.querySelector('.amount-input');
            if (!amountInput) {
                amountInput = document.createElement('input');
                amountInput.type = 'hidden';
                amountInput.className = 'amount-input';
                row.appendChild(amountInput);
            }
            amountInput.value = amount;
        }
		
		function duplicateRow(button) {
            const sourceRow = button.closest('tr');
            let newRow;
            
            if (state.mode === 'smile') {
                newRow = addSmileRow(sourceRow);
                
                // === إضافة: نسخ قيم التقييمات يدوياً ===
                const sourceEvals = sourceRow.querySelectorAll('.eval-select-input');
                const newEvals = newRow.querySelectorAll('.eval-select-input');
                
                sourceEvals.forEach((sourceSelect, index) => {
                    if (newEvals[index]) {
                        newEvals[index].value = sourceSelect.value;
                    }
                });
                
                // إعادة الحساب للصف الجديد لتحديث المجموع والمبلغ
                if (newEvals.length > 0) {
                    calculateSmilePoints(newEvals[0]);
                }
                
            } else {
                newRow = addRow(sourceRow);
            }
            
            // نسخ الحقول المشتركة
            const fieldsToCopy = ['fp-input', 'name-input', 'amount-input', 'reason-input', 'group-select', 'date-input'];
            fieldsToCopy.forEach(fieldClass => {
                const sourceField = sourceRow.querySelector(`.${fieldClass}`);
                const newField = newRow.querySelector(`.${fieldClass}`);
                
                if (sourceField && newField) {
                    newField.value = sourceField.value;
                }
            });
            
            // نسخ نوع الغرامة (للغرامات العادية)
            const typeSelect = sourceRow.querySelector('.type-select');
            const newTypeSelect = newRow.querySelector('.type-select');
            if (typeSelect && newTypeSelect) {
                newTypeSelect.value = typeSelect.value;
                if (typeof checkType === 'function') {
                    checkType(newTypeSelect);
                }
            }
            
            // منطق نسخ الغرامات العادية (كما هو)
            if (state.mode === 'fine') {
                const sourceGen = sourceRow.querySelector('.general-class');
                const newGen = newRow.querySelector('.general-class');
                
                if (sourceGen && newGen && sourceGen.value) {
                    newGen.value = sourceGen.value;
                    // استخدام setTimeout هنا ضروري فقط للغرامات العادية لتحميل القوائم
                    setTimeout(() => {
                        const sourceSpe = sourceRow.querySelector('.special-class');
                        const newSpe = newRow.querySelector('.special-class');
                        
                        // تحميل التصنيفات الخاصة
                        loadSpecialClasses(newGen);
                        
                        setTimeout(() => {
                            if (sourceSpe && newSpe && sourceSpe.value) {
                                newSpe.value = sourceSpe.value;
                                
                                // نسخ السبب والمبلغ المقترح
                                const newReasonInput = newRow.querySelector('.reason-input');
                                const newReasonDisplay = newRow.querySelector('.reason-text');
                                
                                if (newReasonDisplay) {
                                    newReasonDisplay.textContent = sourceSpe.value;
                                    newReasonDisplay.parentElement.classList.remove('bg-slate-100', 'border-slate-300');
                                    newReasonDisplay.parentElement.classList.add('bg-blue-50', 'border-blue-200', 'text-blue-700');
                                }
                                if (newReasonInput) newReasonInput.value = sourceSpe.value;
                                
                                // نسخ المبلغ وحالته
                                const sourceAmount = sourceRow.querySelector('.amount-input');
                                const newAmount = newRow.querySelector('.amount-input');
                                const sourceHidden = sourceRow.querySelector('.suggested-amount');
                                const newHidden = newRow.querySelector('.suggested-amount');
                                
                                if (sourceAmount && newAmount) {
                                    newAmount.value = sourceAmount.value;
                                    newAmount.disabled = sourceAmount.disabled;
                                    newAmount.className = sourceAmount.className; // نسخ الألوان (أخضر/برتقالي)
                                    
                                    // إعادة تفعيل مستمع الحدث للتعديل
                                    if (!newAmount.disabled) {
                                        newAmount.oninput = function() {
                                            const current = parseInt(this.value) || 0;
                                            const suggested = parseInt(newHidden.value) || 0;
                                            if (current !== suggested) {
                                                this.classList.add('amount-modified');
                                                this.classList.remove('amount-suggestion');
                                            } else {
                                                this.classList.remove('amount-modified');
                                                this.classList.add('amount-suggestion');
                                            }
                                        };
                                    }
                                }
                                if (sourceHidden && newHidden) newHidden.value = sourceHidden.value;
                            }
                        }, 100);
                    }, 100);
                }
            }
            
            renumberRows();
            toast('تم نسخ الصف بنجاح');
        }
		
        function deleteRow(button) {
            const row = button.closest('tr');
            const tbody = document.getElementById('bulkBody');
            
            if (tbody.children.length > 1) {
                row.remove();
                toast('تم حذف الصف');
                
                renumberRows();
            } else {
                toast('لا يمكن حذف الصف الأخير', true);
            }
        }
submitBulk
        function renumberRows() {
            const rows = document.querySelectorAll('#bulkBody tr');
            rows.forEach((row, index) => {
                const numberCell = row.querySelector('td:first-child');
                if (numberCell) {
                    numberCell.textContent = index + 1;
                }
            });
        }
		
		async function submitBulk() {
            const rows = document.querySelectorAll('#bulkBody tr');
            const mode = state.mode;

            if (rows.length === 0) {
                toast("لا توجد بيانات لحفظها", true);
                return;
            }

            const dataRows = [];
            let hasErrors = false;

            for (const row of rows) {
                // تعريف العناصر
                const fpInput = row.querySelector('.fp-input');
                const nameInput = row.querySelector('.name-input');
                const groupSelect = row.querySelector('.group-select');
                const reasonInput = row.querySelector('.reason-input');
                const dateInput = row.querySelector('.date-input');
                const amountInput = row.querySelector('.amount-input');

                // تنظيف الأخطاء
                [fpInput, nameInput, groupSelect, amountInput, reasonInput].forEach(el => el?.classList.remove('error'));

                // التحقق
                let rowError = false;
                if (!fpInput?.value.trim()) { fpInput?.classList.add('error'); rowError = true; }
                if (!nameInput?.value.trim() || nameInput.value.includes('...')) { nameInput?.classList.add('error'); rowError = true; }
                if (!groupSelect?.value) { groupSelect?.classList.add('error'); rowError = true; }

                // التحقق من المبلغ (باستثناء البشاشة والتنبيه)
                const typeSelect = row.querySelector('.type-select');
                const isWarning = (state.mode === 'fine' && typeSelect?.value === 'تنبيه');

                if (state.mode !== 'smile' && state.mode !== 'fine' && !isWarning) {
                    if (!amountInput?.value || parseFloat(amountInput.value) <= 0) {
                        amountInput?.classList.add('error');
                        rowError = true;
                    }
                }

                if (rowError) { hasErrors = true; continue; }

                // السبب التلقائي
                let finalReason = reasonInput?.value.trim();
                if (!finalReason) {
                    if (state.mode === 'fine') {
                        const speSelect = row.querySelector('.special-class');
                        const speText = speSelect && speSelect.selectedIndex > 0 ? speSelect.options[speSelect.selectedIndex].text : '';
                        finalReason = speText || "عدم الالتزام بالتعليمات";
                    } else {
                        finalReason = "مكافأة إدارية";
                    }
                }

                // تجهيز البيانات
                const rowData = {
                    fp: fpInput.value.trim(),
                    name: nameInput.value.trim(),
                    section: nameInput.dataset.section || '',
                    reason: finalReason,
                    groupID: groupSelect.value,
                    groupName: groupSelect.options[groupSelect.selectedIndex]?.text || '',
                    dueDate: dateInput?.value.split('T')[0],
                    sendTime: document.getElementById('bulkTime').value,
                    addedBy: state.user.name
                };

                // منطق البشاشة
                if (state.mode === 'smile') {
                    const evaluations = {};
                    row.querySelectorAll('.eval-select-input').forEach(input => {
                        const val = parseInt(input.value) || 0;
                        evaluations[`${input.dataset.category} - ${input.dataset.sub}`] = val;
                    });

                    rowData.evaluations = evaluations;
                    
                    // التعديل الهام هنا: قراءة مجموع النقاط باستخدام querySelector داخل الصف
                    const pointsElement = row.querySelector('.total-points-display');
                    rowData.totalPoints = pointsElement ? parseInt(pointsElement.textContent) : 0;
                    
                    rowData.amount = parseInt(row.querySelector('.amount-input')?.value) || 0;
                    rowData.type = rowData.amount === 0 ? "مكافأة تقييم" : "غرامة بشاشة";
                    
                } else {
                    const typeInput = row.querySelector('.type-input');
                    rowData.type = typeSelect?.value || typeInput?.value || (state.mode === 'bonus' ? 'مكافأة' : 'نسبة');
                    rowData.amount = parseFloat(amountInput?.value) || 0;

                    if (state.mode === 'fine') {
                        rowData.genClass = row.querySelector('.general-class')?.value || '';
                        rowData.speClass = row.querySelector('.special-class')?.value || '';
                    }
                }
                
                dataRows.push(rowData);
            }

            if (hasErrors) { toast('يرجى إكمال البيانات الناقصة', true); return; }
            if (dataRows.length === 0) return;

            // الإرسال
            const submitBtn = document.getElementById('btnBulkSub');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<span class="loader"></span>';
            submitBtn.disabled = true;

            try {
                const response = await fetch(API, {
                    method: 'POST',
                    body: JSON.stringify({
                        action: 'save_bulk',
                        mode: mode,
                        rows: dataRows,
                        addedBy: state.user.name
                    })
                });
                const data = await response.json();
                if (data.result === 'success') {
                    toast(data.message || `تم الحفظ بنجاح`);
                    document.getElementById('bulkBody').innerHTML = '';
                    state.mode === 'smile' ? addSmileRow() : addRow();
                    if (state.user.perms.approval) loadApprovalCount();
                } else {
                    toast(data.message, true);
                }
            } catch (error) {
                toast('خطأ في الاتصال', true);
            } finally {
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        }
		
        // ==================== نظام الموافقات ====================
        function navToApprovals() {
            hideAllViews();
            document.getElementById('approvalsView').classList.remove('hidden');
            
            document.getElementById('approverName').textContent = state.user.name;
            
            loadPendingApprovals();
        }

        async function loadPendingApprovals() {
            const loading = document.getElementById('loadingOverlayApprovals');
            loading.classList.remove('hidden');
            
            try {
                const response = await fetch(API, {
                    method: 'POST',
                    body: JSON.stringify({
                        action: 'get_pending_approvals',
                        user: state.user
                    })
                });
                
                const data = await response.json();
                
                if (data.result === 'success') {
                    state.pendingApprovals = data.data || [];
                    renderApprovalsTable();
                    updateApprovalStats();
                } else {
                    toast('خطأ في تحميل الموافقات', true);
                }
            } catch (error) {
                toast('خطأ في الاتصال', true);
                console.error('Error loading approvals:', error);
            } finally {
                loading.classList.add('hidden');
            }
        }

        function renderApprovalsTable() {
            const tbody = document.getElementById('approvalsBody');
            
            if (state.pendingApprovals.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="9" class="empty-state">
                            <div class="empty-state-icon">
                                <i class="fas fa-check-circle"></i>
                            </div>
                            <h3 class="empty-state-title">لا توجد طلبات موافقة</h3>
                            <p class="empty-state-description">
                                جميع الطلبات تمت معالجتها. سيظهر هنا أي طلبات جديدة تحتاج موافقتك.
                            </p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            let html = '';
            state.pendingApprovals.forEach((approval, index) => {
                const typeClass = approval.type === 'مكافأة' ? 'ty-bonus' :
                                approval.type === 'نسبة' ? 'ty-ratio' :
                                approval.type === 'تخفيض' ? 'ty-reduction' : 'ty-fine';
                
                html += `
                    <tr class="${index % 2 === 0 ? 'bg-slate-50' : ''}">
                        <td>
                            <input type="checkbox" class="approval-checkbox" 
                                   value="${approval.id}" 
                                   onchange="toggleApprovalSelection('${approval.id}', this.checked)">
                        </td>
                        <td class="text-right">
                            <div class="font-bold">${approval.name}</div>
                            <div class="text-xs text-slate-500">${approval.fp}</div>
                        </td>
                        <td>
                            <span class="type-badge ${typeClass}">${approval.type}</span>
                        </td>
                        <td>
                            <div class="font-bold">${Number(approval.amount).toLocaleString()}</div>
                            <div class="text-xs text-slate-500">${numberToArabicWords(approval.amount)}</div>
                        </td>
                        <td class="text-right text-sm">${approval.reason}</td>
                        <td>${approval.additionalType || '-'}</td>
                        <td>${approval.addedBy}</td>
                        <td class="text-xs">${approval.timestamp || approval.dueDate}</td>
                        <td>
                            <div class="flex gap-2 justify-center">
                                <button onclick="approveSingle('${approval.id}')" 
                                        class="btn btn-success btn-small">
                                    <i class="fas fa-check"></i> موافقة
                                </button>
                                <button onclick="rejectSingle('${approval.id}')" 
                                        class="btn btn-danger btn-small">
                                    <i class="fas fa-times"></i> رفض
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
        }

        function updateApprovalStats() {
            const total = state.pendingApprovals.length;
            const selected = state.selectedApprovals.size;
            
            document.getElementById('pendingCount').textContent = total;
            document.getElementById('approvableCount').textContent = selected;
            document.getElementById('totalRequests').textContent = total;
            
            if (state.user.perms.approval) {
                document.getElementById('approvalCount').textContent = total;
                document.getElementById('approvalBadge').classList.toggle('hidden', total === 0);
            }
        }

        async function loadApprovalCount() {
            if (!state.user?.perms.approval) return;
            
            try {
                const response = await fetch(API, {
                    method: 'POST',
                    body: JSON.stringify({
                        action: 'get_pending_approvals',
                        user: state.user
                    })
                });
                
                const data = await response.json();
                
                if (data.result === 'success') {
                    const count = data.data?.length || 0;
                    document.getElementById('approvalCount').textContent = count;
                    document.getElementById('approvalBadge').classList.toggle('hidden', count === 0);
                }
            } catch (error) {
                // تجاهل الخطأ
            }
        }

        function toggleApprovalSelection(approvalId, isChecked) {
            if (isChecked) {
                state.selectedApprovals.add(approvalId);
            } else {
                state.selectedApprovals.delete(approvalId);
            }
            
            updateApprovalStats();
        }

        function toggleSelectAll(checkbox) {
            const checkboxes = document.querySelectorAll('.approval-checkbox');
            checkboxes.forEach(cb => {
                cb.checked = checkbox.checked;
                toggleApprovalSelection(cb.value, checkbox.checked);
            });
        }

        function selectAllApprovals() {
            const checkboxes = document.querySelectorAll('.approval-checkbox');
            checkboxes.forEach(cb => {
                if (!cb.checked) {
                    cb.checked = true;
                    toggleApprovalSelection(cb.value, true);
                }
            });
            
            toast('تم تحديد جميع الطلبات');
        }

        async function bulkApprove() {
            if (state.selectedApprovals.size === 0) {
                toast('لم يتم تحديد أي طلبات', true);
                return;
            }
            
            const approvalIds = Array.from(state.selectedApprovals);
            
            modal('الموافقة الجماعية', `
                <div class="space-y-4">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        <span>سيتم الموافقة على ${approvalIds.length} طلب</span>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2 text-slate-700">ملاحظة إضافية (اختياري)</label>
                        <textarea id="bulkApprovalNote" class="form-input h-32" 
                                  placeholder="أدخل ملاحظة للموظفين..."></textarea>
                    </div>
                    <p class="text-sm text-slate-600">
                        سيتم إرسال إشعار للموظفين بالموافقة على طلباتهم وإضافتها إلى سجلاتهم.
                    </p>
                </div>
            `, async () => {
                const note = document.getElementById('bulkApprovalNote').value;
                const btn = document.getElementById('mAct');
                const originalText = btn.innerHTML;
                
                btn.innerHTML = '<span class="loader"></span>';
                btn.disabled = true;
                
                try {
                    const response = await fetch(API, {
                        method: 'POST',
                        body: JSON.stringify({
                            action: 'bulk_approve_requests',
                            approvalIds: approvalIds,
                            approvedBy: state.user.name,
                            note: note
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (data.result === 'success') {
                        toast(`تمت الموافقة على ${data.data.approved || 0} طلب بنجاح`);
                        
                        state.selectedApprovals.clear();
                        await loadPendingApprovals();
                        await loadApprovalCount();
                    } else {
                        toast(data.message || 'حدث خطأ في الموافقة', true);
                    }
                } catch (error) {
                    toast('خطأ في الاتصال بالخادم', true);
                    console.error('Bulk approve error:', error);
                } finally {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }
            });
        }

        async function approveSingle(approvalId) {
            modal('موافقة فردية', `
                <div class="space-y-4">
                    <p class="font-bold text-lg">هل تريد الموافقة على هذا الطلب؟</p>
                    <div>
                        <label class="block text-sm font-medium mb-2 text-slate-700">ملاحظة (اختياري)</label>
                        <textarea id="singleApprovalNote" class="form-input h-32" 
                                  placeholder="أدخل ملاحظة للموظف..."></textarea>
                    </div>
                </div>
            `, async () => {
                const note = document.getElementById('singleApprovalNote').value;
                const btn = document.getElementById('mAct');
                const originalText = btn.innerHTML;
                
                btn.innerHTML = '<span class="loader"></span>';
                btn.disabled = true;
                
                try {
                    const response = await fetch(API, {
                        method: 'POST',
                        body: JSON.stringify({
                            action: 'approve_request',
                            approvalId: approvalId,
                            approvedBy: state.user.name,
                            note: note
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (data.result === 'success') {
                        toast('تمت الموافقة بنجاح');
                        
                        state.selectedApprovals.delete(approvalId);
                        await loadPendingApprovals();
                        await loadApprovalCount();
                    } else {
                        toast(data.message || 'حدث خطأ', true);
                    }
                } catch (error) {
                    toast('خطأ في الاتصال', true);
                    console.error('Approve single error:', error);
                } finally {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }
            });
        }

        async function rejectSingle(approvalId) {
            modal('رفض الطلب', `
                <div class="space-y-4">
                    <p class="font-bold text-lg">سبب الرفض</p>
                    <div>
                        <label class="block text-sm font-medium mb-2 text-slate-700">السبب <span class="text-red-500">*</span></label>
                        <textarea id="rejectionReason" class="form-input h-32" 
                                  placeholder="أدخل سبب الرفض..." required></textarea>
                    </div>
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle"></i>
                        <span>هذا الرفض سيتم إرساله للموظف</span>
                    </div>
                </div>
            `, async () => {
                const reason = document.getElementById('rejectionReason').value.trim();
                
                if (!reason) {
                    toast('يرجى إدخال سبب الرفض', true);
                    return;
                }
                
                const btn = document.getElementById('mAct');
                const originalText = btn.innerHTML;
                
                btn.innerHTML = '<span class="loader"></span>';
                btn.disabled = true;
                
                try {
                    const response = await fetch(API, {
                        method: 'POST',
                        body: JSON.stringify({
                            action: 'reject_request',
                            approvalId: approvalId,
                            rejectedBy: state.user.name,
                            reason: reason
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (data.result === 'success') {
                        toast('تم رفض الطلب');
                        
                        state.selectedApprovals.delete(approvalId);
                        await loadPendingApprovals();
                        await loadApprovalCount();
                    } else {
                        toast(data.message || 'حدث خطأ', true);
                    }
                } catch (error) {
                    toast('خطأ في الاتصال', true);
                    console.error('Reject single error:', error);
                } finally {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }
            });
        }

        // ==================== الموارد البشرية ====================
        // ==================== الموارد البشرية ====================
        function navToHR() {
            hideAllViews();
            document.getElementById('hrView').classList.remove('hidden');
            // swTab('obj'); // الكود القديم (الاعتراضات)
            swTab('trk'); // التعديل الجديد: فتح البحث الشامل افتراضياً
        }
		
		function swTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.getElementById(`t${tab.charAt(0).toUpperCase() + tab.slice(1)}`).classList.add('active');
            
            ['objFilters', 'monFilters', 'trackBox', 'statsBox', 'paginationControls', 'sumFilters'].forEach(id => {
                document.getElementById(id)?.classList.add('hidden');
            });
            
            document.getElementById('hrBody').innerHTML = ''; // تنظيف الجدول
            state.currentTab = tab;
            
            switch (tab) {
                case 'obj':
                    document.getElementById('statsBox').classList.remove('hidden');
                    // ... (كود الاعتراضات كما هو لم يتغير)
                    // ... (اختصاراً للمساحة، ابقِ كود obj كما هو لديك)
                    
                    const objColumns = [
                        { key: 'name', title: 'الموظف' },
                        { key: 'type', title: 'النوع' },
                        { key: 'amount', title: 'المبلغ' },
                        { key: 'addedBy', title: 'بواسطة' },
                        { key: 'addedAt', title: 'تاريخ التنزيل' },
                        { key: 'dateStr', title: 'الاستحقاق' },
                        { key: 'objReason', title: 'الاعتراض' },
                        { key: 'objStatus', title: 'الحالة' },
                        { key: 'objDate', title: 'تاريخ الاعتراض' }
                    ];
                    
                    let objHeadHTML = '<tr>';
                    objColumns.forEach(col => {
                        objHeadHTML += `
                            <th class="sortable-header" onclick="sortHRData('${col.key}')">
                                <div class="flex items-center justify-center gap-1">
                                    ${col.title} <i id="sort-${col.key}" class="fas fa-sort sort-icon"></i>
                                </div>
                                <input type="text" class="column-filter" 
                                       onclick="event.stopPropagation()" 
                                       onkeyup="filterHRData(this, '${col.key}')" 
                                       placeholder="بحث...">
                            </th>
                        `;
                    });
                    objHeadHTML += '<th>إجراء</th></tr>';
                    
                    document.getElementById('hrHead').innerHTML = objHeadHTML;
                    document.getElementById('paginationControls').classList.remove('hidden');
                    loadHR(true);
                    break;
					
                case 'mon':
                    document.getElementById('monFilters').classList.remove('hidden');
                    
                    // === الترتيب الصحيح للأعمدة (10 أعمدة + الشيك بوكس + الإجراء = 12 عمود) ===
                    const monColumns = [
                        { key: 'name', title: 'الموظف' },       // 1
                        { key: 'section', title: 'القسم' },      // 2
                        { key: 'type', title: 'النوع' },         // 3
                        { key: 'amount', title: 'المبلغ' },      // 4
                        { key: 'repetition', title: 'التكرار' }, // 5 (العمود الجديد)
                        { key: 'reason', title: 'السبب' },       // 6
                        { key: 'addedBy', title: 'بواسطة' },     // 7
                        { key: 'addedAt', title: 'تاريخ التنزيل' }, // 8
                        { key: 'dateStr', title: 'الاستحقاق' },  // 9
                        { key: 'isFollowed', title: 'الحالة' }   // 10
                    ];

                    let monHeadHTML = '<tr><th width="50"><input type="checkbox" onclick="toggleAllFollowup(this)"></th>';
                    
                    monColumns.forEach(col => {
                        monHeadHTML += `
                            <th class="sortable-header" onclick="sortHRData('${col.key}')">
                                <div class="flex items-center justify-center gap-1">
                                    ${col.title} <i id="sort-${col.key}" class="fas fa-sort sort-icon"></i>
                                </div>
                                <input type="text" class="column-filter" 
                                       onclick="event.stopPropagation()" 
                                       onkeyup="filterHRData(this, '${col.key}')" 
                                       placeholder="بحث...">
                            </th>
                        `;
                    });
                    monHeadHTML += '<th>إجراء</th></tr>';
                    
                    document.getElementById('hrHead').innerHTML = monHeadHTML;
                    document.getElementById('paginationControls').classList.remove('hidden');
                    
                    // تعبئة القوائم المنسدلة للتصنيفات إذا كانت فارغة
                    const classSelect = document.getElementById('fCls');
                    if (classSelect && classSelect.options.length <= 1) {
                        state.specialClasses.forEach(cls => {
                            const option = document.createElement('option');
                            option.value = cls;
                            option.textContent = cls;
                            classSelect.appendChild(option);
                        });
                    }
                    
                    // ضبط colspan ليكون 12 (عدد الأعمدة الكلي)
                    document.getElementById('hrBody').innerHTML = `
                        <tr>
                            <td colspan="12" class="empty-state">
                                <div class="empty-state-icon"><i class="fas fa-calendar-alt"></i></div>
                                <h3 class="empty-state-title">بانتظار تحديد التاريخ</h3>
                                <p class="empty-state-description">يرجى تحديد فترة "من" و "إلى" لعرض سجلات المتابعة.</p>
                            </td>
                        </tr>
                    `;
                    break;
                    
                case 'trk':
                    document.getElementById('trackBox').classList.remove('hidden');
                    document.getElementById('hrHead').innerHTML = `
                        <tr>
                            <th>النوع</th>
                            <th>المبلغ</th>
                            <th>السبب</th>
                            <th>التاريخ</th>
                            <th>الحالة</th>
                        </tr>
                    `;
                    break;
                    
                case 'sum':
                    if (document.getElementById('sumFilters')) {
                        document.getElementById('sumFilters').classList.remove('hidden');
                    }
                    document.getElementById('hrHead').innerHTML = '';
                    loadSummary();
                    break;
            }
        }
		
		function filterSummaryTable() {
            const query = document.getElementById('sumSearchAny').value.toLowerCase().trim();
            
            if (!query) {
                renderSummaryTable(summaryRawData);
                return;
            }
            
            const filteredRows = summaryRawData.filter(row => {
                // البحث في أي عمود من أعمدة الصف
                return row.some(cell => String(cell).toLowerCase().includes(query));
            });
            
            renderSummaryTable(filteredRows);
        }
		async function loadHR(isObjection) {
            // التحقق من التواريخ في حالة المتابعة (Monitoring)
            if (!isObjection) {
                const d1 = document.getElementById('fD1')?.value;
                const d2 = document.getElementById('fD2')?.value;
                
                if (!d1 || !d2) {
                    toast('يرجى تحديد التاريخ (من - إلى) أولاً', true);
                    return; 
                }
            }

            const loading = document.getElementById('loadingOverlay');
            loading.classList.remove('hidden');
            
            try {
                const response = await fetch(API, {
                    method: 'POST',
                    body: JSON.stringify({
                        action: 'get_hr_monitoring_filtered',
                        isObjectionOnly: isObjection,
                        dateFrom: document.getElementById('fD1')?.value || '',
                        dateTo: document.getElementById('fD2')?.value || '',
                        speClass: document.getElementById('fCls')?.value || ''
                    })
                });
                
                const data = await response.json();
                
                if (data.result === 'success') {
                    state.allData = data.data.data || [];
                    
                    if (isObjection) {
                        updateHRStats(data.data.stats || {});
                        // === التعديل الجديد: تطبيق الفرز والفلترة الافتراضية للجدول المتقدم ===
                        applyFiltersAndSort(); 
                    } else {
                        // في حالة المتابعة، نستخدم طريقة العرض القديمة
                        state.pg = 1;
                        renderHRTable();
                    }
                } else {
                    toast('خطأ في تحميل البيانات', true);
                }
            } catch (error) {
                toast('خطأ في الاتصال بالخادم', true);
                console.error('HR load error:', error);
            } finally {
                loading.classList.add('hidden');
            }
        }
		
		function renderHRTable() {
            const tbody = document.getElementById('hrBody');
            const isObjection = state.currentTab === 'obj';
            const isMonitoring = state.currentTab === 'mon';
            
            let filteredData = [...state.allData];
            
            // تحديد عناصر البحث حسب التبويب
            const searchNameInput = isObjection ? document.getElementById('objSearchName') : document.getElementById('monSearchName');
            const searchFPInput = isObjection ? document.getElementById('objSearchFP') : document.getElementById('monSearchFP');
            
            const searchName = searchNameInput?.value.toLowerCase() || '';
            const searchFP = searchFPInput?.value || '';
            
            const searchSpeClass = document.getElementById('fCls')?.value || ''; 

            // تطبيق الفلاتر
            if (searchName) filteredData = filteredData.filter(item => item.name?.toLowerCase().includes(searchName));
            if (searchFP) filteredData = filteredData.filter(item => item.fp?.toString().includes(searchFP));
            
            // تصفية حسب التصنيف الخاص (فقط للمتابعة)
            if (isMonitoring && searchSpeClass) {
                filteredData = filteredData.filter(item => item.speClass === searchSpeClass);
            }

            if (isObjection) {
                const status = document.getElementById('objFilterStatus')?.value;
                const type = document.getElementById('objFilterType')?.value;
                if (status) filteredData = filteredData.filter(item => item.objStatus === status);
                if (type) filteredData = filteredData.filter(item => item.type === type);
            }
            
            state.filteredData = filteredData;
            
            // التقسيم للصفحات
            const total = filteredData.length;
            const totalPages = Math.ceil(total / state.lim) || 1;
            if (state.pg > totalPages) state.pg = 1; // إعادة تعيين للصفحة الأولى عند البحث
            
            const start = (state.pg - 1) * state.lim;
            const end = start + state.lim;
            const pageData = filteredData.slice(start, end);
            
            // تحديد عدد الأعمدة (colspan) لرسالة "لا توجد نتائج"
            const colSpan = isMonitoring ? 10 : 9;

            if (pageData.length === 0) {
                tbody.innerHTML = `<tr><td colspan="${colSpan}" class="empty-state">لا توجد بيانات مطابقة للبحث</td></tr>`;
                document.getElementById('pageInfo').textContent = `0 من 0`;
                document.getElementById('totalRecs').textContent = `(0)`;
                return;
            }
            
            let html = '';
            pageData.forEach(item => {
                // === التعديل هنا: اختيار دالة الرسم المناسبة ===
                if (isMonitoring) {
                    html += renderMonitoringRowNew(item); // استخدام الدالة الجديدة للمتابعة
                } else if (isObjection) {
                    html += renderObjectionRowNew(item); // استخدام الدالة الجديدة للاعتراضات
                } else {
                    html += renderFollowupRow(item); // احتياطي
                }
            });
            tbody.innerHTML = html;
            
            document.getElementById('pageInfo').textContent = `صفحة ${state.pg} من ${totalPages}`;
            document.getElementById('totalRecs').textContent = `(العدد: ${total})`;
        }
		
		
		
		function renderObjectionRow(item) {
            const statusClass = item.objStatus === 'قيد المراجعة' ? 'st-pending' :
                              item.objStatus === 'مقبول' ? 'st-accepted' :
                              item.objStatus === 'مرفوض' ? 'st-rejected' : 'st-followup';
            
            const typeClass = item.type?.includes('غرامة') ? 'ty-fine' :
                            item.type?.includes('مكافأة') ? 'ty-bonus' :
                            item.type?.includes('نسبة') ? 'ty-ratio' :
                            item.type?.includes('بشاشة') ? 'ty-smile' : 'ty-reduction';
            
            // === التعديل هنا: إظهار زر الصورة إذا وجد الرابط ===
            let hasImage = '';
            if (item.objImg && item.objImg.length > 5) { // التأكد من وجود رابط حقيقي
                hasImage = `
                <button onclick="viewObjectionImage('${item.id}', '${item.sheetType}')" 
                        class="mt-2 text-xs flex items-center gap-1 text-blue-600 bg-blue-50 px-2 py-1 rounded hover:bg-blue-100 transition-colors border border-blue-200">
                    <i class="fas fa-image"></i> 
                    <span>عرض المرفق</span>
                </button>`;
            }
            // =================================================

            return `
                <tr>
                    <td class="text-right">
                        <div class="font-bold">${item.name || ''}</div>
                        <div class="text-xs text-slate-500">${item.fp || ''}</div>
                    </td>
                    <td><span class="type-badge ${typeClass}">${item.type || ''}</span></td>
                    <td>
                        <div class="font-bold">${Number(item.amount || 0).toLocaleString()}</div>
                        <div class="text-xs text-slate-500">${numberToArabicWords(item.amount || 0)}</div>
                    </td>
                    <td class="text-right text-sm">${item.reason || ''}</td>
                    <td class="text-right">
                        <div class="text-sm font-medium text-slate-800">${item.objReason || ''}</div>
                        ${hasImage} </td>
                    <td><span class="status-badge ${statusClass}">${item.objStatus || ''}</span></td>
                    <td>
                        <button onclick="hrAction('${item.id}', '${item.sheetType}')" 
                                class="btn btn-primary btn-small">
                            قرار
                        </button>
                    </td>
                </tr>
            `;
        }
		
		function renderFollowupRow(item) {
            const typeClass = item.type?.includes('غرامة') ? 'ty-fine' :
                            item.type?.includes('مكافأة') ? 'ty-bonus' :
                            item.type?.includes('نسبة') ? 'ty-ratio' :
                            item.type?.includes('بشاشة') ? 'ty-smile' : 'ty-reduction';
            
            // إظهار التكرار
            let repetitionBadge = '';
            if (item.repetition && item.repetition > 0) {
                let badgeColor = 'bg-gray-100 text-gray-800';
                if (item.repetition >= 3) badgeColor = 'bg-red-100 text-red-800';
                else if (item.repetition === 2) badgeColor = 'bg-yellow-100 text-yellow-800';
                repetitionBadge = `<span class="mr-2 px-2 py-0.5 rounded text-xs font-bold border ${badgeColor}">تكرار: ${item.repetition}</span>`;
            }

            // === التعديل هنا: تحديد حالة الشيك بوكس ===
            // إذا كان (isFollowed) يساوي نعم، نجعل الشيك بوكس محدداً ومغلقاً
            const isDone = item.isFollowed === 'نعم';
            const checkboxStatus = isDone ? 'checked disabled' : '';
            const rowBackground = isDone ? 'bg-blue-50/50' : ''; // تمييز الصف المنتهي بلون خفيف
            // ===========================================

            return `
                <tr class="${rowBackground}">
                    <td>
                        <input type="checkbox" class="followup-checkbox" 
                               data-id="${item.id}" 
                               data-sheet="${item.sheetType}"
                               onchange="toggleFollowupSelection(this)"
                               ${checkboxStatus}> </td>
                    <td class="text-right font-bold">${item.name || ''}</td>
                    <td><span class="type-badge ${typeClass}">${item.type || ''}</span></td>
                    <td>
                        <div class="font-bold">${Number(item.amount || 0).toLocaleString()}</div>
                        <div class="text-xs text-slate-500">${numberToArabicWords(item.amount || 0)}</div>
                    </td>
                    <td class="text-right text-sm">
                        <div class="flex items-center justify-between">
                            <span>${item.reason || ''}</span>
                            ${repetitionBadge}
                        </div>
                        <div class="text-xs text-slate-500 mt-1 font-semibold">${item.speClass || ''}</div>
                    </td>
                    <td><span class="status-badge ${isDone ? 'st-followup' : 'st-pending'}">${isDone ? 'متابعة' : 'معلق'}</span></td>
                    <td>
                        <div class="flex gap-2 justify-center">
                            <button onclick="editHRItem('${item.id}', '${item.sheetType}', '${item.type || ''}', '${item.amount || 0}', '${item.reason || ''}', '${item.genClass || ''}', '${item.speClass || ''}')" 
                                    class="btn btn-secondary btn-small">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="deleteHRItem('${item.id}', '${item.sheetType}')" 
                                    class="btn btn-danger btn-small">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        }

        function updateHRStats(stats) {
            const statsBox = document.getElementById('statsBox');
            statsBox.innerHTML = `
                <div class="stat-item border-slate-300">الكل: ${stats.total || 0}</div>
                <div class="stat-item border-amber-300 text-amber-700">مراجعة: ${stats.pending || 0}</div>
                <div class="stat-item border-green-300 text-green-700">مقبول: ${stats.accepted || 0}</div>
                <div class="stat-item border-red-300 text-red-700">مرفوض: ${stats.rejected || 0}</div>
                <div class="stat-item border-blue-300 text-blue-700">متابعة: ${stats.followup || 0}</div>
            `;
        }

        function changePage(delta) {
            state.pg += delta;
            
            // استخدام دالة الرسم المتقدمة لكل من الاعتراضات والمتابعة
            if (state.currentTab === 'obj' || state.currentTab === 'mon') {
                renderHRTableFiltered();
            } else {
                renderHRTable();
            }
        }
		
		function toggleAllFollowup(masterCheckbox) {
            const checkboxes = document.querySelectorAll('.followup-checkbox');
            checkboxes.forEach(cb => {
                cb.checked = masterCheckbox.checked;
                toggleFollowupSelection(cb);
            });
        }

        function toggleFollowupSelection(checkbox) {
            const id = checkbox.getAttribute('data-id');
            const sheetType = checkbox.getAttribute('data-sheet');
            
            if (checkbox.checked) {
                // إضافة للقائمة إذا لم يكن موجوداً
                if (!state.batch.find(item => item.id === id)) {
                    state.batch.push({ id, sheetType });
                }
            } else {
                // حذف من القائمة
                state.batch = state.batch.filter(item => item.id !== id);
            }
            
            updateFloatButton();
        }

        

        function updateFloatButton() {
            const floatBtn = document.getElementById('floatBtn');
            const batchCount = document.getElementById('batchCnt');
            
            if (state.batch.length > 0) {
                batchCount.textContent = state.batch.length;
                floatBtn.classList.remove('hidden');
            } else {
                floatBtn.classList.add('hidden');
            }
        }
		
		async function saveBatch() {
            if (state.batch.length === 0) {
                toast('لا توجد تغييرات لحفظها', true);
                return;
            }
            
            // تغيير شكل الزر للتحميل
            const floatBtn = document.getElementById('floatBtn');
            const originalContent = floatBtn.innerHTML;
            floatBtn.innerHTML = '<span class="loader"></span> جاري الحفظ...';
            floatBtn.disabled = true;

            try {
                const response = await fetch(API, {
                    method: 'POST',
                    body: JSON.stringify({
                        action: 'batch_confirm_followup',
                        updates: state.batch
                    })
                });
                
                const data = await response.json();
                
                if (data.result === 'success') {
                    toast(`تم حفظ ${state.batch.length} سجل بنجاح`);
                    state.batch = []; // تصفير القائمة
                    updateFloatButton(); // إخفاء الزر
                    loadHR(false); // إعادة تحميل البيانات لتحديث العلامات
                } else {
                    toast('خطأ في حفظ التغييرات', true);
                }
            } catch (error) {
                toast('خطأ في الاتصال', true);
            } finally {
                floatBtn.innerHTML = originalContent;
                floatBtn.disabled = false;
            }
        }
		
		
		
		function renderSummaryTable(rows) {
            const tbody = document.getElementById('hrBody');
            
            if (!rows || rows.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="100%" class="empty-state">
                            <div class="empty-state-icon"><i class="fas fa-table"></i></div>
                            <h3 class="empty-state-title">الجدول فارغ</h3>
                            <p class="empty-state-description">لا توجد بيانات في ورقة الخلاصة.</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            let html = '';
            rows.forEach(row => {
                html += '<tr class="hover:bg-blue-50 transition-colors">';
                // المرور على كل خلية في الصف
                row.forEach(cellData => {
                    // التحقق مما إذا كانت الخلية تحتوي على رقم لتنسيقه
                    let displayData = cellData;
                    // تمييز الكلمات المفتاحية بألوان
                    if (cellData === 'نشط') displayData = `<span class="status-badge st-accepted">${cellData}</span>`;
                    else if (cellData === 'تحت المراقبة') displayData = `<span class="status-badge st-rejected">${cellData}</span>`;
                    
                    html += `<td class="p-3 border-b text-sm font-medium">${displayData}</td>`;
                });
                html += '</tr>';
            });
            
            tbody.innerHTML = html;
        }
		
		
		
		
		function hrAction(id, sheetType) {
            let groupsOptions = '<option value="">اختر مجموعة المتابعة</option>';
            state.meta.followGroups.forEach(group => {
                groupsOptions += `<option value="${group.id}">${group.name}</option>`;
            });
            
            modal('اتخاذ قرار', `
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium mb-2 text-slate-700">القرار</label>
                        <select id="hrDecision" class="form-input">
                            <option value="مقبول">مقبول</option>
                            <option value="مرفوض">مرفوض</option>
                            <option value="متابعة">متابعة</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2 text-slate-700">مجموعة المتابعة</label>
                        <select id="hrFollowGroup" class="form-input">
                            ${groupsOptions}
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2 text-slate-700">التعليق</label>
                        <textarea id="hrComment" class="form-input h-32" placeholder="أدخل تعليقك..."></textarea>
                    </div>
                </div>
            `, async () => {
                // === بداية التعديل: قفل الزر ===
                const btn = document.getElementById('mAct');
                const originalText = btn.innerHTML;
                
                // تعطيل الزر وتغيير النص لإظهار التحميل
                btn.innerHTML = '<span class="loader"></span> جاري التنفيذ...';
                btn.disabled = true;
                btn.classList.add('opacity-50', 'cursor-not-allowed'); // تنسيق إضافي ليدل على التعطيل
                // ================================

                const decision = document.getElementById('hrDecision').value;
                const followGroup = document.getElementById('hrFollowGroup').value;
                const comment = document.getElementById('hrComment').value;
                
                try {
                    const action = sheetType === 'smile_fine' ? 'hr_smile_action' : 'hr_action';
                    
                    const response = await fetch(API, {
                        method: 'POST',
                        body: JSON.stringify({
                            action: action,
                            id: id,
                            sheetType: sheetType,
                            status: decision,
                            response: comment,
                            followGroupId: followGroup,
                            hrUser: state.user.name
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (data.result === 'success') {
                        toast('تم اتخاذ القرار وإرسال الرد بنجاح');
                        loadHR(true);
                        closeModal(); // إغلاق النافذة عند النجاح
                    } else {
                        toast('حدث خطأ: ' + data.message, true);
                        // إعادة تفعيل الزر في حال فشل العملية من السيرفر ليتمكن المستخدم من المحاولة مجدداً
                        btn.innerHTML = originalText;
                        btn.disabled = false;
                        btn.classList.remove('opacity-50', 'cursor-not-allowed');
                    }
                } catch (error) {
                    toast('خطأ في الاتصال', true);
                    // إعادة تفعيل الزر في حال خطأ الاتصال
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                    btn.classList.remove('opacity-50', 'cursor-not-allowed');
                }
            });
        }
		
		let summaryRawData = []; // متغير لتخزين البيانات الخام للفرز

        async function loadSummary() {
            const loading = document.getElementById('loadingOverlay');
            loading.classList.remove('hidden');
            
            try {
                const response = await fetch(API, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'get_employee_summary' })
                });
                
                const data = await response.json();
                
                if (data.result === 'success') {
                    // البيانات تأتي بصيغة { headers: [], rows: [] }
                    const headers = data.data.headers || [];
                    const rows = data.data.rows || [];
                    
                    summaryRawData = rows; // حفظ للبحث
                    
                    // 1. بناء رأس الجدول ديناميكياً
                    const thead = document.getElementById('hrHead');
                    let headHtml = '<tr>';
                    if (headers.length > 0) {
                        headers.forEach(h => {
                            headHtml += `<th class="whitespace-nowrap">${h}</th>`;
                        });
                    } else {
                        headHtml += '<th>لا توجد أعمدة</th>';
                    }
                    headHtml += '</tr>';
                    thead.innerHTML = headHtml;
                    
                    // 2. بناء جسم الجدول
                    renderSummaryTable(rows);
                    
                } else {
                    toast('لا توجد بيانات', true);
                }
            } catch (error) {
                toast('خطأ في الاتصال', true);
                console.error(error);
            } finally {
                loading.classList.add('hidden');
            }
        }

        async function doTrack() {
            const fp = document.getElementById('trkFP').value.trim();
            
            if (!fp) {
                toast('يرجى إدخال رقم البصمة', true);
                return;
            }
            
            const loading = document.getElementById('loadingOverlay');
            loading.classList.remove('hidden');
            
            try {
                const response = await fetch(API, {
                    method: 'POST',
                    body: JSON.stringify({
                        action: 'get_emp_full_profile',
                        searchFP: fp
                    })
                });
                
                const data = await response.json();
                const tbody = document.getElementById('hrBody');
                
                if (data.result === 'success') {
                    let html = '';
                    
                    // === دوال مساعدة لتنسيق الوقت والمدة داخل الواجهة ===
                    
                    // دالة لاستخراج الوقت (HH:mm:ss) من النص الطويل
                    const cleanTime = (t) => {
                        if (!t) return '';
                        // إذا كان النص يحتوي على T (صيغة ISO) نأخذ ما بعده
                        if (String(t).includes('T')) {
                            // مثال: 1899-12-30T08:30:00.000Z -> 08:30:00
                            return String(t).split('T')[1].split('.')[0];
                        }
                        return t;
                    };

                    // دالة لتحويل صيغة الوقت إلى نص عربي (ساعات ودقائق)
                    const formatDur = (d) => {
                        if (!d) return '';
                        let timeStr = cleanTime(d); // تنظيف النص أولاً
                        
                        if (timeStr.includes(':')) {
                            const parts = timeStr.split(':');
                            const h = parseInt(parts[0]);
                            const m = parseInt(parts[1]);
                            
                            let textParts = [];
                            if (h > 0) textParts.push(`${h} ساعة`);
                            if (m > 0) textParts.push(`${m} دقيقة`);
                            
                            return textParts.length > 0 ? textParts.join(' و ') : '0 دقيقة';
                        }
                        return d; // إعادة القيمة كما هي إذا لم تكن وقتاً
                    };

                    // دالة لتنظيف التاريخ (إزالة الوقت منه)
                    const cleanDate = (d) => {
                        if (!d) return '';
                        if (String(d).includes('T')) {
                            return String(d).split('T')[0];
                        }
                        return d;
                    };
                    // ===================================================

                    if (data.data.attendance?.length > 0) {
                        html += `
                            <tr>
                                <td colspan="5" class="bg-blue-50 font-bold p-3 text-blue-800">
                                    <i class="fas fa-clock"></i> سجل الدوام (${data.data.attendance.length})
                                </td>
                            </tr>
                        `;
                        
                        data.data.attendance.forEach(record => {
                            // تطبيق التنسيق قبل العرض
                            const timeIn = cleanTime(record.in);
                            const timeOut = cleanTime(record.out);
                            const durationText = formatDur(record.duration);
                            const dateText = cleanDate(record.date);

                            html += `
                                <tr class="bg-blue-50/50 hover:bg-blue-100 transition-colors">
                                    <td colspan="2" class="text-center font-bold text-slate-600">دوام</td>
                                    <td class="text-center font-mono text-sm" dir="ltr">
                                        <span class="text-green-600">${timeIn}</span> - <span class="text-red-600">${timeOut}</span>
                                    </td>
                                    <td class="text-center font-mono text-sm">${dateText}</td>
                                    <td class="text-center font-bold text-slate-700">${durationText}</td>
                                </tr>
                            `;
                        });
                    }
                    
                    if (data.data.transactions?.length > 0) {
                        html += `
                            <tr>
                                <td colspan="5" class="bg-slate-50 font-bold p-3 text-slate-800 border-t">
                                    <i class="fas fa-exchange-alt"></i> المعاملات (${data.data.transactions.length})
                                </td>
                            </tr>
                        `;
                        
                        data.data.transactions.forEach(transaction => {
                            const typeClass = transaction.type?.includes('غرامة') ? 'ty-fine' :
                                            transaction.type?.includes('مكافأة') ? 'ty-bonus' :
                                            transaction.type?.includes('نسبة') ? 'ty-ratio' :
                                            transaction.type?.includes('بشاشة') ? 'ty-smile' : 'ty-reduction';
                            
                            html += `
                                <tr class="hover:bg-slate-50">
                                    <td class="text-center"><span class="type-badge ${typeClass}">${transaction.type || ''}</span></td>
                                    <td class="font-bold text-center">${Number(transaction.amount || 0).toLocaleString()}</td>
                                    <td class="text-right max-w-xs truncate" title="${transaction.reason}">${transaction.reason || ''}</td>
                                    <td class="text-center font-mono text-sm">${cleanDate(transaction.date)}</td>
                                    <td class="text-center"><span class="status-badge st-pending">${transaction.objStatus || 'لا يوجد'}</span></td>
                                </tr>
                            `;
                        });
                    }
                    
                    if (!html) {
                        html = `
                            <tr>
                                <td colspan="5" class="empty-state">
                                    <div class="empty-state-icon">
                                        <i class="fas fa-search"></i>
                                    </div>
                                    <h3 class="empty-state-title">لا توجد بيانات</h3>
                                    <p class="empty-state-description">
                                        لا توجد بيانات لهذا الموظف.
                                    </p>
                                </td>
                            </tr>
                        `;
                    }
                    
                    tbody.innerHTML = html;
                } else {
                    toast('الموظف غير موجود', true);
                    tbody.innerHTML = '';
                }
            } catch (error) {
                toast('خطأ في البحث', true);
                console.error(error);
            } finally {
                loading.classList.add('hidden');
            }
        }
		
		function editHRItem(id, sheetType, type, amount, reason, genClass = '', speClass = '') {
            type = type === 'undefined' ? '' : type;
            genClass = genClass === 'undefined' ? '' : genClass;
            speClass = speClass === 'undefined' ? '' : speClass;

            // تحضير خيارات التصنيف العام
            let genOptions = '<option value="">اختر التصنيف العام</option>';
            Object.keys(state.meta.mapping || {}).forEach(gen => {
                const selected = gen === genClass ? 'selected' : '';
                genOptions += `<option value="${gen}" ${selected}>${gen}</option>`;
            });

            // تحضير خيارات التصنيف الخاص
            let speOptions = '<option value="">اختر التصنيف الخاص</option>';
            if (genClass && state.meta.mapping[genClass]) {
                state.meta.mapping[genClass].forEach(spe => {
                    const selected = spe === speClass ? 'selected' : '';
                    speOptions += `<option value="${spe}" ${selected}>${spe}</option>`;
                });
            }

            modal('تعديل المعاملة', `
                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium mb-2 text-slate-700">النوع</label>
                            <input type="text" id="editType" class="form-input" value="${type}" ${sheetType === 'smile_fine' ? 'disabled' : ''}>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2 text-slate-700">المبلغ</label>
                            <input type="number" id="editAmount" class="form-input" value="${amount}">
                        </div>
                    </div>
                    
                    ${sheetType === 'fine' ? `
                    <div class="p-3 bg-slate-50 rounded border">
                        <label class="block text-sm font-bold mb-2 text-blue-800">التصنيف (مهم للتكرار)</label>
                        
                        <div class="mb-3">
                            <label class="text-xs text-slate-500 block mb-1">عام (ابحث واختار)</label>
                            <input type="text" class="w-full text-xs border p-1 mb-1 rounded" placeholder="بحث..." onkeyup="filterSelectOptions(this)">
                            <select id="editGenClass" class="form-input text-sm" onchange="updateEditModalSpecial(this)">
                                ${genOptions}
                            </select>
                        </div>
                        
                        <div>
                            <label class="text-xs text-slate-500 block mb-1">خاص (ابحث واختار)</label>
                            <input type="text" class="w-full text-xs border p-1 mb-1 rounded" placeholder="بحث..." onkeyup="filterSelectOptions(this)">
                            <select id="editSpeClass" class="form-input text-sm">
                                ${speOptions}
                            </select>
                        </div>
                    </div>
                    ` : ''}

                    <div>
                        <label class="block text-sm font-medium mb-2 text-slate-700">السبب</label>
                        <textarea id="editReason" class="form-input h-24">${reason}</textarea>
                    </div>
                </div>
            `, async () => {
                const newType = document.getElementById('editType').value;
                const newAmount = document.getElementById('editAmount').value;
                const newReason = document.getElementById('editReason').value;
                const newGenClass = document.getElementById('editGenClass')?.value || '';
                const newSpeClass = document.getElementById('editSpeClass')?.value || '';
                
                const btn = document.getElementById('mAct');
                const oldText = btn.innerHTML;
                btn.innerHTML = '<span class="loader"></span> جاري الحفظ...';
                btn.disabled = true;

                try {
                    const response = await fetch(API, {
                        method: 'POST',
                        body: JSON.stringify({
                            action: 'update_followup_item',
                            id: id,
                            sheetType: sheetType,
                            subAction: 'edit', // <--- التعديل الجوهري هنا (استبدال action بـ subAction)
                            type: newType,
                            amount: newAmount,
                            reason: newReason,
                            genClass: newGenClass,
                            speClass: newSpeClass
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (data.result === 'success') {
                        toast('تم التعديل بنجاح');
                        loadHR(false);
                        closeModal();
                    } else {
                        toast('خطأ: ' + data.message, true);
                    }
                } catch (error) {
                    toast('خطأ في الاتصال', true);
                } finally {
                    btn.innerHTML = oldText;
                    btn.disabled = false;
                }
            });
        }

        // دالة مساعدة لتحديث القائمة الخاصة داخل المودال
        function updateEditModalSpecial(genSelect) {
            const genVal = genSelect.value;
            const speSelect = document.getElementById('editSpeClass');
            
            let html = '<option value="">اختر التصنيف الخاص</option>';
            if (genVal && state.meta.mapping[genVal]) {
                state.meta.mapping[genVal].forEach(spe => {
                    html += `<option value="${spe}">${spe}</option>`;
                });
            }
            speSelect.innerHTML = html;
        }
		
		async function deleteHRItem(id, sheetType) {
            if (!confirm('هل أنت متأكد من حذف هذه المعاملة؟')) {
                return;
            }
            
            try {
                const response = await fetch(API, {
                    method: 'POST',
                    body: JSON.stringify({
                        action: 'update_followup_item',
                        id: id,
                        sheetType: sheetType,
                        subAction: 'delete' // <--- استخدام subAction
                    })
                });
                
                const data = await response.json();
                
                if (data.result === 'success') {
                    toast('تم الحذف بنجاح');
                    loadHR(false);
                } else {
                    toast('حدث خطأ في الحذف', true);
                }
            } catch (error) {
                toast('خطأ في الاتصال', true);
            }
        }

        // ==================== أوقات الدوام ====================
        async function loadAttendance() {
            const loading = document.getElementById('loadingOverlay');
            loading.classList.remove('hidden');
            
            // تفريغ الجدول القديم قبل التحميل
            const tbody = document.getElementById('attendanceBody');
            tbody.innerHTML = '';
            
            try {
                const response = await fetch(API, {
                    method: 'POST',
                    body: JSON.stringify({
                        action: 'get_attendance_data',
                        // نرسل بصمة المستخدم الحالي المسجل للدخول
                        fp: state.user.fp, 
                        // نرسل التواريخ المحددة (إن وجدت)
                        dateFrom: document.getElementById('attDateFrom')?.value || '',
                        dateTo: document.getElementById('attDateTo')?.value || ''
                    })
                });
                
                const data = await response.json();
                
                if (data.result === 'success' && data.data?.length > 0) {
                    let html = '';
                    data.data.forEach(record => {
                        html += `
                            <tr>
                                <td class="font-bold">${record.fp || ''}</td>
                                <td class="text-right">${record.name || ''}</td>
                                <td>${record.section || ''}</td>
                                <td>${record.date || ''}</td>
                                <td class="text-green-600 font-bold">${record.in || ''}</td>
                                <td class="text-red-600 font-bold">${record.out || ''}</td>
                                <td class="font-bold">${record.duration || ''}</td>
                                <td>
                                    <span class="status-badge ${record.status === 'حاضر' ? 'st-accepted' : 'st-pending'}">
                                        ${record.status || ''}
                                    </span>
                                </td>
                            </tr>
                        `;
                    });
                    
                    tbody.innerHTML = html;
                } else {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="8" class="empty-state">
                                <div class="empty-state-icon">
                                    <i class="fas fa-clock"></i>
                                </div>
                                <h3 class="empty-state-title">لا توجد سجلات</h3>
                                <p class="empty-state-description">
                                    لم يتم العثور على سجلات دوام خاصة بك في الفترة المحددة.
                                </p>
                            </td>
                        </tr>
                    `;
                }
            } catch (error) {
                toast('خطأ في تحميل أوقات الدوام', true);
                console.error(error);
            } finally {
                loading.classList.add('hidden');
            }
        }

        function filterAttendance() {
            const searchName = document.getElementById('attSearchName').value.toLowerCase();
            const searchFP = document.getElementById('attSearchFP').value.toLowerCase();
            
            const rows = document.querySelectorAll('#attendanceBody tr');
            
            rows.forEach(row => {
                const name = row.cells[1].textContent.toLowerCase();
                const fp = row.cells[0].textContent.toLowerCase();
                
                const nameMatch = !searchName || name.includes(searchName);
                const fpMatch = !searchFP || fp.includes(searchFP);
                
                row.style.display = (nameMatch && fpMatch) ? '' : 'none';
            });
        }

        // ==================== الملف الشخصي ====================
        function navToProfile() {
            hideAllViews();
            document.getElementById('profView').classList.remove('hidden');
            document.getElementById('profTitle').textContent = 'ملفي الشخصي';
            document.getElementById('profHead').innerHTML = `
                <tr>
                    <th>النوع</th>
                    <th>المبلغ</th>
                    <th>السبب</th>
                    <th>التاريخ</th>
                    <th>الحالة</th>
                </tr>
            `;
            
            loadProfile();
        }

        function navToAdded() {
            hideAllViews();
            document.getElementById('profView').classList.remove('hidden');
            document.getElementById('profTitle').textContent = 'سجل إضافاتي';
            document.getElementById('attSec').classList.add('hidden');
            document.getElementById('profHead').innerHTML = `
                <tr>
                    <th>الموظف</th>
                    <th>النوع</th>
                    <th>المبلغ</th>
                    <th>السبب</th>
                    <th>التاريخ</th>
                </tr>
            `;
            
            loadAddedHistory();
        }

        async function loadProfile() {
            const tbody = document.getElementById('profBody');
            tbody.innerHTML = `
                <tr>
                    <td colspan="5" class="text-center p-8">
                        <span class="loader w-8 h-8"></span>
                        <p class="mt-3 text-slate-600">جاري تحميل البيانات...</p>
                    </td>
                </tr>
            `;
            
            try {
                const attendanceResponse = await fetch(API, {
                    method: 'POST',
                    body: JSON.stringify({
                        action: 'get_attendance_data',
                        fp: state.user.fp
                    })
                });
                
                const attendanceData = await attendanceResponse.json();
                
                if (attendanceData.result === 'success' && attendanceData.data?.length > 0) {
                    const attBody = document.getElementById('attBody');
                    document.getElementById('attSec').classList.remove('hidden');
                    
                    let attendanceHTML = '';
                    attendanceData.data.forEach(record => {
                        attendanceHTML += `
                            <tr>
                                <td class="p-2">${record.date || ''}</td>
                                <td class="text-green-600 font-bold">${record.in || ''}</td>
                                <td class="text-red-600 font-bold">${record.out || ''}</td>
                                <td class="font-bold">${record.duration || ''}</td>
                            </tr>
                        `;
                    });
                    
                    attBody.innerHTML = attendanceHTML;
                }
                
                const transactionsResponse = await fetch(API, {
                    method: 'POST',
                    body: JSON.stringify({
                        action: 'get_my_received',
                        fp: state.user.fp
                    })
                });
                
                const transactionsData = await transactionsResponse.json();
                
                if (transactionsData.result === 'success') {
                    let transactionsHTML = '';
                    
                    if (transactionsData.data?.length > 0) {
                        transactionsData.data.forEach(transaction => {
                            const rowClass = transaction.sheetType === 'fine' ? 'row-fine' :
                                           transaction.sheetType === 'bonus' ? 'row-bonus' :
                                           transaction.sheetType === 'ratio' ? 'row-ratio' :
                                           transaction.sheetType === 'smile_fine' ? 'row-smile' : 'row-reduction';
                            
                            const objectionButton = (!transaction.objStatus || transaction.objStatus === 'لا يوجد') ? 
                                `<button onclick="submitObjectionModal('${transaction.id}', '${transaction.sheetType}')" 
                                        class="btn btn-secondary btn-small">
                                    اعتراض
                                </button>` : 
                                `<span class="status-badge st-pending">${transaction.objStatus}</span>`;
                            
                            transactionsHTML += `
                                <tr class="${rowClass}">
                                    <td>${transaction.type || ''}</td>
                                    <td>
                                        <div class="font-bold">${Number(transaction.amount || 0).toLocaleString()}</div>
                                        <div class="text-xs text-slate-500">${numberToArabicWords(transaction.amount || 0)}</div>
                                    </td>
                                    <td class="text-right text-sm">${transaction.reason || ''}</td>
                                    <td class="text-sm">${transaction.date || ''}</td>
                                    <td>
                                        <div class="text-xs text-blue-800">${transaction.hrResponse || ''}</div>
                                        ${objectionButton}
                                    </td>
                                </tr>
                            `;
                        });
                    } else {
                        transactionsHTML = `
                            <tr>
                                <td colspan="5" class="empty-state">
                                    <div class="empty-state-icon">
                                        <i class="fas fa-user"></i>
                                    </div>
                                    <h3 class="empty-state-title">لا توجد معاملات</h3>
                                    <p class="empty-state-description">
                                        لا توجد معاملات مسجلة باسمك حالياً.
                                    </p>
                                </td>
                            </tr>
                        `;
                    }
                    
                    tbody.innerHTML = transactionsHTML;
                }
            } catch (error) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="text-center p-8 text-red-500">
                            <i class="fas fa-exclamation-triangle text-2xl mb-3"></i>
                            <p>خطأ في تحميل البيانات</p>
                        </td>
                    </tr>
                `;
            }
        }

        async function loadAddedHistory() {
            const tbody = document.getElementById('profBody');
            tbody.innerHTML = `
                <tr>
                    <td colspan="5" class="text-center p-8">
                        <span class="loader w-8 h-8"></span>
                        <p class="mt-3 text-slate-600">جاري تحميل السجل...</p>
                    </td>
                </tr>
            `;
            
            try {
                const response = await fetch(API, {
                    method: 'POST',
                    body: JSON.stringify({
                        action: 'get_my_added',
                        userName: state.user.name
                    })
                });
                
                const data = await response.json();
                
                if (data.result === 'success') {
                    let html = '';
                    
                    if (data.data?.length > 0) {
                        data.data.forEach(item => {
                            const rowClass = item.sheetType === 'fine' ? 'row-fine' :
                                           item.sheetType === 'bonus' ? 'row-bonus' :
                                           item.sheetType === 'ratio' ? 'row-ratio' :
                                           item.sheetType === 'smile_fine' ? 'row-smile' : 'row-reduction';
                            
                            html += `
                                <tr class="${rowClass}">
                                    <td class="font-bold">${item.name || ''}</td>
                                    <td>
                                        <span class="type-badge ${item.type?.includes('غرامة') ? 'ty-fine' : 
                                                               item.type?.includes('مكافأة') ? 'ty-bonus' : 
                                                               item.type?.includes('نسبة') ? 'ty-ratio' : 'ty-reduction'}">
                                            ${item.type || ''}
                                        </span>
                                    </td>
                                    <td>
                                        <div class="font-bold">${Number(item.amount || 0).toLocaleString()}</div>
                                        <div class="text-xs text-slate-500">${numberToArabicWords(item.amount || 0)}</div>
                                        ${item.totalPoints ? `<div class="text-xs text-yellow-600">النقاط: ${item.totalPoints}</div>` : ''}
                                    </td>
                                    <td class="text-right text-sm">${item.reason || ''}</td>
                                    <td class="text-sm">${item.date || ''}</td>
                                </tr>
                            `;
                        });
                    } else {
                        html = `
                            <tr>
                                <td colspan="5" class="empty-state">
                                    <div class="empty-state-icon">
                                        <i class="fas fa-history"></i>
                                    </div>
                                    <h3 class="empty-state-title">لا توجد إضافات</h3>
                                    <p class="empty-state-description">
                                        لم تقم بإضافة أي معاملات بعد.
                                    </p>
                                </td>
                            </tr>
                        `;
                    }
                    
                    tbody.innerHTML = html;
                }
            } catch (error) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="text-center p-8 text-red-500">
                            <i class="fas fa-exclamation-triangle text-2xl mb-3"></i>
                            <p>خطأ في تحميل السجل</p>
                        </td>
                    </tr>
                `;
            }
        }
		
		function submitObjectionModal(id, sheetType) {
            modal('تقديم اعتراض', `
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium mb-2 text-slate-700">سبب الاعتراض</label>
                        <textarea id="objectionReason" class="form-input h-32" 
                                  placeholder="أدخل سبب اعتراضك..." required></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2 text-slate-700">صورة داعمة (اختياري)</label>
                        <input type="file" id="objectionImage" class="form-input" accept="image/*">
                        <p class="text-xs text-slate-500 mt-1">يجب أن تكون الصورة واضحة (سيتم ضغطها تلقائياً)</p>
                    </div>
                </div>
            `, async () => {
                const reason = document.getElementById('objectionReason').value.trim();
                const imageFile = document.getElementById('objectionImage').files[0];
                
                if (!reason) {
                    toast('يرجى إدخال سبب الاعتراض', true);
                    return;
                }
                
                let imageBase64 = null;
                const btn = document.getElementById('mAct');
                const originalText = btn.innerHTML;
                
                // معالجة وضغط الصورة قبل الإرسال
                if (imageFile) {
                    btn.innerHTML = '<span class="loader"></span> جاري معالجة الصورة...';
                    btn.disabled = true;
                    
                    try {
                        imageBase64 = await new Promise((resolve) => {
                            const reader = new FileReader();
                            reader.onload = (e) => {
                                const img = new Image();
                                img.onload = () => {
                                    // إنشاء كانفاس لضغط الصورة
                                    const canvas = document.createElement('canvas');
                                    let width = img.width;
                                    let height = img.height;
                                    
                                    // تحديد أقصى عرض 1000 بكسل لتقليل الحجم
                                    const MAX_WIDTH = 1000;
                                    const MAX_HEIGHT = 1000;
                                    
                                    if (width > height) {
                                        if (width > MAX_WIDTH) {
                                            height *= MAX_WIDTH / width;
                                            width = MAX_WIDTH;
                                        }
                                    } else {
                                        if (height > MAX_HEIGHT) {
                                            width *= MAX_HEIGHT / height;
                                            height = MAX_HEIGHT;
                                        }
                                    }
                                    
                                    canvas.width = width;
                                    canvas.height = height;
                                    const ctx = canvas.getContext('2d');
                                    ctx.drawImage(img, 0, 0, width, height);
                                    
                                    // تحويل لـ Base64 مع جودة 0.7 (ضغط)
                                    resolve(canvas.toDataURL('image/jpeg', 0.7));
                                };
                                img.src = e.target.result;
                            };
                            reader.readAsDataURL(imageFile);
                        });
                    } catch (e) {
                        toast('خطأ في معالجة ملف الصورة', true);
                        btn.innerHTML = originalText;
                        btn.disabled = false;
                        return;
                    }
                }
                
                btn.innerHTML = '<span class="loader"></span> جاري الرفع...';
                
                try {
                    const action = sheetType === 'smile_fine' ? 'submit_smile_objection' : 'submit_objection';
                    
                    const response = await fetch(API, {
                        method: 'POST',
                        body: JSON.stringify({
                            action: action,
                            id: id,
                            sheetType: sheetType,
                            reason: reason,
                            imageBase64: imageBase64 // إرسال الصورة المضغوطة
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (data.result === 'success') {
                        toast('تم تقديم الاعتراض ورفع الصورة بنجاح');
                        loadProfile();
                        closeModal(); // إغلاق النافذة هنا
                    } else {
                        toast('حدث خطأ في تقديم الاعتراض', true);
                    }
                } catch (error) {
                    toast('خطأ في الاتصال', true);
                } finally {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }
            });
        }

        async function viewObjectionImage(id, sheetType) {
            const btn = event.currentTarget; // الزر المضغوط
            const originalIcon = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            
            try {
                const response = await fetch(API, {
                    method: 'POST',
                    body: JSON.stringify({
                        action: 'get_objection_image',
                        id: id,
                        sheetType: sheetType
                    })
                });
                
                const data = await response.json();
                
                if (data.result === 'success') {
                    // التحقق هل هو رابط درايف أم نص عادي
                    const imgSrc = data.data.image;
                    
                    // إذا كان النص ليس رابطاً ولا صورة (مثلاً كلمة "لا" أو فارغ)
                    if (!imgSrc || imgSrc.length < 5 || imgSrc === "لا") {
                         toast('لا توجد صورة صالحة للعرض', true);
                         return;
                    }

                    modal('صورة الاعتراض', `
                        <div class="text-center flex justify-center items-center bg-slate-100 rounded-lg p-2 min-h-[200px]">
                            <img src="${imgSrc}" 
                                 alt="جاري تحميل الصورة..." 
                                 class="max-w-full max-h-[70vh] rounded shadow-lg object-contain"
                                 onerror="this.src=''; this.alt='تعذر تحميل الصورة (قد تحتاج لتسجيل الدخول لحساب جوجل)'">
                        </div>
                        <div class="text-center mt-2">
                            <a href="${imgSrc}" target="_blank" class="text-blue-600 hover:underline text-sm">
                                <i class="fas fa-external-link-alt"></i> فتح في نافذة جديدة
                            </a>
                        </div>
                    `, () => {});
                    
                    // إخفاء زر التنفيذ في المودال لأنه عرض فقط
                    document.getElementById('mAct').style.display = 'none';
                    
                } else {
                    toast('لا توجد صورة لهذا الاعتراض', true);
                }
            } catch (error) {
                toast('خطأ في تحميل الصورة', true);
            } finally {
                btn.innerHTML = originalIcon;
            }
        }

        // ==================== الإعدادات ====================
        function navToSettings() {
            hideAllViews();
            document.getElementById('setView').classList.remove('hidden');
            // فتح تبويب الموظفين افتراضياً
            loadSettingsTab('employees');
        }
		
		
		async function loadUsers() {
            const tbody = document.getElementById('setBody');
            tbody.innerHTML = `
                <tr>
                    <td colspan="5" class="text-center p-8">
                        <span class="loader w-8 h-8"></span>
                        <p class="mt-3 text-slate-600">جاري تحميل بيانات المستخدمين...</p>
                    </td>
                </tr>
            `;
            
            try {
                const response = await fetch(API, {
                    method: 'POST',
                    body: JSON.stringify({
                        action: 'manage_users',
                        subAction: 'get_all'
                    })
                });
                
                const data = await response.json();
                
                if (data.result === 'success') {
                    let html = '';
                    
                    if (data.data?.length > 0) {
                        data.data.forEach(user => {
                            if (user.deleted !== 'نعم') {
                                // عرض الصلاحيات كنص في الجدول
                                const permissions = [
                                    user.pFine === 'نعم' ? 'غرامات' : '',
                                    user.pBonus === 'نعم' ? 'مكافآت' : '',
                                    user.pRatio === 'نعم' ? 'نسب' : '',
                                    user.pReduction === 'نعم' ? 'تخفيضات' : '', // <--- تم الإضافة
                                    user.pHR === 'نعم' ? 'HR' : '',
                                    user.pAdmin === 'نعم' ? 'Admin' : '',
                                    user.pSmile === 'نعم' ? 'بشاشة' : '',
                                    user.pApproval === 'نعم' ? 'موافقات' : ''
                                ].filter(p => p).join(' | ');
                                
                                // تمرير صلاحية التخفيضات (user.pReduction) إلى دالة التعديل
                                html += `
                                    <tr>
                                        <td class="font-bold">${user.code || ''}</td>
                                        <td>${user.name || ''}</td>
                                        <td>${user.sec || ''}</td>
                                        <td class="text-sm">${permissions || 'لا توجد صلاحيات'}</td>
                                        <td>
                                            <div class="flex gap-2 justify-center">
                                                <button onclick="editUserModal('${user.row}', '${user.code}', '${user.fp}', '${user.name}', '${user.sec}', '${user.pFine}', '${user.pBonus}', '${user.pRatio}', '${user.pHR}', '${user.pAdmin}', '${user.pSmile}', '${user.pApproval}', '${user.pReduction || 'لا'}')" 
                                                        class="btn btn-secondary btn-small">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <button onclick="deleteUser('${user.row}')" 
                                                        class="btn btn-danger btn-small">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                `;
                            }
                        });
                    }
                    
                    if (!html) {
                        html = `
                            <tr>
                                <td colspan="5" class="empty-state">
                                    <div class="empty-state-icon">
                                        <i class="fas fa-users"></i>
                                    </div>
                                    <h3 class="empty-state-title">لا توجد مستخدمين</h3>
                                    <p class="empty-state-description">
                                        لم يتم إضافة أي مستخدمين بعد.
                                    </p>
                                </td>
                            </tr>
                        `;
                    }
                    
                    tbody.innerHTML = html;
                }
            } catch (error) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="text-center p-8 text-red-500">
                            <i class="fas fa-exclamation-triangle text-2xl mb-3"></i>
                            <p>خطأ في تحميل بيانات المستخدمين</p>
                        </td>
                    </tr>
                `;
            }
        }

        function addUser() {
            editUserModal();
        }
		
		// تمت إضافة pReduction كآخر وسيط للدالة
        function editUserModal(row = '', code = '', fp = '', name = '', sec = '', pFine = '', pBonus = '', pRatio = '', pHR = '', pAdmin = '', pSmile = '', pApproval = '', pReduction = '') {
            const isEdit = !!row;
            const title = isEdit ? 'تعديل موظف' : 'إضافة موظف';
            
            modal(title, `
                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium mb-2 text-slate-700">الرمز الوظيفي</label>
                            <input type="text" id="userCode" class="form-input" value="${code}" 
                                   placeholder="أدخل الرمز" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2 text-slate-700">رقم البصمة</label>
                            <input type="text" id="userFp" class="form-input" value="${fp}" 
                                   placeholder="أدخل رقم البصمة" required>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium mb-2 text-slate-700">الاسم الكامل</label>
                        <input type="text" id="userName" class="form-input" value="${name}" 
                                   placeholder="أدخل الاسم الكامل" required>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium mb-2 text-slate-700">القسم</label>
                        <input type="text" id="userSection" class="form-input" value="${sec}" 
                                   placeholder="أدخل القسم">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium mb-2 text-slate-700">الصلاحيات</label>
                        <div class="grid grid-cols-2 gap-3">
                            <label class="flex items-center gap-2">
                                <input type="checkbox" id="permFine" ${pFine === 'نعم' ? 'checked' : ''}>
                                <span class="text-sm">غرامات</span>
                            </label>
                            <label class="flex items-center gap-2">
                                <input type="checkbox" id="permBonus" ${pBonus === 'نعم' ? 'checked' : ''}>
                                <span class="text-sm">مكافآت</span>
                            </label>
                            <label class="flex items-center gap-2">
                                <input type="checkbox" id="permRatio" ${pRatio === 'نعم' ? 'checked' : ''}>
                                <span class="text-sm">نسب</span>
                            </label>
                            <label class="flex items-center gap-2 bg-blue-50 p-1 rounded border border-blue-100">
                                <input type="checkbox" id="permReduction" ${pReduction === 'نعم' ? 'checked' : ''}>
                                <span class="text-sm font-bold text-blue-700">تخفيضات</span>
                            </label>
                            <label class="flex items-center gap-2">
                                <input type="checkbox" id="permHR" ${pHR === 'نعم' ? 'checked' : ''}>
                                <span class="text-sm">HR</span>
                            </label>
                            <label class="flex items-center gap-2">
                                <input type="checkbox" id="permAdmin" ${pAdmin === 'نعم' ? 'checked' : ''}>
                                <span class="text-sm">Admin</span>
                            </label>
                            <label class="flex items-center gap-2">
                                <input type="checkbox" id="permSmile" ${pSmile === 'نعم' ? 'checked' : ''}>
                                <span class="text-sm">بشاشة</span>
                            </label>
                            <label class="flex items-center gap-2">
                                <input type="checkbox" id="permApproval" ${pApproval === 'نعم' ? 'checked' : ''}>
                                <span class="text-sm">موافقات</span>
                            </label>
                        </div>
                    </div>
                </div>
            `, async () => {
                const userData = {
                    row: row,
                    code: document.getElementById('userCode').value.trim(),
                    fp: document.getElementById('userFp').value.trim(),
                    name: document.getElementById('userName').value.trim(),
                    sec: document.getElementById('userSection').value.trim(),
                    pFine: document.getElementById('permFine').checked ? 'نعم' : 'لا',
                    pBonus: document.getElementById('permBonus').checked ? 'نعم' : 'لا',
                    pRatio: document.getElementById('permRatio').checked ? 'نعم' : 'لا',
                    pReduction: document.getElementById('permReduction').checked ? 'نعم' : 'لا', // <--- قراءة القيمة الجديدة
                    pHR: document.getElementById('permHR').checked ? 'نعم' : 'لا',
                    pAdmin: document.getElementById('permAdmin').checked ? 'نعم' : 'لا',
                    pSmile: document.getElementById('permSmile').checked ? 'نعم' : 'لا',
                    pApproval: document.getElementById('permApproval').checked ? 'نعم' : 'لا'
                };
                
                const btn = document.getElementById('mAct');
                const originalText = btn.innerHTML;
                
                btn.innerHTML = '<span class="loader"></span>';
                btn.disabled = true;
                
                try {
                    const response = await fetch(API, {
                        method: 'POST',
                        body: JSON.stringify({
                            action: 'manage_users',
                            subAction: isEdit ? 'edit' : 'add',
                            userData: userData
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (data.result === 'success') {
                        toast(isEdit ? 'تم تعديل الموظف بنجاح' : 'تم إضافة الموظف بنجاح');
                        loadUsers();
                    } else {
                        toast(data.message || 'حدث خطأ', true);
                    }
                } catch (error) {
                    toast('خطأ في الاتصال', true);
                } finally {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }
            });
        }
        async function deleteUser(row) {
            if (!confirm('هل أنت متأكد من حذف هذا الموظف؟')) {
                return;
            }
            
            try {
                const response = await fetch(API, {
                    method: 'POST',
                    body: JSON.stringify({
                        action: 'manage_users',
                        subAction: 'delete',
                        row: row
                    })
                });
                
                const data = await response.json();
                
                if (data.result === 'success') {
                    toast('تم حذف الموظف');
                    loadUsers();
                } else {
                    toast('حدث خطأ في الحذف', true);
                }
            } catch (error) {
                toast('خطأ في الاتصال', true);
            }
        }
		
		/**
         * ============================================================================
         * فتح محرر التفاصيل الشامل (الواجهة الجديدة)
         * ============================================================================
         */
        function manageDetails() {
            // هيكل الجدول القابل للتعديل
            const editorHTML = `
                <div class="flex flex-col h-[70vh]">
                    <div class="alert alert-info mb-4">
                        <i class="fas fa-info-circle"></i>
                        <span>يمكنك تعديل جميع الإعدادات (التصنيفات، المبالغ، الجروبات) من هنا مباشرة. اضغط "حفظ التغييرات" عند الانتهاء.</span>
                    </div>
                    
                    <div class="flex-1 overflow-auto border rounded-lg shadow-inner bg-slate-50">
                        <table class="w-full text-sm bg-white text-center">
                            <thead class="bg-slate-800 text-white sticky top-0 z-10">
                                <tr>
                                    <th class="p-2">عام</th>
                                    <th class="p-2">خاص (السبب)</th>
                                    <th class="p-2">النوع</th>
                                    <th class="p-2">المبلغ</th>
                                    <th class="p-2 w-24">تعديل المبلغ؟</th>
                                    <th class="p-2">اسم الجروب</th>
                                    <th class="p-2">ID الجروب</th>
                                    <th class="p-2 w-10"></th>
                                </tr>
                            </thead>
                            <tbody id="detailsEditorBody">
                                <tr><td colspan="8" class="p-4"><span class="loader"></span> جاري التحميل...</td></tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="mt-4 flex justify-between items-center border-t pt-4">
                        <button onclick="addDetailEditorRow()" class="btn btn-secondary">
                            <i class="fas fa-plus"></i> صف جديد
                        </button>
                        <button onclick="saveFullDetails()" class="btn btn-primary px-8">
                            <i class="fas fa-save"></i> حفظ التغييرات كاملة
                        </button>
                    </div>
                </div>
            `;
            
            // فتح المودال بحجم كبير
            const modalContent = document.querySelector('.modal-content');
            modalContent.style.maxWidth = '95%'; // تكبير العرض
            
            modal('محرر التفاصيل الشامل', editorHTML, () => {});
            
            // إخفاء زر التنفيذ الافتراضي لأننا صنعنا أزرارنا الخاصة
            document.getElementById('mAct').style.display = 'none';
            
            // تحميل البيانات
            loadDetailsForEditor();
        }
		
		/**
         * ============================================================================
         * دوال تشغيل محرر التفاصيل الشامل
         * ============================================================================
         */
        
        // 1. تحميل البيانات الحالية وعرضها في الجدول
        async function loadDetailsForEditor() {
            try {
                // نطلب البيانات الخام (Raw)
                const response = await fetch(API, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'get_raw_details' }) // دالة جديدة
                });
                
                const data = await response.json();
                const tbody = document.getElementById('detailsEditorBody');
                tbody.innerHTML = '';
                
                if (data.result === 'success' && data.data.length > 0) {
                    data.data.forEach(row => {
                        // نعيد تسمية المفاتيح لتتناسب مع دالة الرسم
                        addDetailEditorRow({
                            gen: row.genClass,
                            spe: row.speClass,
                            type: row.type,
                            amount: row.amount,
                            editable: row.editable,
                            grpName: row.grpName, // الآن ستظهر الجروبات
                            grpId: row.grpId,     // والآيديات
                            followName: row.followName,
                            followId: row.followId
                        });
                    });
                } else {
                    addDetailEditorRow(); // صف فارغ
                }
            } catch (error) {
                document.getElementById('detailsEditorBody').innerHTML = 
                    `<tr><td colspan="8" class="text-red-500 p-4">خطأ في التحميل</td></tr>`;
            }
        }
        // 2. إضافة صف جديد في المحرر
        function addDetailEditorRow(data = null) {
            const tbody = document.getElementById('detailsEditorBody');
            const tr = document.createElement('tr');
            tr.className = 'hover:bg-slate-50 border-b';
            
            const gen = data ? data.gen : '';
            const spe = data ? data.spe : '';
            const type = data ? data.type : 'غرامة';
            const amount = data ? data.amount : 0;
            const editable = data ? data.editable : 'لا';
            const grpName = data ? data.grpName : '';
            const grpId = data ? data.grpId : '';
            
            tr.innerHTML = `
                <td class="p-1"><input type="text" class="form-input text-xs font-bold det-gen" value="${gen}" placeholder="عام"></td>
                <td class="p-1"><input type="text" class="form-input text-xs det-spe" value="${spe}" placeholder="خاص"></td>
                <td class="p-1">
                    <select class="form-input text-xs det-type">
                        <option value="غرامة" ${type === 'غرامة' ? 'selected' : ''}>غرامة</option>
                        <option value="تنبيه" ${type === 'تنبيه' ? 'selected' : ''}>تنبيه</option>
                        <option value="smile_fine" ${type === 'smile_fine' ? 'selected' : ''}>بشاشة</option>
                        <option value="مكافأة" ${type === 'مكافأة' ? 'selected' : ''}>مكافأة</option>
                        <option value="تخفيض" ${type === 'تخفيض' ? 'selected' : ''}>تخفيض</option>
                    </select>
                </td>
                <td class="p-1"><input type="number" class="form-input text-xs text-center det-amount" value="${amount}"></td>
                <td class="p-1">
                    <select class="form-input text-xs det-edit">
                        <option value="نعم" ${editable === 'نعم' ? 'selected' : ''}>نعم</option>
                        <option value="لا" ${editable === 'لا' ? 'selected' : ''}>لا</option>
                    </select>
                </td>
                <td class="p-1"><input type="text" class="form-input text-xs det-grp-name" value="${grpName}" placeholder="اسم الجروب"></td>
                <td class="p-1"><input type="text" class="form-input text-xs det-grp-id text-blue-600" value="${grpId}" placeholder="ID (رقمي)"></td>
                <td class="p-1">
                    <button onclick="this.closest('tr').remove()" class="text-red-500 hover:text-red-700">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            `;
            
            tbody.appendChild(tr);
        }

        // 3. حفظ البيانات الكاملة
        async function saveFullDetails() {
            const rows = document.querySelectorAll('#detailsEditorBody tr');
            const dataToSave = [];
            let hasError = false;
            
            rows.forEach(row => {
                // تجاوز صفوف التحميل أو الفارغة
                if (row.querySelector('.loader')) return;
                
                const gen = row.querySelector('.det-gen').value.trim();
                const spe = row.querySelector('.det-spe').value.trim();
                
                // يجب أن يكون هناك على الأقل تصنيف عام وخاص أو اسم جروب و ID
                if (!gen && !spe && !row.querySelector('.det-grp-id').value) return; 
                
                dataToSave.push({
                    genClass: gen,
                    speClass: spe,
                    type: row.querySelector('.det-type').value,
                    amount: row.querySelector('.det-amount').value || 0,
                    editable: row.querySelector('.det-edit').value,
                    grpName: row.querySelector('.det-grp-name').value.trim(),
                    grpId: row.querySelector('.det-grp-id').value.trim(),
                    followName: "مجموعة المتابعة", // افتراضي
                    followId: CONFIG.TELEGRAM_GROUPS ? CONFIG.TELEGRAM_GROUPS.followup : "" // محاولة جلب الافتراضي
                });
            });
            
            if (dataToSave.length === 0) {
                toast('لا توجد بيانات صالحة للحفظ', true);
                return;
            }
            
            if (!confirm('هل أنت متأكد؟ سيتم استبدال جدول التفاصيل بالكامل بهذه البيانات.')) return;
            
            const btn = document.querySelector('button[onclick="saveFullDetails()"]');
            const oldText = btn.innerHTML;
            btn.innerHTML = '<span class="loader"></span> جاري الحفظ...';
            btn.disabled = true;
            
            try {
                const response = await fetch(API, {
                    method: 'POST',
                    body: JSON.stringify({
                        action: 'saveFullDetailsSheet', // تأكد من إضافة هذا الـ case في دالة doPost في السيرفر
                        rows: dataToSave
                    })
                });
                
                // ملاحظة: يجب إضافة case "saveFullDetailsSheet" في السيرفر ليعمل هذا الكود
                // سأفترض أنك أضفت دالة saveFullDetailsSheet في ملف GAS كما وضحت لك في الخطوة 1
                // ولكن يجب ربطها في doPost
                
                const data = await response.json();
                
                if (data.result === 'success') {
                    toast('تم حفظ الإعدادات بنجاح');
                    await loadMetaData(); // تحديث البيانات المحلية
                    closeModal();
                } else {
                    toast('حدث خطأ في الحفظ', true);
                }
            } catch (error) {
                // بما أننا لم نعدل doPost في السيرفر في المحادثة السابقة، قد يفشل هذا
                // لذا سأعطيك كود doPost المعدل أدناه
                toast('تنبيه: تأكد من تحديث دالة doPost في السيرفر', true);
            } finally {
                btn.innerHTML = oldText;
                btn.disabled = false;
            }
        }


        function manageClassifications() {
            let classificationsHTML = '<div class="space-y-4">';
            
            classificationsHTML += `
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-2 text-slate-700">التصنيف العام</label>
                        <input type="text" id="newGeneralClass" class="form-input" placeholder="أدخل التصنيف العام">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2 text-slate-700">التصنيف الخاص</label>
                        <input type="text" id="newSpecialClass" class="form-input" placeholder="أدخل التصنيف الخاص">
                    </div>
                </div>
                <button onclick="addClassification()" class="btn btn-primary w-full">
                    <i class="fas fa-plus"></i> إضافة تصنيف جديد
                </button>
            `;
            
            classificationsHTML += '<div class="mt-6"><h4 class="font-bold mb-3">التصنيفات الحالية</h4>';
            
            if (state.meta.mapping && Object.keys(state.meta.mapping).length > 0) {
                Object.entries(state.meta.mapping).forEach(([generalClass, specialClasses]) => {
                    classificationsHTML += `
                        <div class="mb-4 p-3 border rounded bg-slate-50">
                            <div class="flex justify-between items-center mb-2">
                                <span class="font-bold text-slate-700">${generalClass}</span>
                                <button onclick="editClassification('${generalClass}')" class="btn btn-secondary btn-small">
                                    <i class="fas fa-edit"></i>
                                </button>
                            </div>
                            <div class="space-y-1">
                                ${specialClasses.map(specialClass => `
                                    <div class="flex justify-between items-center p-2 bg-white rounded border">
                                        <span>${specialClass}</span>
                                        <button onclick="editSpecialClass('${generalClass}', '${specialClass}')" 
                                                class="btn btn-secondary btn-small">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                });
            } else {
                classificationsHTML += `
                    <div class="text-center p-6 text-slate-500">
                        <i class="fas fa-list text-3xl mb-3"></i>
                        <p>لا توجد تصنيفات مضافة</p>
                    </div>
                `;
            }
            
            classificationsHTML += '</div></div>';
            
            modal('إدارة التصنيفات', classificationsHTML, () => {});
        }
		
		

        function manageGroups() {
            let groupsHTML = '<div class="space-y-4">';
            
            groupsHTML += `
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-2 text-slate-700">اسم المجموعة</label>
                        <input type="text" id="newGroupName" class="form-input" placeholder="أدخل اسم المجموعة">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2 text-slate-700">ID المجموعة</label>
                        <input type="text" id="newGroupId" class="form-input" placeholder="أدخل ID المجموعة">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2 text-slate-700">النوع</label>
                    <select id="newGroupType" class="form-input">
                        <option value="غرامة">غرامة</option>
                        <option value="مكافأة">مكافأة</option>
                        <option value="smile_fine">بشاشة</option>
                        <option value="تخفيض">تخفيض</option>
                        <option value="متابعة">متابعة</option>
                    </select>
                </div>
                <button onclick="addGroup()" class="btn btn-primary w-full">
                    <i class="fas fa-plus"></i> إضافة مجموعة جديدة
                </button>
            `;
            
            groupsHTML += '<div class="mt-6"><h4 class="font-bold mb-3">المجموعات الحالية</h4>';
            
            if (state.meta.groups && state.meta.groups.length > 0) {
                state.meta.groups.forEach(group => {
                    groupsHTML += `
                        <div class="mb-3 p-3 border rounded bg-slate-50">
                            <div class="flex justify-between items-center">
                                <div>
                                    <span class="font-bold">${group.name}</span>
                                    <div class="text-xs text-slate-500">${group.type} - ID: ${group.id}</div>
                                </div>
                                <div class="flex gap-2">
                                    <button onclick="editGroup('${group.id}', '${group.name}', '${group.type}')" 
                                            class="btn btn-secondary btn-small">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button onclick="deleteGroup('${group.id}')" 
                                            class="btn btn-danger btn-small">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                });
            } else {
                groupsHTML += `
                    <div class="text-center p-6 text-slate-500">
                        <i class="fas fa-users text-3xl mb-3"></i>
                        <p>لا توجد مجموعات مضافة</p>
                    </div>
                `;
            }
            
            groupsHTML += '</div></div>';
            
            modal('إدارة المجموعات', groupsHTML, () => {});
        }

        function manageFixedAmounts() {
            let amountsHTML = '<div class="space-y-4">';
            
            amountsHTML += `
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    <span>إدارة المبالغ الثابتة للغرامات</span>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-2 text-slate-700">التصنيف العام</label>
                        <select id="editGeneralClass" class="form-input" onchange="loadSpecialClassesForEdit()">
                            <option value="">اختر التصنيف العام</option>
                            ${Object.keys(state.meta.mapping || {}).map(general => `
                                <option value="${general}">${general}</option>
                            `).join('')}
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2 text-slate-700">التصنيف الخاص</label>
                        <select id="editSpecialClass" class="form-input">
                            <option value="">اختر التصنيف الخاص</option>
                        </select>
                    </div>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-2 text-slate-700">المبلغ الثابت</label>
                        <input type="number" id="editFixedAmount" class="form-input" placeholder="أدخل المبلغ">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2 text-slate-700">يمكن التعديل</label>
                        <select id="editEditable" class="form-input">
                            <option value="نعم">نعم</option>
                            <option value="لا">لا</option>
                        </select>
                    </div>
                </div>
                
                <button onclick="updateFixedAmount()" class="btn btn-primary w-full">
                    <i class="fas fa-save"></i> حفظ المبلغ
                </button>
            `;
            
            amountsHTML += '<div class="mt-6"><h4 class="font-bold mb-3">المبالغ الحالية</h4>';
            
            if (state.meta.fixedAmounts && Object.keys(state.meta.fixedAmounts).length > 0) {
                Object.entries(state.meta.fixedAmounts).forEach(([key, data]) => {
                    const [general, special] = key.split('|');
                    amountsHTML += `
                        <div class="mb-3 p-3 border rounded bg-slate-50">
                            <div class="flex justify-between items-center">
                                <div>
                                    <span class="font-bold">${general} - ${special}</span>
                                    <div class="text-sm text-slate-700">المبلغ: ${data.amount.toLocaleString()} دينار</div>
                                    <div class="text-xs text-slate-500">يمكن التعديل: ${data.editable ? 'نعم' : 'لا'}</div>
                                </div>
                                <button onclick="editFixedAmountSetting('${general}', '${special}', ${data.amount}, ${data.editable})" 
                                        class="btn btn-secondary btn-small">
                                    <i class="fas fa-edit"></i>
                                </button>
                            </div>
                        </div>
                    `;
                });
            } else {
                amountsHTML += `
                    <div class="text-center p-6 text-slate-500">
                        <i class="fas fa-money-bill text-3xl mb-3"></i>
                        <p>لا توجد مبالغ ثابتة مضافة</p>
                    </div>
                `;
            }
            
            amountsHTML += '</div></div>';
            
            modal('إدارة المبالغ الثابتة', amountsHTML, () => {});
        }

        function loadSpecialClassesForEdit() {
            const generalClass = document.getElementById('editGeneralClass').value;
            const specialSelect = document.getElementById('editSpecialClass');
            
            specialSelect.innerHTML = '<option value="">اختر التصنيف الخاص</option>';
            
            if (generalClass && state.meta.mapping[generalClass]) {
                state.meta.mapping[generalClass].forEach(specialClass => {
                    const option = document.createElement('option');
                    option.value = specialClass;
                    option.textContent = specialClass;
                    specialSelect.appendChild(option);
                });
            }
        }

        async function updateFixedAmount() {
            const generalClass = document.getElementById('editGeneralClass').value;
            const specialClass = document.getElementById('editSpecialClass').value;
            const amount = document.getElementById('editFixedAmount').value;
            const editable = document.getElementById('editEditable').value;
            
            if (!generalClass || !specialClass || !amount) {
                toast('يرجى ملء جميع الحقول', true);
                return;
            }
            
            try {
                const response = await fetch(API, {
                    method: 'POST',
                    body: JSON.stringify({
                        action: 'update_suggested_amount',
                        generalClass: generalClass,
                        specialClass: specialClass,
                        amount: amount,
                        editable: editable
                    })
                });
                
                const data = await response.json();
                
                if (data.result === 'success') {
                    toast('تم تحديث المبلغ بنجاح');
                    await loadMetaData();
                    manageFixedAmounts();
                } else {
                    toast('حدث خطأ في تحديث المبلغ', true);
                }
            } catch (error) {
                toast('خطأ في الاتصال', true);
            }
        }

        function editFixedAmountSetting(general, special, amount, editable) {
            document.getElementById('editGeneralClass').value = general;
            loadSpecialClassesForEdit();
            
            setTimeout(() => {
                document.getElementById('editSpecialClass').value = special;
                document.getElementById('editFixedAmount').value = amount;
                document.getElementById('editEditable').value = editable ? 'نعم' : 'لا';
            }, 100);
        }

        async function createSampleData() {
            if (!confirm('هل تريد إنشاء بيانات تجريبية؟ سيتم إضافة بيانات نموذجية للنظام.')) {
                return;
            }
            
            try {
                const response = await fetch(API, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'create_sample_data' })
                });
                
                const data = await response.json();
                
                if (data.result === 'success') {
                    toast('تم إنشاء البيانات التجريبية بنجاح');
                    await loadMetaData();
                    await loadSmileEvaluations();
                    loadUsers();
                } else {
                    toast(data.message || 'حدث خطأ', true);
                }
            } catch (error) {
                toast('خطأ في الاتصال', true);
            }
        }

        async function deleteSampleData() {
            if (!confirm('هل أنت متأكد من حذف جميع البيانات التجريبية؟')) {
                return;
            }
            
            try {
                const response = await fetch(API, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'delete_sample_data' })
                });
                
                const data = await response.json();
                
                if (data.result === 'success') {
                    toast('تم حذف البيانات التجريبية بنجاح');
                } else {
                    toast(data.message || 'حدث خطأ', true);
                }
            } catch (error) {
                toast('خطأ في الاتصال', true);
            }
        }

        async function manageSmileEvaluations() {
            try {
                const response = await fetch(API, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'get_smile_evaluations' })
                });
                
                const data = await response.json();
                
                if (data.result === 'success') {
                    let evaluationsHTML = '';
                    
                    if (data.data?.length > 0) {
                        evaluationsHTML = `
                            <div class="space-y-4">
                                <button onclick="addSmileEvaluation()" class="btn btn-primary w-full">
                                    <i class="fas fa-plus"></i> إضافة تقييم جديد
                                </button>
                                
                                <div class="space-y-3">
                                    ${data.data.map(eval => `
                                        <div class="p-4 border rounded bg-white">
                                            <div class="flex justify-between items-start mb-2">
                                                <div>
                                                    <h4 class="font-bold text-slate-800">${eval.category} - ${eval.subCategory}</h4>
                                                    <p class="text-sm text-slate-600">${eval.description}</p>
                                                    <p class="text-xs text-slate-500 mt-1">النقاط: ${eval.minPoints} إلى ${eval.maxPoints}</p>
                                                </div>
                                                <div class="flex gap-2">
                                                    <button onclick="editSmileEvaluation('${eval.category}', '${eval.subCategory}', ${eval.maxPoints}, ${eval.minPoints}, '${eval.description}')" 
                                                            class="btn btn-secondary btn-small">
                                                        <i class="fas fa-edit"></i>
                                                    </button>
                                                    <button onclick="deleteSmileEvaluation('${eval.category}', '${eval.subCategory}')" 
                                                            class="btn btn-danger btn-small">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        `;
                    } else {
                        evaluationsHTML = `
                            <div class="text-center p-8">
                                <i class="fas fa-smile text-4xl text-yellow-500 mb-3"></i>
                                <h3 class="font-bold text-lg mb-2">لا توجد تقييمات</h3>
                                <p class="text-slate-600 mb-4">لم يتم إضافة أي تقييمات للبشاشة بعد.</p>
                                <button onclick="addSmileEvaluation()" class="btn btn-primary">
                                    <i class="fas fa-plus"></i> إضافة أول تقييم
                                </button>
                            </div>
                        `;
                    }
                    
                    modal('إدارة تقييمات البشاشة', evaluationsHTML, () => {});
                }
            } catch (error) {
                toast('خطأ في تحميل التقييمات', true);
            }
        }
		
		        function navToSettings() {
            hideAllViews();
            document.getElementById('setView').classList.remove('hidden');
            loadSettingsTab('employees');
        }
		
		        function loadSettingsTab(tab) {
            document.getElementById('tabSetEmp').classList.remove('bg-white', 'text-blue-600', 'shadow-sm');
            document.getElementById('tabSetDet').classList.remove('bg-white', 'text-blue-600', 'shadow-sm');
            
            if (tab === 'employees') {
                document.getElementById('tabSetEmp').classList.add('bg-white', 'text-blue-600', 'shadow-sm');
                loadEmployeesTable();
            } else if (tab === 'details') {
                document.getElementById('tabSetDet').classList.add('bg-white', 'text-blue-600', 'shadow-sm');
                loadDetailsTable();
            }
        }
		
		        async function loadEmployeesTable() {
            const loading = document.getElementById('settingsLoading');
            loading.classList.remove('hidden');
            
            try {
                const response = await fetch(API, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'get_sheet_content', sheetType: 'employees' })
                });
                
                const data = await response.json();
                
                if (data.result === 'success') {
                    renderSettingsTable(data.data.headers, data.data.rows, 'employees');
                } else {
                    toast('خطأ في تحميل بيانات الموظفين', true);
                }
            } catch (error) {
                toast('خطأ في الاتصال', true);
            } finally {
                loading.classList.add('hidden');
            }
        }
		
		
		        async function loadDetailsTable() {
            const loading = document.getElementById('settingsLoading');
            loading.classList.remove('hidden');
            
            try {
                const response = await fetch(API, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'get_sheet_content', sheetType: 'details' })
                });
                
                const data = await response.json();
                
                if (data.result === 'success') {
                    renderSettingsTable(data.data.headers, data.data.rows, 'details');
                } else {
                    toast('خطأ في تحميل بيانات التفاصيل', true);
                }
            } catch (error) {
                toast('خطأ في الاتصال', true);
            } finally {
                loading.classList.add('hidden');
            }
        }
		        function shouldBeEditable(colIndex, sheetType) {
            if (sheetType === 'employees') {
                // في جدول الموظفين، الأعمدة القابلة للتعديل:
                // 0: الرمز الوظيفي، 1: البصمة، 2: القسم، 3: الاسم، 4-11: الصلاحيات
                return true; // جميع الأعمدة قابلة للتعديل
            } else if (sheetType === 'details') {
                // في جدول التفاصيل، جميع الأعمدة قابلة للتعديل
                return true;
            }
            return false;
        }
		
		
		        function renderSettingsTable(headers, rows, sheetType) {
            const thead = document.getElementById('settingsHead');
            const tbody = document.getElementById('settingsBody');
            
            // بناء الرأس
            let headerHTML = '<tr>';
            headers.forEach((header, index) => {
                headerHTML += `<th class="text-center p-3 bg-slate-800 text-white">${header}</th>`;
            });
            headerHTML += '<th class="text-center p-3 bg-slate-800 text-white">إجراءات</th></tr>';
            thead.innerHTML = headerHTML;
            
            // بناء الجسم
            if (rows.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="${headers.length + 1}" class="text-center p-8 text-slate-500">
                            <div class="empty-state">
                                <i class="fas fa-table empty-state-icon"></i>
                                <h3 class="empty-state-title">لا توجد بيانات</h3>
                                <p class="empty-state-description">لم يتم العثور على سجلات في هذا الجدول</p>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            let bodyHTML = '';
            rows.forEach((row, rowIndex) => {
                bodyHTML += `<tr id="row_${rowIndex}" class="hover:bg-slate-50 transition-colors">`;
                
                // إضافة خلايا البيانات مع إمكانية التعديل
                row.forEach((cell, colIndex) => {
                    const cellId = `cell_${rowIndex}_${colIndex}`;
                    const isEditable = shouldBeEditable(colIndex, sheetType);
                    
                    if (isEditable) {
                        // خلية قابلة للتعديل
                        bodyHTML += `
                            <td class="p-2 border-b">
                                <div class="cell-container relative group">
                                    <span id="${cellId}" 
                                          class="editable-cell block w-full p-2 rounded border border-transparent hover:border-blue-300 hover:bg-blue-50 cursor-pointer"
                                          onclick="makeCellEditable('${cellId}', ${rowIndex}, ${colIndex}, '${sheetType}')">
                                        ${cell || '<span class="text-slate-400">فارغ</span>'}
                                    </span>
                                </div>
                            </td>
                        `;
                    } else {
                        // خلية للعرض فقط
                        bodyHTML += `
                            <td class="p-2 border-b">
                                <div class="p-2">
                                    ${cell || '<span class="text-slate-400">-</span>'}
                                </div>
                            </td>
                        `;
                    }
                });
                
                // أزرار الإجراءات
                bodyHTML += `
                    <td class="p-2 border-b">
                        <div class="flex gap-2 justify-center">
                            <button onclick="saveRow(${rowIndex}, '${sheetType}')" 
                                    class="btn btn-success btn-small">
                                <i class="fas fa-save"></i> حفظ
                            </button>
                            <button onclick="addNewRow('${sheetType}')" 
                                    class="btn btn-primary btn-small">
                                <i class="fas fa-plus"></i> جديد
                            </button>
                            <button onclick="deleteRowFromTable(${rowIndex}, '${sheetType}')" 
                                    class="btn btn-danger btn-small">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                
                bodyHTML += '</tr>';
            });
            
            tbody.innerHTML = bodyHTML;
        }
		
		        function saveCellEdit(inputElement) {
            const newValue = inputElement.value.trim();
            const originalValue = inputElement.dataset.originalValue;
            const rowIndex = parseInt(inputElement.dataset.rowIndex);
            const colIndex = parseInt(inputElement.dataset.colIndex);
            const sheetType = inputElement.dataset.sheetType;
            const cellId = `cell_${rowIndex}_${colIndex}`;
            
            if (newValue === originalValue) {
                restoreCellDisplay(cellId, originalValue);
                return;
            }
            
            // تحديث القيمة مباشرة في الواجهة أولاً
            updateCellInUI(cellId, newValue);
            
            // إرسال التحديث للسيرفر
            updateCellOnServer(rowIndex, colIndex, newValue, sheetType, cellId);
        }
		
		        function cancelCellEdit(inputElement, originalValue) {
            const rowIndex = inputElement.dataset.rowIndex;
            const colIndex = inputElement.dataset.colIndex;
            const cellId = `cell_${rowIndex}_${colIndex}`;
            
            restoreCellDisplay(cellId, originalValue);
        }
		
		        function restoreCellDisplay(cellId, value) {
            const cellElement = document.getElementById(cellId);
            if (!cellElement) return;
            
            cellElement.innerHTML = value || '<span class="text-slate-400">فارغ</span>';
            cellElement.setAttribute('onclick', `makeCellEditable('${cellId}', ${cellId.split('_')[1]}, ${cellId.split('_')[2]}, '${cellElement.parentElement.closest('table').dataset.sheetType || 'employees'}')`);
        }
		
		        function updateCellInUI(cellId, newValue) {
            const cellElement = document.getElementById(cellId);
            if (!cellElement) return;
            
            cellElement.innerHTML = newValue || '<span class="text-slate-400">فارغ</span>';
            
            // إضافة تأثير بصرى للتأكيد
            cellElement.classList.add('bg-green-50', 'border', 'border-green-200');
            setTimeout(() => {
                cellElement.classList.remove('bg-green-50', 'border', 'border-green-200');
            }, 1000);
        }
		
		        async function updateCellOnServer(rowIndex, colIndex, newValue, sheetType, cellId) {
            try {
                const response = await fetch(API, {
                    method: 'POST',
                    body: JSON.stringify({
                        action: 'update_sheet_cell',
                        sheetType: sheetType,
                        rowIndex: rowIndex,
                        colIndex: colIndex,
                        value: newValue
                    })
                });
                
                const data = await response.json();
                
                if (data.result === 'success') {
                    toast('تم حفظ التغيير بنجاح ✓');
                    
                    // تحديث خاصية onclick للخلية بعد الحفظ
                    const cellElement = document.getElementById(cellId);
                    if (cellElement) {
                        cellElement.setAttribute('onclick', `makeCellEditable('${cellId}', ${rowIndex}, ${colIndex}, '${sheetType}')`);
                    }
                } else {
                    toast('خطأ في الحفظ ❌', true);
                    restoreCellDisplay(cellId, cellElement.dataset.originalValue);
                }
            } catch (error) {
                toast('خطأ في الاتصال بالخادم ❌', true);
                console.error('Update error:', error);
                restoreCellDisplay(cellId, cellElement.dataset.originalValue);
            }
        }
		
		        async function saveRow(rowIndex, sheetType) {
            try {
                const rowElement = document.getElementById(`row_${rowIndex}`);
                if (!rowElement) return;
                
                const cells = rowElement.querySelectorAll('[id^="cell_"]');
                const updates = [];
                
                // جمع جميع التحديثات في الصف
                cells.forEach(cell => {
                    const cellId = cell.id;
                    const parts = cellId.split('_');
                    const cellRowIndex = parseInt(parts[1]);
                    const cellColIndex = parseInt(parts[2]);
                    
                    if (cellRowIndex === rowIndex) {
                        const newValue = cell.textContent.trim();
                        updates.push({
                            colIndex: cellColIndex,
                            value: newValue === 'فارغ' ? '' : newValue
                        });
                    }
                });
                
                // إرسال جميع التحديثات دفعة واحدة
                const response = await fetch(API, {
                    method: 'POST',
                    body: JSON.stringify({
                        action: 'update_sheet_row',
                        sheetType: sheetType,
                        rowIndex: rowIndex,
                        updates: updates
                    })
                });
                
                const data = await response.json();
                
                if (data.result === 'success') {
                    toast(`تم حفظ الصف ${rowIndex + 1} بنجاح ✓`);
                    rowElement.classList.add('bg-green-50');
                    setTimeout(() => {
                        rowElement.classList.remove('bg-green-50');
                    }, 2000);
                } else {
                    toast('خطأ في حفظ الصف ❌', true);
                }
            } catch (error) {
                toast('خطأ في الاتصال ❌', true);
            }
        }
		
		        function addNewRow(sheetType) {
            const tbody = document.getElementById('settingsBody');
            const headers = document.querySelectorAll('#settingsHead th');
            const headersCount = headers.length - 1; // ناقص عمود الإجراءات
            
            // إنشاء صف جديد
            const newRowIndex = tbody.querySelectorAll('tr').length;
            let rowHTML = `<tr id="row_new_${newRowIndex}" class="bg-yellow-50">`;
            
            // إضافة خلايا فارغة
            for (let colIndex = 0; colIndex < headersCount; colIndex++) {
                const cellId = `cell_new_${newRowIndex}_${colIndex}`;
                rowHTML += `
                    <td class="p-2 border-b">
                        <div class="cell-container">
                            <input type="text" 
                                   id="${cellId}"
                                   class="form-input w-full p-2 text-sm border-2 border-yellow-500 rounded"
                                   placeholder="أدخل القيمة...">
                        </div>
                    </td>
                `;
            }
            
            // إضافة أزرار الإجراءات
            rowHTML += `
                <td class="p-2 border-b">
                    <div class="flex gap-2 justify-center">
                        <button onclick="saveNewRow(${newRowIndex}, '${sheetType}')" 
                                class="btn btn-success btn-small">
                            <i class="fas fa-save"></i> حفظ
                        </button>
                        <button onclick="cancelNewRow(${newRowIndex})" 
                                class="btn btn-danger btn-small">
                            <i class="fas fa-times"></i> إلغاء
                        </button>
                    </div>
                </td>
            `;
            
            rowHTML += '</tr>';
            
            // إضافة الصف الجديد في الأعلى
            tbody.insertAdjacentHTML('afterbegin', rowHTML);
            
            toast('تمت إضافة صف جديد، قم بتعبئة البيانات ثم اضغط حفظ');
        }
		
		        async function saveNewRow(rowIndex, sheetType) {
            try {
                const rowElement = document.getElementById(`row_new_${rowIndex}`);
                if (!rowElement) return;
                
                const inputs = rowElement.querySelectorAll('input');
                const rowData = [];
                
                // جمع بيانات الصف الجديد
                inputs.forEach(input => {
                    rowData.push(input.value.trim());
                });
                
                // التحقق من أن جميع الحقول مملوءة
                const emptyFields = rowData.filter(value => !value);
                if (emptyFields.length > 0) {
                    toast('يرجى ملء جميع الحقول ❌', true);
                    return;
                }
                
                // إرسال الصف الجديد للسيرفر
                const response = await fetch(API, {
                    method: 'POST',
                    body: JSON.stringify({
                        action: 'add_sheet_row',
                        sheetType: sheetType,
                        rowData: rowData
                    })
                });
                
                const data = await response.json();
                
                if (data.result === 'success') {
                    toast('تم إضافة الصف الجديد بنجاح ✓');
                    
                    // إعادة تحميل الجدول
                    if (sheetType === 'employees') {
                        await loadEmployeesTable();
                    } else {
                        await loadDetailsTable();
                    }
                } else {
                    toast('خطأ في إضافة الصف ❌', true);
                }
            } catch (error) {
                toast('خطأ في الاتصال ❌', true);
            }
        }
		
		
		        function cancelNewRow(rowIndex) {
            const rowElement = document.getElementById(`row_new_${rowIndex}`);
            if (rowElement) {
                rowElement.remove();
                toast('تم إلغاء إضافة الصف الجديد');
            }
        }
		
		        async function deleteRowFromTable(rowIndex, sheetType) {
            if (!confirm('هل أنت متأكد من حذف هذا الصف؟ هذا الإجراء لا يمكن التراجع عنه.')) {
                return;
            }
            
            try {
                const response = await fetch(API, {
                    method: 'POST',
                    body: JSON.stringify({
                        action: 'delete_sheet_row',
                        sheetType: sheetType,
                        rowIndex: rowIndex
                    })
                });
                
                const data = await response.json();
                
                if (data.result === 'success') {
                    toast('تم حذف الصف بنجاح ✓');
                    
                    // إعادة تحميل الجدول
                    if (sheetType === 'employees') {
                        await loadEmployeesTable();
                    } else {
                        await loadDetailsTable();
                    }
                } else {
                    toast('خطأ في حذف الصف ❌', true);
                }
            } catch (error) {
                toast('خطأ في الاتصال ❌', true);
            }
        }
		
		
		
		                function makeCellEditable(cellId, rowIndex, colIndex, sheetType) {
            const cellElement = document.getElementById(cellId);
            if (!cellElement) return;
            
            const originalValue = cellElement.textContent.trim();
            
            // إنشاء حقل إدخال
            const input = document.createElement('input');
            input.type = 'text';
            input.value = originalValue === 'فارغ' ? '' : originalValue;
            input.className = 'form-input w-full p-2 text-sm border-2 border-blue-500 rounded shadow-sm';
            input.dataset.originalValue = originalValue;
            input.dataset.rowIndex = rowIndex;
            input.dataset.colIndex = colIndex;
            input.dataset.sheetType = sheetType;
            
            // استبدال النص بحقل الإدخال
            cellElement.innerHTML = '';
            cellElement.appendChild(input);
            input.focus();
            input.select();
            
            // أحداث لوحة المفاتيح
            input.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    saveCellEdit(this);
                } else if (e.key === 'Escape') {
                    cancelCellEdit(this, originalValue);
                }
            });
            
            // حدث عند فقدان التركيز
            input.addEventListener('blur', function() {
                if (this.value !== originalValue && this.value !== '') {
                    saveCellEdit(this);
                } else {
                    cancelCellEdit(this, originalValue);
                }
            });
        }
		        async function saveTableCell(input, rowIndex, colIndex, sheetType) {
            const newValue = input.value;
            
            try {
                const response = await fetch(API, {
                    method: 'POST',
                    body: JSON.stringify({
                        action: 'update_sheet_cell',
                        sheetType: sheetType,
                        rowIndex: rowIndex,
                        colIndex: colIndex,
                        value: newValue
                    })
                });
                
                const data = await response.json();
                
                if (data.result === 'success') {
                    const span = document.createElement('span');
                    span.id = input.id;
                    span.className = 'flex-1 py-1 px-2 min-h-[36px]';
                    span.textContent = newValue;
                    input.parentNode.replaceChild(span, input);
                    
                    toast('تم حفظ التغيير');
                } else {
                    toast('خطأ في الحفظ', true);
                    input.focus();
                }
            } catch (error) {
                toast('خطأ في الاتصال', true);
                input.focus();
            }
        }
		
		        function restoreTableCell(input, originalValue) {
            const span = document.createElement('span');
            span.id = input.id;
            span.className = 'flex-1 py-1 px-2 min-h-[36px]';
            span.textContent = originalValue;
            input.parentNode.replaceChild(span, input);
        }
		
		        async function deleteSettingsRow(rowIndex, sheetType) {
            if (!confirm('هل أنت متأكد من حذف هذا الصف؟')) {
                return;
            }
            
            toast('يجب تنفيذ دالة الحذف في السيرفر', true);
        }
		
		        function filterSettingsTable() {
            const searchTerm = document.getElementById('settingsSearch').value.toLowerCase().trim();
            const rows = document.querySelectorAll('#settingsBody tr');
            let visibleCount = 0;
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                const isNewRow = row.id.startsWith('row_new_');
                
                if (searchTerm === '' || text.includes(searchTerm) || isNewRow) {
                    row.style.display = '';
                    visibleCount++;
                } else {
                    row.style.display = 'none';
                }
            });
            
            // إظهار رسالة إذا لم توجد نتائج
            const noResultsMsg = document.getElementById('noResultsMessage');
            if (visibleCount === 0 && searchTerm !== '') {
                if (!noResultsMsg) {
                    const msg = document.createElement('div');
                    msg.id = 'noResultsMessage';
                    msg.className = 'text-center p-8 text-slate-500';
                    msg.innerHTML = `
                        <i class="fas fa-search text-3xl mb-3"></i>
                        <p>لا توجد نتائج مطابقة للبحث: "${searchTerm}"</p>
                    `;
                    document.getElementById('settingsBody').appendChild(msg);
                }
            } else if (noResultsMsg) {
                noResultsMsg.remove();
            }
        }
		
		        

        function addSmileEvaluation(category = '', subCategory = '', maxPoints = 5, minPoints = 0, description = '') {
            const isEdit = !!category;
            const title = isEdit ? 'تعديل تقييم' : 'إضافة تقييم';
            
            modal(title, `
                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium mb-2 text-slate-700">التصنيف</label>
                            <input type="text" id="evalCategory" class="form-input" value="${category}" 
                                   placeholder="مثال: المظهر العام" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2 text-slate-700">التفصيل</label>
                            <input type="text" id="evalSubCategory" class="form-input" value="${subCategory}" 
                                   placeholder="مثال: النظافة الشخصية" required>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium mb-2 text-slate-700">النقاط الدنيا</label>
                            <input type="number" id="evalMinPoints" class="form-input" value="${minPoints}" 
                                   min="0" max="10" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2 text-slate-700">النقاط القصوى</label>
                            <input type="number" id="evalMaxPoints" class="form-input" value="${maxPoints}" 
                                   min="1" max="10" required>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium mb-2 text-slate-700">الوصف</label>
                        <textarea id="evalDescription" class="form-input h-32" 
                                  placeholder="أدخل وصفاً للتقييم...">${description}</textarea>
                    </div>
                </div>
            `, async () => {
                const evalData = {
                    action: isEdit ? 'update' : 'add',
                    category: document.getElementById('evalCategory').value.trim(),
                    subCategory: document.getElementById('evalSubCategory').value.trim(),
                    maxPoints: parseInt(document.getElementById('evalMaxPoints').value) || 5,
                    minPoints: parseInt(document.getElementById('evalMinPoints').value) || 0,
                    description: document.getElementById('evalDescription').value.trim()
                };
                
                if (isEdit) {
                    evalData.oldCategory = category;
                    evalData.oldSubCategory = subCategory;
                }
                
                const btn = document.getElementById('mAct');
                const originalText = btn.innerHTML;
                
                btn.innerHTML = '<span class="loader"></span>';
                btn.disabled = true;
                
                try {
                    const response = await fetch(API, {
                        method: 'POST',
                        body: JSON.stringify({
                            action: 'update_smile_evaluation',
                            ...evalData
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (data.result === 'success') {
                        toast(isEdit ? 'تم تحديث التقييم' : 'تم إضافة التقييم');
                        manageSmileEvaluations();
                        await loadSmileEvaluations();
                    } else {
                        toast(data.message || 'حدث خطأ', true);
                    }
                } catch (error) {
                    toast('خطأ في الاتصال', true);
                } finally {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }
            });
        }

        function editSmileEvaluation(category, subCategory, maxPoints, minPoints, description) {
            addSmileEvaluation(category, subCategory, maxPoints, minPoints, description);
        }

        async function deleteSmileEvaluation(category, subCategory) {
            if (!confirm(`هل أنت متأكد من حذف التقييم "${category} - ${subCategory}"؟`)) {
                return;
            }
            
            try {
                const response = await fetch(API, {
                    method: 'POST',
                    body: JSON.stringify({
                        action: 'update_smile_evaluation',
                        action: 'delete',
                        category: category,
                        subCategory: subCategory
                    })
                });
                
                const data = await response.json();
                
                if (data.result === 'success') {
                    toast('تم حذف التقييم');
                    manageSmileEvaluations();
                    await loadSmileEvaluations();
                } else {
                    toast('حدث خطأ في الحذف', true);
                }
            } catch (error) {
                toast('خطأ في الاتصال', true);
            }
        }
        
        // ==================== نظام المبالغ المقترحة ====================
        async function updateSpecialClassAmount(select) {
            const row = select.closest('tr');
            const amountInput = row.querySelector('.amount-input');
            const hiddenAmount = row.querySelector('.suggested-amount');
            const generalSelect = row.querySelector('.general-class');
            const typeSelect = row.querySelector('.type-select');

            const specialClass = select.value;
            const generalClass = generalSelect.value;
            const isWarning = typeSelect ? typeSelect.value === 'تنبيه' : false;

            if (generalClass && specialClass) {
                try {
                    const response = await fetch(API, {
                        method: 'POST',
                        body: JSON.stringify({
                            action: 'get_suggested_amount',
                            generalClass: generalClass,
                            specialClass: specialClass
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (data.result === 'success') {
                        const suggestedAmount = data.data.amount || 0;
                        const isEditable = data.data.editable;
                        
                        if (isWarning) {
                            amountInput.value = 0;
                            amountInput.disabled = true;
                            amountInput.classList.remove('amount-suggestion', 'amount-modified');
                            amountInput.placeholder = "التنبيه لا يحتوي على مبلغ";
                        } else {
                            amountInput.value = suggestedAmount;
                            hiddenAmount.value = suggestedAmount;
                            
                            if (isEditable) {
                                amountInput.disabled = false;
                                amountInput.placeholder = "يمكنك تعديل المبلغ";
                                amountInput.classList.add('amount-suggestion');
                                amountInput.classList.remove('amount-modified');
                            } else {
                                amountInput.disabled = true;
                                amountInput.placeholder = "المبلغ ثابت لا يمكن تعديله";
                                amountInput.classList.add('amount-suggestion');
                                amountInput.classList.remove('amount-modified');
                            }
                            
                            amountInput.oninput = function() {
                                const currentValue = parseInt(this.value) || 0;
                                const suggestedValue = parseInt(hiddenAmount.value) || 0;
                                
                                if (currentValue !== suggestedValue) {
                                    this.classList.add('amount-modified');
                                    this.classList.remove('amount-suggestion');
                                } else {
                                    this.classList.remove('amount-modified');
                                    this.classList.add('amount-suggestion');
                                }
                            };
                        }
                    } else {
                        amountInput.value = '';
                        amountInput.disabled = true;
                        amountInput.placeholder = "خطأ في جلب المبلغ";
                    }
                } catch (error) {
                    amountInput.value = '';
                    amountInput.disabled = true;
                    amountInput.placeholder = "خطأ في الاتصال";
                }
            } else {
                amountInput.value = '';
                amountInput.disabled = true;
                amountInput.placeholder = "اختر التصنيف أولا";
                amountInput.classList.remove('amount-suggestion', 'amount-modified');
            }
        }

        function markAmountAsModified(input) {
            const row = input.closest('tr');
            const hiddenAmount = row.querySelector('.suggested-amount');
            
            if (parseInt(input.value) !== parseInt(hiddenAmount.value)) {
                input.classList.add('amount-modified');
                input.classList.remove('amount-suggestion');
            } else {
                input.classList.remove('amount-modified');
                input.classList.add('amount-suggestion');
            }
        }

        function updateSuggestedAmount(select) {
            loadSpecialClasses(select);
        }

        // ==================== دوال مساعدة ====================
        function modal(title, content, action) {
            document.getElementById('mTitle').textContent = title;
            document.getElementById('mBody').innerHTML = content;
            
            // === التصحيح: إعادة ضبط زر التنفيذ لوضعه الأصلي ===
            const btn = document.getElementById('mAct');
            btn.style.display = 'inline-flex'; // ضمان ظهوره
            btn.innerHTML = 'تنفيذ';           // إعادة النص
            btn.disabled = false;              // إلغاء التعطيل
            btn.classList.remove('opacity-50', 'cursor-not-allowed'); // إزالة ستايل التعطيل
            // ================================================

            document.getElementById('modal').classList.remove('hidden');
            
            // تعيين وظيفة الزر الجديدة
            btn.onclick = async () => {
                // ننتظر انتهاء العملية (action)
                // ملاحظة: الدالة action (مثل hrAction) هي المسؤولة عن إغلاق المودال عند النجاح
                await action();
            };
        }

        function closeModal() {
            const modal = document.getElementById('modal');
            modal.classList.add('hidden');
            
            // تنظيف محتوى المودال لتوفير الذاكرة ومنع التداخل
            setTimeout(() => {
                if (modal.classList.contains('hidden')) {
                    document.getElementById('mBody').innerHTML = '';
                }
            }, 300);
        }
		

        function toast(message, isError = false) {
            const toast = document.getElementById('toast');
            const messageSpan = document.getElementById('tMsg');
            
            messageSpan.textContent = message;
            toast.style.borderColor = isError ? '#ef4444' : '#10b981';
            
            toast.classList.remove('hidden');
            
            setTimeout(() => {
                toast.classList.add('hidden');
            }, 3000);
        }

        function numberToArabicWords(num) {
            const units = ['', 'واحد', 'اثنان', 'ثلاثة', 'أربعة', 'خمسة', 'ستة', 'سبعة', 'ثمانية', 'تسعة'];
            const tens = ['', 'عشرة', 'عشرون', 'ثلاثون', 'أربعون', 'خمسون', 'ستون', 'سبعون', 'ثمانون', 'تسعون'];
            const hundreds = ['', 'مائة', 'مائتان', 'ثلاثمائة', 'أربعمائة', 'خمسمائة', 'ستمائة', 'سبعمائة', 'ثمانمائة', 'تسعمائة'];
            
            if (num === 0) return 'صفر';
            if (num < 0) return 'سالب ' + numberToArabicWords(Math.abs(num));
            
            let result = '';
            
            if (num >= 1000000) {
                const millions = Math.floor(num / 1000000);
                if (millions === 1) result += 'مليون ';
                else if (millions === 2) result += 'مليونان ';
                else if (millions <= 10) result += units[millions] + ' ملايين ';
                else result += numberToArabicWords(millions) + ' مليوناً ';
                num %= 1000000;
                if (num > 0) result += 'و ';
            }
            
            if (num >= 1000) {
                const thousands = Math.floor(num / 1000);
                if (thousands === 1 && num % 1000 === 0) result += 'ألف';
                else if (thousands === 2 && num % 1000 === 0) result += 'ألفان';
                else if (thousands <= 10) result += units[thousands] + ' آلاف ';
                else result += numberToArabicWords(thousands) + ' ألفاً ';
                num %= 1000;
                if (num > 0) result += 'و ';
            }
            
            if (num >= 100) {
                const hundred = Math.floor(num / 100);
                result += hundreds[hundred] + ' ';
                num %= 100;
                if (num > 0) result += 'و ';
            }
            
            if (num > 0) {
                if (num <= 10) {
                    result += units[num];
                } else if (num < 20) {
                    result += units[num % 10] + ' عشر';
                } else {
                    const ten = Math.floor(num / 10);
                    const unit = num % 10;
                    if (unit > 0) {
                        result += units[unit] + ' و ' + tens[ten];
                    } else {
                        result += tens[ten];
                    }
                }
            }
            
            return result.trim() + " دينار عراقي";
        }

        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                const modal = document.getElementById('modal');
                if (!modal.classList.contains('hidden')) {
                    closeModal();
                }
            }
        });
		
		// ==================== دوال الفرز والبحث المتقدم ====================
        let hrSortState = { column: null, direction: 'asc' };
        let hrFiltersState = {};

        function sortHRData(key) {
            if (hrSortState.column === key) {
                hrSortState.direction = hrSortState.direction === 'asc' ? 'desc' : 'asc';
            } else {
                hrSortState.column = key;
                hrSortState.direction = 'asc';
            }

            document.querySelectorAll('.sort-icon').forEach(icon => icon.className = 'fas fa-sort sort-icon');
            const activeIcon = document.getElementById(`sort-${key}`);
            if (activeIcon) {
                activeIcon.className = `fas fa-sort-${hrSortState.direction === 'asc' ? 'up' : 'down'} sort-icon text-blue-400`;
            }

            applyFiltersAndSort();
        }

        function filterHRData(input, key) {
            hrFiltersState[key] = input.value.toLowerCase().trim();
            state.pg = 1;
            applyFiltersAndSort();
        }

        function applyFiltersAndSort() {
            let result = [...state.allData];

            Object.keys(hrFiltersState).forEach(key => {
                const term = hrFiltersState[key];
                if (term) {
                    result = result.filter(item => {
                        const val = String(item[key] || '').toLowerCase();
                        return val.includes(term);
                    });
                }
            });

            if (hrSortState.column) {
                const col = hrSortState.column;
                const dir = hrSortState.direction === 'asc' ? 1 : -1;
                
                result.sort((a, b) => {
                    let valA = a[col] || '';
                    let valB = b[col] || '';

                    if (col === 'amount') {
                        valA = parseFloat(valA) || 0;
                        valB = parseFloat(valB) || 0;
                    }
                    else if (col.includes('date') || col.includes('At')) {
                        valA = new Date(valA).getTime() || 0;
                        valB = new Date(valB).getTime() || 0;
                    } 
                    else {
                        valA = String(valA).toLowerCase();
                        valB = String(valB).toLowerCase();
                    }

                    if (valA < valB) return -1 * dir;
                    if (valA > valB) return 1 * dir;
                    return 0;
                });
            }

            state.filteredData = result;
            renderHRTableFiltered();
        }

        function renderHRTableFiltered() {
            const tbody = document.getElementById('hrBody');
            const total = state.filteredData.length;
            const totalPages = Math.ceil(total / state.lim) || 1;
            
            if (state.pg > totalPages) state.pg = totalPages;
            if (state.pg < 1) state.pg = 1;
            
            const start = (state.pg - 1) * state.lim;
            const end = start + state.lim;
            const pageData = state.filteredData.slice(start, end);

            // تحديد عدد الأعمدة للعرض الفارغ
            const colSpan = state.currentTab === 'mon' ? 10 : 10;

            if (total === 0) {
                tbody.innerHTML = `<tr><td colspan="${colSpan}" class="empty-state">لا توجد نتائج مطابقة</td></tr>`;
                document.getElementById('pageInfo').textContent = `0 من 0`;
                document.getElementById('totalRecs').textContent = `(0)`;
                return;
            }

            let html = '';
            pageData.forEach(item => {
                if (state.currentTab === 'obj') {
                    html += renderObjectionRowNew(item);
                } else if (state.currentTab === 'mon') {
                    html += renderMonitoringRowNew(item);
                }
            });
            tbody.innerHTML = html;

            document.getElementById('pageInfo').textContent = `صفحة ${state.pg} من ${totalPages}`;
            document.getElementById('totalRecs').textContent = `(العدد: ${total})`;
        }
		
		function renderMonitoringRowNew(item) {
            const typeClass = item.type?.includes('غرامة') ? 'ty-fine' : 
                              item.type?.includes('مكافأة') ? 'ty-bonus' : 
                              item.type?.includes('نسبة') ? 'ty-ratio' : 'ty-reduction';
            
            // حالة المتابعة
            const isDone = item.isFollowed === 'نعم';
            const statusBadge = isDone 
                ? `<span class="status-badge st-accepted"><i class="fas fa-check"></i> تم</span>` 
                : `<span class="status-badge st-pending">معلق</span>`;
            
            const rowBg = isDone ? 'bg-blue-50/40' : 'hover:bg-slate-50';
            const checkboxStatus = isDone ? 'checked disabled' : '';

            // === إنشاء بادج التكرار ===
            // يظهر فقط إذا كان هناك رقم تكرار، وإلا تظهر شرطة
            let repetitionDisplay = '<span class="text-slate-300">-</span>';
            
            if (item.repetition && item.repetition > 0) {
                // تلوين التكرار حسب الرقم
                let badgeClass = 'bg-slate-100 text-slate-600 border-slate-200'; // افتراضي (1)
                
                if (item.repetition === 2) {
                    badgeClass = 'bg-[#fef3c7] text-[#92400e] border-[#fcd34d]'; // أصفر (كما في الصورة القديمة)
                } else if (item.repetition >= 3) {
                    badgeClass = 'bg-[#fee2e2] text-[#991b1b] border-[#fca5a5]'; // أحمر (خطر)
                }

                repetitionDisplay = `
                    <span class="inline-block px-3 py-1 rounded text-xs font-bold border shadow-sm ${badgeClass}">
                        تكرار: ${item.repetition}
                    </span>
                `;
            }

            return `
                <tr class="${rowBg} transition-colors text-sm border-b">
                    <td class="text-center align-middle">
                        <input type="checkbox" class="followup-checkbox cursor-pointer" 
                               data-id="${item.id}" 
                               data-sheet="${item.sheetType}"
                               onchange="toggleFollowupSelection(this)"
                               ${checkboxStatus}>
                    </td>
                    
                    <td class="text-right align-middle">
                        <div class="font-bold text-slate-800 whitespace-normal break-words">${item.name}</div>
                        <div class="text-xs text-slate-500 font-mono">${item.fp}</div>
                    </td>
                    
                    <td class="text-center align-middle text-xs font-semibold text-slate-600 whitespace-normal">${item.section || '-'}</td>
                    
                    <td class="text-center align-middle"><span class="type-badge ${typeClass}">${item.type}</span></td>
                    
                    <td class="font-bold text-slate-700 text-center align-middle" dir="ltr">${Number(item.amount).toLocaleString()}</td>
                    
                    <td class="text-center align-middle">
                        ${repetitionDisplay}
                    </td>
                    
                    <td class="text-right align-middle max-w-[250px]">
                        <div class="whitespace-normal break-words text-slate-800 font-medium leading-relaxed">
                            ${item.reason}
                        </div>
                        ${item.speClass ? `<div class="text-[11px] text-blue-600 mt-1 whitespace-normal bg-blue-50 px-2 py-0.5 rounded inline-block border border-blue-100">${item.speClass}</div>` : ''}
                    </td>
                    
                    <td class="text-center align-middle text-xs text-blue-600 font-medium whitespace-normal w-24">${item.addedBy}</td>
                    
                    <td class="text-center align-middle text-xs font-mono whitespace-nowrap" dir="ltr">${item.addedAt}</td>
                    
                    <td class="text-center align-middle text-xs font-mono text-slate-500 whitespace-nowrap" dir="ltr">${item.dateStr}</td>
                    
                    <td class="text-center align-middle">${statusBadge}</td>
                    
                    <td class="text-center align-middle">
                        <div class="flex gap-1 justify-center">
                            <button onclick="editHRItem('${item.id}', '${item.sheetType}', '${item.type}', '${item.amount}', '${item.reason}', '${item.genClass}', '${item.speClass}')" 
                                    class="text-blue-600 hover:bg-blue-100 p-2 rounded transition" title="تعديل">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="deleteHRItem('${item.id}', '${item.sheetType}')" 
                                    class="text-red-600 hover:bg-red-100 p-2 rounded transition" title="حذف">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        }
		
		function renderObjectionRowNew(item) {
            const statusClass = item.objStatus === 'قيد المراجعة' ? 'st-pending' :
                              item.objStatus === 'مقبول' ? 'st-accepted' :
                              item.objStatus === 'مرفوض' ? 'st-rejected' : 'st-followup';
            
            const typeClass = item.type?.includes('غرامة') ? 'ty-fine' : 
                              item.type?.includes('مكافأة') ? 'ty-bonus' : 
                              item.type?.includes('نسبة') ? 'ty-ratio' : 'ty-reduction';

            let hasImage = '';
            if (item.objImg && item.objImg.length > 5) {
                hasImage = `<i class="fas fa-paperclip text-blue-500 cursor-pointer ml-2" onclick="viewObjectionImage('${item.id}', '${item.sheetType}')" title="عرض المرفق"></i>`;
            }

            return `
                <tr class="hover:bg-slate-50 transition-colors text-sm">
                    <td class="font-bold text-right">${item.name} <div class="text-xs text-slate-400">${item.fp}</div></td>
                    <td><span class="type-badge ${typeClass}">${item.type}</span></td>
                    <td class="font-bold text-slate-700">${Number(item.amount).toLocaleString()}</td>
                    <td class="text-xs text-blue-600 font-semibold">${item.addedBy}</td>
                    <td class="text-xs font-mono" dir="ltr">${item.addedAt}</td>
                    <td class="text-xs font-mono text-slate-500" dir="ltr">${item.dateStr}</td>
                    
                    <td class="text-right max-w-[300px]">
                       <div class="whitespace-normal break-words text-slate-800 leading-relaxed" title="${item.objReason}">
                           ${item.objReason} ${hasImage}
                       </div>
                       <div class="text-[10px] text-slate-400 mt-1 truncate" title="${item.reason}">أصل: ${item.reason}</div>
                    </td>
                    
                    <td><span class="status-badge ${statusClass}">${item.objStatus}</span></td>
                    <td class="text-xs font-mono bg-yellow-50 p-2 text-center" dir="ltr">${item.objDate}</td>
                    <td>
                        <button onclick="hrAction('${item.id}', '${item.sheetType}')" class="btn btn-primary btn-small py-1 px-3">
                            قرار
                        </button>
                    </td>
                </tr>
            `;
        }
    </script>
</body>
</html>

